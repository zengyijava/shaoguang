-----------V7.00-V7.01 START------------------------
/*网关升级脚本   START*/
MERGE INTO  A_GWPARAMCONF A USING (SELECT 'LOADTMPLTIMEINTERVAL' AS "PARAMITEM",4000 AS "GWTYPE" FROM  DUAL) B ON (A.PARAMITEM=B.PARAMITEM AND A.GWTYPE=B.GWTYPE)
WHEN NOT MATCHED THEN 
INSERT (PARAMITEM, PARAMNAME,  PARAMMEMO,PARAMATTRIBUTE, VALUERANGE,
DEFAULTVALUE,  CONTROLTYPE, GWTYPE,HKPARAMNAME,HKPARAMMEMO,ENPARAMNAME,ENPARAMMEMO)
VALUES('LOADTMPLTIMEINTERVAL', '加载模板时间间隔',  '从模板表中加载模板到内存中的时间间隔(单位:秒，默认30秒)',
1, '10-3600','30',0,4000,'加d模板rgg隔','哪０灞碇屑虞d模板到却嬷械rgg隔(挝:秒，默J30秒)',
'Load template interval','The time interval for loading a template from the template table into memory (unit: second, default 30 seconds)');


INSERT INTO A_GWPARAMVALUE(GWNO, GWTYPE, PARAMITEM, PARAMVALUE)
SELECT DISTINCT GWNO,4000,'LOADTMPLTIMEINTERVAL','30' FROM A_GWPARAMVALUE 
WHERE  NOT EXISTS(SELECT * FROM A_GWPARAMVALUE WHERE PARAMITEM='LOADTMPLTIMEINTERVAL'  AND  GWTYPE=4000) AND  GWTYPE=4000;

commit;
/

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_TASK_C' AND COLUMN_NAME='MESSAGE';
IF I=1 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_TASK_C MODIFY (MESSAGE VARCHAR2(4000))';
END IF;
END;
/

-- (1)表 GW_MT_TASK_BAK 添加字段
DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='GW_MT_TASK_BAK' AND COLUMN_NAME='LONGMSG';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE GW_MT_TASK_BAK ADD LONGMSG VARCHAR2(4000) DEFAULT ('' '') NOT NULL';
END IF;
END;
/   

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='GW_MT_TASK_BAK' AND COLUMN_NAME='TMPLID';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE GW_MT_TASK_BAK ADD TMPLID NUMBER(22) DEFAULT 0 NOT NULL';
END IF;
END;
/        

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='GW_MT_TASK_BAK' AND COLUMN_NAME='CHGRADE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE GW_MT_TASK_BAK ADD CHGRADE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/  

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='GW_MT_TASK_BAK' AND COLUMN_NAME='MSGTYPE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE GW_MT_TASK_BAK ADD MSGTYPE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/  

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='GW_MT_TASK_BAK' AND COLUMN_NAME='ERRORCODE2';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE GW_MT_TASK_BAK ADD ERRORCODE2 CHAR(7) DEFAULT ('' '') NOT NULL';
END IF;
END;
/     

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='GW_MT_TASK_BAK' AND COLUMN_NAME='DOWNTM';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE GW_MT_TASK_BAK ADD DOWNTM TIMESTAMP(6) DEFAULT SYSTIMESTAMP NOT NULL';
END IF;
END;
/  

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='GW_MT_TASK_BAK' AND COLUMN_NAME='RMSVALIDTM';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE GW_MT_TASK_BAK ADD RMSVALIDTM NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='GW_MT_TASK_BAK' AND COLUMN_NAME='RMSRPTFLAG';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE GW_MT_TASK_BAK ADD RMSRPTFLAG NUMBER(11) DEFAULT 1 NOT NULL';
END IF;
END;
/     

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='GW_MT_TASK_BAK' AND COLUMN_NAME='PROTOCOLVER';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE GW_MT_TASK_BAK ADD PROTOCOLVER NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='GW_MT_TASK_BAK' AND COLUMN_NAME='TMPLTYPE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE GW_MT_TASK_BAK ADD TMPLTYPE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='GW_MT_TASK_BAK' AND COLUMN_NAME='TITLE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE GW_MT_TASK_BAK ADD TITLE VARCHAR2(40) DEFAULT ('' '') NOT NULL';
END IF;
END;
/   

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='GW_MT_TASK_BAK' AND COLUMN_NAME='SHOWAY';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE GW_MT_TASK_BAK ADD SHOWAY VARCHAR2(16) DEFAULT ('' '') NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='GW_MT_TASK_BAK' AND COLUMN_NAME='DLDWAY';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE GW_MT_TASK_BAK ADD DLDWAY NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='GW_MT_TASK_BAK' AND COLUMN_NAME='DLDNEY';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE GW_MT_TASK_BAK ADD DLDNEY NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='GW_MT_TASK_BAK' AND COLUMN_NAME='ISFREE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE GW_MT_TASK_BAK ADD ISFREE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='GW_MT_TASK_BAK' AND COLUMN_NAME='SHOWTIME';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE GW_MT_TASK_BAK ADD SHOWTIME NUMBER(22) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

-- (2)表 MT_LEVEL0_QUEUE 添加字段
DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL0_QUEUE' AND COLUMN_NAME='LONGMSG';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL0_QUEUE ADD LONGMSG VARCHAR2(4000) DEFAULT ('' '') NOT NULL';
END IF;
END;
/   

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL0_QUEUE' AND COLUMN_NAME='TMPLID';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL0_QUEUE ADD TMPLID NUMBER(22) DEFAULT 0 NOT NULL';
END IF;
END;
/        

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL0_QUEUE' AND COLUMN_NAME='CHGRADE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL0_QUEUE ADD CHGRADE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/  

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL0_QUEUE' AND COLUMN_NAME='MSGTYPE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL0_QUEUE ADD MSGTYPE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/  

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL0_QUEUE' AND COLUMN_NAME='RMSVALIDTM';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL0_QUEUE ADD RMSVALIDTM NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/    

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL0_QUEUE' AND COLUMN_NAME='PROTOCOLVER';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL0_QUEUE ADD PROTOCOLVER NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL0_QUEUE' AND COLUMN_NAME='TMPLTYPE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL0_QUEUE ADD TMPLTYPE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL0_QUEUE' AND COLUMN_NAME='TITLE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL0_QUEUE ADD TITLE VARCHAR2(40) DEFAULT ('' '') NOT NULL';
END IF;
END;
/   

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL0_QUEUE' AND COLUMN_NAME='SHOWAY';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL0_QUEUE ADD SHOWAY VARCHAR2(16) DEFAULT ('' '') NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL0_QUEUE' AND COLUMN_NAME='DLDWAY';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL0_QUEUE ADD DLDWAY NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL0_QUEUE' AND COLUMN_NAME='DLDNEY';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL0_QUEUE ADD DLDNEY NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL0_QUEUE' AND COLUMN_NAME='ISFREE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL0_QUEUE ADD ISFREE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL0_QUEUE' AND COLUMN_NAME='SHOWTIME';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL0_QUEUE ADD SHOWTIME NUMBER(22) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

-- (3)表 MT_LEVEL1_QUEUE 添加字段
DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL1_QUEUE' AND COLUMN_NAME='LONGMSG';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL1_QUEUE ADD LONGMSG VARCHAR2(4000) DEFAULT ('' '') NOT NULL';
END IF;
END;
/   

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL1_QUEUE' AND COLUMN_NAME='TMPLID';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL1_QUEUE ADD TMPLID NUMBER(22) DEFAULT 0 NOT NULL';
END IF;
END;
/        

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL1_QUEUE' AND COLUMN_NAME='CHGRADE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL1_QUEUE ADD CHGRADE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/  

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL1_QUEUE' AND COLUMN_NAME='MSGTYPE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL1_QUEUE ADD MSGTYPE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/  

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL1_QUEUE' AND COLUMN_NAME='RMSVALIDTM';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL1_QUEUE ADD RMSVALIDTM NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/    

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL1_QUEUE' AND COLUMN_NAME='PROTOCOLVER';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL1_QUEUE ADD PROTOCOLVER NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL1_QUEUE' AND COLUMN_NAME='TMPLTYPE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL1_QUEUE ADD TMPLTYPE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL1_QUEUE' AND COLUMN_NAME='TITLE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL1_QUEUE ADD TITLE VARCHAR2(40) DEFAULT ('' '') NOT NULL';
END IF;
END;
/   

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL1_QUEUE' AND COLUMN_NAME='SHOWAY';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL1_QUEUE ADD SHOWAY VARCHAR2(16) DEFAULT ('' '') NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL1_QUEUE' AND COLUMN_NAME='DLDWAY';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL1_QUEUE ADD DLDWAY NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL1_QUEUE' AND COLUMN_NAME='DLDNEY';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL1_QUEUE ADD DLDNEY NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL1_QUEUE' AND COLUMN_NAME='ISFREE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL1_QUEUE ADD ISFREE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL1_QUEUE' AND COLUMN_NAME='SHOWTIME';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL1_QUEUE ADD SHOWTIME NUMBER(22) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

-- (4)表 MT_LEVEL2_QUEUE 添加字段
DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL2_QUEUE' AND COLUMN_NAME='LONGMSG';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL2_QUEUE ADD LONGMSG VARCHAR2(4000) DEFAULT ('' '') NOT NULL';
END IF;
END;
/   

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL2_QUEUE' AND COLUMN_NAME='TMPLID';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL2_QUEUE ADD TMPLID NUMBER(22) DEFAULT 0 NOT NULL';
END IF;
END;
/        

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL2_QUEUE' AND COLUMN_NAME='CHGRADE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL2_QUEUE ADD CHGRADE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/  

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL2_QUEUE' AND COLUMN_NAME='MSGTYPE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL2_QUEUE ADD MSGTYPE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/  

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL2_QUEUE' AND COLUMN_NAME='RMSVALIDTM';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL2_QUEUE ADD RMSVALIDTM NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL2_QUEUE' AND COLUMN_NAME='PROTOCOLVER';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL2_QUEUE ADD PROTOCOLVER NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL2_QUEUE' AND COLUMN_NAME='TMPLTYPE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL2_QUEUE ADD TMPLTYPE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL2_QUEUE' AND COLUMN_NAME='TITLE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL2_QUEUE ADD TITLE VARCHAR2(40) DEFAULT ('' '') NOT NULL';
END IF;
END;
/   

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL2_QUEUE' AND COLUMN_NAME='SHOWAY';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL2_QUEUE ADD SHOWAY VARCHAR2(16) DEFAULT ('' '') NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL2_QUEUE' AND COLUMN_NAME='DLDWAY';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL2_QUEUE ADD DLDWAY NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL2_QUEUE' AND COLUMN_NAME='DLDNEY';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL2_QUEUE ADD DLDNEY NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL2_QUEUE' AND COLUMN_NAME='ISFREE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL2_QUEUE ADD ISFREE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL2_QUEUE' AND COLUMN_NAME='SHOWTIME';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL2_QUEUE ADD SHOWTIME NUMBER(22) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

-- (5)表 MT_LEVEL3_QUEUE 添加字段
DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL3_QUEUE' AND COLUMN_NAME='LONGMSG';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL3_QUEUE ADD LONGMSG VARCHAR2(4000) DEFAULT ('' '') NOT NULL';
END IF;
END;
/   

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL3_QUEUE' AND COLUMN_NAME='TMPLID';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL3_QUEUE ADD TMPLID NUMBER(22) DEFAULT 0 NOT NULL';
END IF;
END;
/        

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL3_QUEUE' AND COLUMN_NAME='CHGRADE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL3_QUEUE ADD CHGRADE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/  

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL3_QUEUE' AND COLUMN_NAME='MSGTYPE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL3_QUEUE ADD MSGTYPE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/  

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL3_QUEUE' AND COLUMN_NAME='RMSVALIDTM';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL3_QUEUE ADD RMSVALIDTM NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL3_QUEUE' AND COLUMN_NAME='PROTOCOLVER';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL3_QUEUE ADD PROTOCOLVER NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL3_QUEUE' AND COLUMN_NAME='TMPLTYPE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL3_QUEUE ADD TMPLTYPE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL3_QUEUE' AND COLUMN_NAME='TITLE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL3_QUEUE ADD TITLE VARCHAR2(40) DEFAULT ('' '') NOT NULL';
END IF;
END;
/   

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL3_QUEUE' AND COLUMN_NAME='SHOWAY';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL3_QUEUE ADD SHOWAY VARCHAR2(16) DEFAULT ('' '') NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL3_QUEUE' AND COLUMN_NAME='DLDWAY';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL3_QUEUE ADD DLDWAY NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL3_QUEUE' AND COLUMN_NAME='DLDNEY';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL3_QUEUE ADD DLDNEY NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL3_QUEUE' AND COLUMN_NAME='ISFREE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL3_QUEUE ADD ISFREE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL3_QUEUE' AND COLUMN_NAME='SHOWTIME';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL3_QUEUE ADD SHOWTIME NUMBER(22) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

-- (6)表 MT_LEVEL4_QUEUE 添加字段
DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL4_QUEUE' AND COLUMN_NAME='LONGMSG';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL4_QUEUE ADD LONGMSG VARCHAR2(4000) DEFAULT ('' '') NOT NULL';
END IF;
END;
/   

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL4_QUEUE' AND COLUMN_NAME='TMPLID';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL4_QUEUE ADD TMPLID NUMBER(22) DEFAULT 0 NOT NULL';
END IF;
END;
/        

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL4_QUEUE' AND COLUMN_NAME='CHGRADE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL4_QUEUE ADD CHGRADE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/  

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL4_QUEUE' AND COLUMN_NAME='MSGTYPE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL4_QUEUE ADD MSGTYPE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/  

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL4_QUEUE' AND COLUMN_NAME='RMSVALIDTM';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL4_QUEUE ADD RMSVALIDTM NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL4_QUEUE' AND COLUMN_NAME='PROTOCOLVER';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL4_QUEUE ADD PROTOCOLVER NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL4_QUEUE' AND COLUMN_NAME='TMPLTYPE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL4_QUEUE ADD TMPLTYPE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL4_QUEUE' AND COLUMN_NAME='TITLE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL4_QUEUE ADD TITLE VARCHAR2(40) DEFAULT ('' '') NOT NULL';
END IF;
END;
/   

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL4_QUEUE' AND COLUMN_NAME='SHOWAY';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL4_QUEUE ADD SHOWAY VARCHAR2(16) DEFAULT ('' '') NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL4_QUEUE' AND COLUMN_NAME='DLDWAY';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL4_QUEUE ADD DLDWAY NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL4_QUEUE' AND COLUMN_NAME='DLDNEY';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL4_QUEUE ADD DLDNEY NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL4_QUEUE' AND COLUMN_NAME='ISFREE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL4_QUEUE ADD ISFREE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL4_QUEUE' AND COLUMN_NAME='SHOWTIME';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL4_QUEUE ADD SHOWTIME NUMBER(22) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

-- (7)表 MT_LEVEL5_QUEUE 添加字段
DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL5_QUEUE' AND COLUMN_NAME='LONGMSG';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL5_QUEUE ADD LONGMSG VARCHAR2(4000) DEFAULT ('' '') NOT NULL';
END IF;
END;
/   

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL5_QUEUE' AND COLUMN_NAME='TMPLID';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL5_QUEUE ADD TMPLID NUMBER(22) DEFAULT 0 NOT NULL';
END IF;
END;
/        

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL5_QUEUE' AND COLUMN_NAME='CHGRADE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL5_QUEUE ADD CHGRADE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/  

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL5_QUEUE' AND COLUMN_NAME='MSGTYPE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL5_QUEUE ADD MSGTYPE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/  

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL5_QUEUE' AND COLUMN_NAME='RMSVALIDTM';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL5_QUEUE ADD RMSVALIDTM NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL5_QUEUE' AND COLUMN_NAME='PROTOCOLVER';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL5_QUEUE ADD PROTOCOLVER NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL5_QUEUE' AND COLUMN_NAME='TMPLTYPE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL5_QUEUE ADD TMPLTYPE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL5_QUEUE' AND COLUMN_NAME='TITLE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL5_QUEUE ADD TITLE VARCHAR2(40) DEFAULT ('' '') NOT NULL';
END IF;
END;
/   

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL5_QUEUE' AND COLUMN_NAME='SHOWAY';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL5_QUEUE ADD SHOWAY VARCHAR2(16) DEFAULT ('' '') NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL5_QUEUE' AND COLUMN_NAME='DLDWAY';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL5_QUEUE ADD DLDWAY NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL5_QUEUE' AND COLUMN_NAME='DLDNEY';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL5_QUEUE ADD DLDNEY NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL5_QUEUE' AND COLUMN_NAME='ISFREE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL5_QUEUE ADD ISFREE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL5_QUEUE' AND COLUMN_NAME='SHOWTIME';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL5_QUEUE ADD SHOWTIME NUMBER(22) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

-- (8)表 MT_LEVEL6_QUEUE 添加字段
DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL6_QUEUE' AND COLUMN_NAME='LONGMSG';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL6_QUEUE ADD LONGMSG VARCHAR2(4000) DEFAULT ('' '') NOT NULL';
END IF;
END;
/   

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL6_QUEUE' AND COLUMN_NAME='TMPLID';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL6_QUEUE ADD TMPLID NUMBER(22) DEFAULT 0 NOT NULL';
END IF;
END;
/        

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL6_QUEUE' AND COLUMN_NAME='CHGRADE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL6_QUEUE ADD CHGRADE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/  

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL6_QUEUE' AND COLUMN_NAME='MSGTYPE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL6_QUEUE ADD MSGTYPE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/  

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL6_QUEUE' AND COLUMN_NAME='RMSVALIDTM';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL6_QUEUE ADD RMSVALIDTM NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL6_QUEUE' AND COLUMN_NAME='PROTOCOLVER';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL6_QUEUE ADD PROTOCOLVER NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL6_QUEUE' AND COLUMN_NAME='TMPLTYPE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL6_QUEUE ADD TMPLTYPE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL6_QUEUE' AND COLUMN_NAME='TITLE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL6_QUEUE ADD TITLE VARCHAR2(40) DEFAULT ('' '') NOT NULL';
END IF;
END;
/   

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL6_QUEUE' AND COLUMN_NAME='SHOWAY';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL6_QUEUE ADD SHOWAY VARCHAR2(16) DEFAULT ('' '') NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL6_QUEUE' AND COLUMN_NAME='DLDWAY';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL6_QUEUE ADD DLDWAY NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL6_QUEUE' AND COLUMN_NAME='DLDNEY';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL6_QUEUE ADD DLDNEY NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL6_QUEUE' AND COLUMN_NAME='ISFREE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL6_QUEUE ADD ISFREE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL6_QUEUE' AND COLUMN_NAME='SHOWTIME';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL6_QUEUE ADD SHOWTIME NUMBER(22) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

-- (9)表 MT_LEVEL7_QUEUE 添加字段
DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL7_QUEUE' AND COLUMN_NAME='LONGMSG';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL7_QUEUE ADD LONGMSG VARCHAR2(4000) DEFAULT ('' '') NOT NULL';
END IF;
END;
/   

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL7_QUEUE' AND COLUMN_NAME='TMPLID';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL7_QUEUE ADD TMPLID NUMBER(22) DEFAULT 0 NOT NULL';
END IF;
END;
/        

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL7_QUEUE' AND COLUMN_NAME='CHGRADE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL7_QUEUE ADD CHGRADE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/  

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL7_QUEUE' AND COLUMN_NAME='MSGTYPE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL7_QUEUE ADD MSGTYPE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/  

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL7_QUEUE' AND COLUMN_NAME='RMSVALIDTM';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL7_QUEUE ADD RMSVALIDTM NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL7_QUEUE' AND COLUMN_NAME='PROTOCOLVER';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL7_QUEUE ADD PROTOCOLVER NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL7_QUEUE' AND COLUMN_NAME='TMPLTYPE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL7_QUEUE ADD TMPLTYPE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL7_QUEUE' AND COLUMN_NAME='TITLE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL7_QUEUE ADD TITLE VARCHAR2(40) DEFAULT ('' '') NOT NULL';
END IF;
END;
/   

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL7_QUEUE' AND COLUMN_NAME='SHOWAY';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL7_QUEUE ADD SHOWAY VARCHAR2(16) DEFAULT ('' '') NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL7_QUEUE' AND COLUMN_NAME='DLDWAY';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL7_QUEUE ADD DLDWAY NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL7_QUEUE' AND COLUMN_NAME='DLDNEY';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL7_QUEUE ADD DLDNEY NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL7_QUEUE' AND COLUMN_NAME='ISFREE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL7_QUEUE ADD ISFREE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL7_QUEUE' AND COLUMN_NAME='SHOWTIME';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL7_QUEUE ADD SHOWTIME NUMBER(22) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

-- (10)表 MT_LEVEL8_QUEUE 添加字段
DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL8_QUEUE' AND COLUMN_NAME='LONGMSG';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL8_QUEUE ADD LONGMSG VARCHAR2(4000) DEFAULT ('' '') NOT NULL';
END IF;
END;
/   

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL8_QUEUE' AND COLUMN_NAME='TMPLID';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL8_QUEUE ADD TMPLID NUMBER(22) DEFAULT 0 NOT NULL';
END IF;
END;
/        

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL8_QUEUE' AND COLUMN_NAME='CHGRADE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL8_QUEUE ADD CHGRADE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/  

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL8_QUEUE' AND COLUMN_NAME='MSGTYPE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL8_QUEUE ADD MSGTYPE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/  

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL8_QUEUE' AND COLUMN_NAME='RMSVALIDTM';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL8_QUEUE ADD RMSVALIDTM NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL8_QUEUE' AND COLUMN_NAME='PROTOCOLVER';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL8_QUEUE ADD PROTOCOLVER NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL8_QUEUE' AND COLUMN_NAME='TMPLTYPE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL8_QUEUE ADD TMPLTYPE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL8_QUEUE' AND COLUMN_NAME='TITLE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL8_QUEUE ADD TITLE VARCHAR2(40) DEFAULT ('' '') NOT NULL';
END IF;
END;
/   

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL8_QUEUE' AND COLUMN_NAME='SHOWAY';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL8_QUEUE ADD SHOWAY VARCHAR2(16) DEFAULT ('' '') NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL8_QUEUE' AND COLUMN_NAME='DLDWAY';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL8_QUEUE ADD DLDWAY NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL8_QUEUE' AND COLUMN_NAME='DLDNEY';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL8_QUEUE ADD DLDNEY NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL8_QUEUE' AND COLUMN_NAME='ISFREE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL8_QUEUE ADD ISFREE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL8_QUEUE' AND COLUMN_NAME='SHOWTIME';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL8_QUEUE ADD SHOWTIME NUMBER(22) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

-- (11)表 MT_LEVEL9_QUEUE 添加字段
DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL9_QUEUE' AND COLUMN_NAME='LONGMSG';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL9_QUEUE ADD LONGMSG VARCHAR2(4000) DEFAULT ('' '') NOT NULL';
END IF;
END;
/   

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL9_QUEUE' AND COLUMN_NAME='TMPLID';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL9_QUEUE ADD TMPLID NUMBER(22) DEFAULT 0 NOT NULL';
END IF;
END;
/        

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL9_QUEUE' AND COLUMN_NAME='CHGRADE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL9_QUEUE ADD CHGRADE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/  

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL9_QUEUE' AND COLUMN_NAME='MSGTYPE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL9_QUEUE ADD MSGTYPE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/  

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL9_QUEUE' AND COLUMN_NAME='RMSVALIDTM';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL9_QUEUE ADD RMSVALIDTM NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL9_QUEUE' AND COLUMN_NAME='PROTOCOLVER';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL9_QUEUE ADD PROTOCOLVER NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL9_QUEUE' AND COLUMN_NAME='TMPLTYPE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL9_QUEUE ADD TMPLTYPE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL9_QUEUE' AND COLUMN_NAME='TITLE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL9_QUEUE ADD TITLE VARCHAR2(40) DEFAULT ('' '') NOT NULL';
END IF;
END;
/   

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL9_QUEUE' AND COLUMN_NAME='SHOWAY';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL9_QUEUE ADD SHOWAY VARCHAR2(16) DEFAULT ('' '') NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL9_QUEUE' AND COLUMN_NAME='DLDWAY';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL9_QUEUE ADD DLDWAY NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL9_QUEUE' AND COLUMN_NAME='DLDNEY';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL9_QUEUE ADD DLDNEY NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL9_QUEUE' AND COLUMN_NAME='ISFREE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL9_QUEUE ADD ISFREE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_LEVEL9_QUEUE' AND COLUMN_NAME='SHOWTIME';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_LEVEL9_QUEUE ADD SHOWTIME NUMBER(22) DEFAULT 0 NOT NULL';
END IF;
END;
/ 

--（12）当月历史表添加字段不加默认值
DECLARE 
PITABLENAME VARCHAR2(20);
PITABLE VARCHAR2(20);
PISTR VARCHAR2(256);
PICNT NUMBER(11);
V_SQL VARCHAR2(256);
CUR_TABLE SYS_REFCURSOR;
BEGIN
PITABLENAME :='MTTASK'|| TO_CHAR(add_months(sysdate,-0),'YYYYMM');
V_SQL:='SELECT TABLE_NAME FROM USER_TABLES T WHERE T.TABLE_NAME LIKE ''MTTASK%'' AND T.TABLE_NAME ='''||PITABLENAME||'''';
  OPEN CUR_TABLE FOR V_SQL ;  
  LOOP  
      FETCH CUR_TABLE INTO PITABLE;   
      EXIT WHEN CUR_TABLE%NOTFOUND; 
      
      SELECT COUNT (*) INTO PICNT FROM USER_TAB_COLUMNS WHERE TABLE_NAME = PITABLE AND COLUMN_NAME = 'LONGMSG';
      IF PICNT=0 THEN
      PISTR:='ALTER TABLE '||PITABLE||' ADD LONGMSG VARCHAR2(4000) ';  
      EXECUTE IMMEDIATE PISTR;
      END IF;
      
      SELECT COUNT (*) INTO PICNT FROM USER_TAB_COLUMNS WHERE TABLE_NAME = PITABLE AND COLUMN_NAME = 'TMPLID';
      IF PICNT=0 THEN
      PISTR:='ALTER TABLE '||PITABLE||' ADD TMPLID NUMBER(22) ';  
      EXECUTE IMMEDIATE PISTR;
      END IF;
	  
	  SELECT COUNT (*) INTO PICNT FROM USER_TAB_COLUMNS WHERE TABLE_NAME = PITABLE AND COLUMN_NAME = 'CHGRADE';
      IF PICNT=0 THEN
      PISTR:='ALTER TABLE '||PITABLE||' ADD CHGRADE NUMBER(11) ';  
      EXECUTE IMMEDIATE PISTR;
      END IF;
	  
	  SELECT COUNT (*) INTO PICNT FROM USER_TAB_COLUMNS WHERE TABLE_NAME = PITABLE AND COLUMN_NAME = 'MSGTYPE';
      IF PICNT=0 THEN
      PISTR:='ALTER TABLE '||PITABLE||' ADD MSGTYPE NUMBER(11) ';  
      EXECUTE IMMEDIATE PISTR;
      END IF;
	  
	  SELECT COUNT (*) INTO PICNT FROM USER_TAB_COLUMNS WHERE TABLE_NAME = PITABLE AND COLUMN_NAME = 'ERRORCODE2';
      IF PICNT=0 THEN
      PISTR:='ALTER TABLE '||PITABLE||' ADD ERRORCODE2 CHAR(7) ';  
      EXECUTE IMMEDIATE PISTR;
      END IF;
	  
	  SELECT COUNT (*) INTO PICNT FROM USER_TAB_COLUMNS WHERE TABLE_NAME = PITABLE AND COLUMN_NAME = 'DOWNTM';
      IF PICNT=0 THEN
      PISTR:='ALTER TABLE '||PITABLE||' ADD DOWNTM TIMESTAMP(6) ';  
      EXECUTE IMMEDIATE PISTR;
      END IF;
	  
	  SELECT COUNT (*) INTO PICNT FROM USER_TAB_COLUMNS WHERE TABLE_NAME = PITABLE AND COLUMN_NAME = 'RMSVALIDTM';
      IF PICNT=0 THEN
      PISTR:='ALTER TABLE '||PITABLE||' ADD RMSVALIDTM NUMBER(11) ';  
      EXECUTE IMMEDIATE PISTR;
      END IF;
	  
	  SELECT COUNT (*) INTO PICNT FROM USER_TAB_COLUMNS WHERE TABLE_NAME = PITABLE AND COLUMN_NAME = 'RMSRPTFLAG';
      IF PICNT=0 THEN
      PISTR:='ALTER TABLE '||PITABLE||' ADD RMSRPTFLAG NUMBER(11) ';  
      EXECUTE IMMEDIATE PISTR;
      END IF;
	  
	  SELECT COUNT (*) INTO PICNT FROM USER_TAB_COLUMNS WHERE TABLE_NAME = PITABLE AND COLUMN_NAME = 'PROTOCOLVER';
      IF PICNT=0 THEN
      PISTR:='ALTER TABLE '||PITABLE||' ADD PROTOCOLVER NUMBER(11) ';  
      EXECUTE IMMEDIATE PISTR;
      END IF;
	  
	  SELECT COUNT (*) INTO PICNT FROM USER_TAB_COLUMNS WHERE TABLE_NAME = PITABLE AND COLUMN_NAME = 'TMPLTYPE';
      IF PICNT=0 THEN
      PISTR:='ALTER TABLE '||PITABLE||' ADD TMPLTYPE NUMBER(11) ';  
      EXECUTE IMMEDIATE PISTR;
      END IF;
	  
	  SELECT COUNT (*) INTO PICNT FROM USER_TAB_COLUMNS WHERE TABLE_NAME = PITABLE AND COLUMN_NAME = 'TITLE';
      IF PICNT=0 THEN
      PISTR:='ALTER TABLE '||PITABLE||' ADD TITLE VARCHAR2(40) ';  
      EXECUTE IMMEDIATE PISTR;
      END IF;
	  
	  SELECT COUNT (*) INTO PICNT FROM USER_TAB_COLUMNS WHERE TABLE_NAME = PITABLE AND COLUMN_NAME = 'SHOWAY';
      IF PICNT=0 THEN
      PISTR:='ALTER TABLE '||PITABLE||' ADD SHOWAY VARCHAR2(16) ';  
      EXECUTE IMMEDIATE PISTR;
      END IF;
	  
	  SELECT COUNT (*) INTO PICNT FROM USER_TAB_COLUMNS WHERE TABLE_NAME = PITABLE AND COLUMN_NAME = 'DLDWAY';
      IF PICNT=0 THEN
      PISTR:='ALTER TABLE '||PITABLE||' ADD DLDWAY NUMBER(11) ';  
      EXECUTE IMMEDIATE PISTR;
      END IF;
	  
	  SELECT COUNT (*) INTO PICNT FROM USER_TAB_COLUMNS WHERE TABLE_NAME = PITABLE AND COLUMN_NAME = 'DLDNEY';
      IF PICNT=0 THEN
      PISTR:='ALTER TABLE '||PITABLE||' ADD DLDNEY NUMBER(11) ';  
      EXECUTE IMMEDIATE PISTR;
      END IF;
	  
	  SELECT COUNT (*) INTO PICNT FROM USER_TAB_COLUMNS WHERE TABLE_NAME = PITABLE AND COLUMN_NAME = 'ISFREE';
      IF PICNT=0 THEN
      PISTR:='ALTER TABLE '||PITABLE||' ADD ISFREE NUMBER(11) ';  
      EXECUTE IMMEDIATE PISTR;
      END IF;
	  
	  SELECT COUNT (*) INTO PICNT FROM USER_TAB_COLUMNS WHERE TABLE_NAME = PITABLE AND COLUMN_NAME = 'SHOWTIME';
      IF PICNT=0 THEN
      PISTR:='ALTER TABLE '||PITABLE||' ADD SHOWTIME NUMBER(22) ';  
      EXECUTE IMMEDIATE PISTR;
      END IF;
      
  END LOOP;  
  CLOSE CUR_TABLE;  
END; 
/

--（13）当月以后的历史表添加字段，字段有默认值
DECLARE 
PITABLENAME VARCHAR2(20);
PITABLE VARCHAR2(20);
PISTR VARCHAR2(256);
PICNT NUMBER(11);
V_SQL VARCHAR2(256);
CUR_TABLE SYS_REFCURSOR;
BEGIN
PITABLENAME :='MTTASK'|| TO_CHAR(add_months(sysdate,-1),'YYYYMM');
V_SQL:='SELECT TABLE_NAME FROM USER_TABLES T WHERE T.TABLE_NAME LIKE ''MTTASK%'' AND T.TABLE_NAME >'''||PITABLENAME||'''';
  OPEN CUR_TABLE FOR V_SQL ;  
  LOOP  
      FETCH CUR_TABLE INTO PITABLE;   
      EXIT WHEN CUR_TABLE%NOTFOUND; 
      
      SELECT COUNT (*) INTO PICNT FROM USER_TAB_COLUMNS WHERE TABLE_NAME = PITABLE AND COLUMN_NAME = 'LONGMSG';
      IF PICNT=0 THEN
      PISTR:='ALTER TABLE '||PITABLE||' ADD LONGMSG VARCHAR2(4000) DEFAULT ('' '') NOT NULL';  
      EXECUTE IMMEDIATE PISTR;
      END IF;
      
      SELECT COUNT (*) INTO PICNT FROM USER_TAB_COLUMNS WHERE TABLE_NAME = PITABLE AND COLUMN_NAME = 'TMPLID';
      IF PICNT=0 THEN
      PISTR:='ALTER TABLE '||PITABLE||' ADD TMPLID NUMBER(22) DEFAULT 0 NOT NULL';  
      EXECUTE IMMEDIATE PISTR;
      END IF;
	  
	  SELECT COUNT (*) INTO PICNT FROM USER_TAB_COLUMNS WHERE TABLE_NAME = PITABLE AND COLUMN_NAME = 'CHGRADE';
      IF PICNT=0 THEN
      PISTR:='ALTER TABLE '||PITABLE||' ADD CHGRADE NUMBER(11) DEFAULT 0 NOT NULL';  
      EXECUTE IMMEDIATE PISTR;
      END IF;
	  
	  SELECT COUNT (*) INTO PICNT FROM USER_TAB_COLUMNS WHERE TABLE_NAME = PITABLE AND COLUMN_NAME = 'MSGTYPE';
      IF PICNT=0 THEN
      PISTR:='ALTER TABLE '||PITABLE||' ADD MSGTYPE NUMBER(11) DEFAULT 0 NOT NULL';  
      EXECUTE IMMEDIATE PISTR;
      END IF;
	  
	  SELECT COUNT (*) INTO PICNT FROM USER_TAB_COLUMNS WHERE TABLE_NAME = PITABLE AND COLUMN_NAME = 'ERRORCODE2';
      IF PICNT=0 THEN
      PISTR:='ALTER TABLE '||PITABLE||' ADD ERRORCODE2 CHAR(7) DEFAULT ('' '') NOT NULL';  
      EXECUTE IMMEDIATE PISTR;
      END IF;
	  
	  SELECT COUNT (*) INTO PICNT FROM USER_TAB_COLUMNS WHERE TABLE_NAME = PITABLE AND COLUMN_NAME = 'DOWNTM';
      IF PICNT=0 THEN
      PISTR:='ALTER TABLE '||PITABLE||' ADD DOWNTM TIMESTAMP(6) DEFAULT SYSTIMESTAMP NOT NULL';  
      EXECUTE IMMEDIATE PISTR;
      END IF;
	  
	  SELECT COUNT (*) INTO PICNT FROM USER_TAB_COLUMNS WHERE TABLE_NAME = PITABLE AND COLUMN_NAME = 'RMSVALIDTM';
      IF PICNT=0 THEN
      PISTR:='ALTER TABLE '||PITABLE||' ADD RMSVALIDTM NUMBER(11) DEFAULT 0 NOT NULL';  
      EXECUTE IMMEDIATE PISTR;
      END IF;
	  
	  SELECT COUNT (*) INTO PICNT FROM USER_TAB_COLUMNS WHERE TABLE_NAME = PITABLE AND COLUMN_NAME = 'RMSRPTFLAG';
      IF PICNT=0 THEN
      PISTR:='ALTER TABLE '||PITABLE||' ADD RMSRPTFLAG NUMBER(11) DEFAULT 1 NOT NULL';  
      EXECUTE IMMEDIATE PISTR;
      END IF;
	  
	  SELECT COUNT (*) INTO PICNT FROM USER_TAB_COLUMNS WHERE TABLE_NAME = PITABLE AND COLUMN_NAME = 'PROTOCOLVER';
      IF PICNT=0 THEN
      PISTR:='ALTER TABLE '||PITABLE||' ADD PROTOCOLVER NUMBER(11) DEFAULT 0 NOT NULL';  
      EXECUTE IMMEDIATE PISTR;
      END IF;
	  
	  SELECT COUNT (*) INTO PICNT FROM USER_TAB_COLUMNS WHERE TABLE_NAME = PITABLE AND COLUMN_NAME = 'TMPLTYPE';
      IF PICNT=0 THEN
      PISTR:='ALTER TABLE '||PITABLE||' ADD TMPLTYPE NUMBER(11) DEFAULT 0 NOT NULL';  
      EXECUTE IMMEDIATE PISTR;
      END IF;
	  
	  SELECT COUNT (*) INTO PICNT FROM USER_TAB_COLUMNS WHERE TABLE_NAME = PITABLE AND COLUMN_NAME = 'TITLE';
      IF PICNT=0 THEN
      PISTR:='ALTER TABLE '||PITABLE||' ADD TITLE VARCHAR2(40) DEFAULT ('' '') NOT NULL';  
      EXECUTE IMMEDIATE PISTR;
      END IF;
	  
	  SELECT COUNT (*) INTO PICNT FROM USER_TAB_COLUMNS WHERE TABLE_NAME = PITABLE AND COLUMN_NAME = 'SHOWAY';
      IF PICNT=0 THEN
      PISTR:='ALTER TABLE '||PITABLE||' ADD SHOWAY VARCHAR2(16) DEFAULT ('' '') NOT NULL';  
      EXECUTE IMMEDIATE PISTR;
      END IF;
	  
	  SELECT COUNT (*) INTO PICNT FROM USER_TAB_COLUMNS WHERE TABLE_NAME = PITABLE AND COLUMN_NAME = 'DLDWAY';
      IF PICNT=0 THEN
      PISTR:='ALTER TABLE '||PITABLE||' ADD DLDWAY NUMBER(11) DEFAULT 0 NOT NULL';  
      EXECUTE IMMEDIATE PISTR;
      END IF;
	  
	  SELECT COUNT (*) INTO PICNT FROM USER_TAB_COLUMNS WHERE TABLE_NAME = PITABLE AND COLUMN_NAME = 'DLDNEY';
      IF PICNT=0 THEN
      PISTR:='ALTER TABLE '||PITABLE||' ADD DLDNEY NUMBER(11) DEFAULT 0 NOT NULL';  
      EXECUTE IMMEDIATE PISTR;
      END IF;
	  
	  SELECT COUNT (*) INTO PICNT FROM USER_TAB_COLUMNS WHERE TABLE_NAME = PITABLE AND COLUMN_NAME = 'ISFREE';
      IF PICNT=0 THEN
      PISTR:='ALTER TABLE '||PITABLE||' ADD ISFREE NUMBER(11) DEFAULT 0 NOT NULL';  
      EXECUTE IMMEDIATE PISTR;
      END IF;
	  
	  SELECT COUNT (*) INTO PICNT FROM USER_TAB_COLUMNS WHERE TABLE_NAME = PITABLE AND COLUMN_NAME = 'SHOWTIME';
      IF PICNT=0 THEN
      PISTR:='ALTER TABLE '||PITABLE||' ADD SHOWTIME NUMBER(22) DEFAULT 0 NOT NULL';  
      EXECUTE IMMEDIATE PISTR;
      END IF;
      
  END LOOP;  
  CLOSE CUR_TABLE;  
END; 
/

-- (14)表 MT_DATAREPORT 添加字段 
DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_DATAREPORT' AND COLUMN_NAME='TMPLID';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_DATAREPORT ADD TMPLID NUMBER(22) DEFAULT 0 NOT NULL';
END IF;
END;
/        

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_DATAREPORT' AND COLUMN_NAME='CHGRADE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_DATAREPORT ADD CHGRADE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/  

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='MT_DATAREPORT' AND COLUMN_NAME='MSGTYPE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE MT_DATAREPORT ADD MSGTYPE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/  

-- (15)表 RPT_WAIT_B 添加字段 
DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='RPT_WAIT_B' AND COLUMN_NAME='RPTTYPE';
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE RPT_WAIT_B ADD RPTTYPE NUMBER(11) DEFAULT 0 NOT NULL';
END IF;
END;
/  

CREATE OR REPLACE PROCEDURE CREATETABLE(PITYPE NUMBER,PIYM NUMBER)
AUTHID CURRENT_USER
IS
PISTR VARCHAR2(4000);
PISTR_1 VARCHAR2(256);
PITABLENAME VARCHAR2(20);
BEGIN
  IF PITYPE=1 THEN
    PITABLENAME:='MTTASK'||CAST(PIYM AS CHAR);
    PISTR:='CREATE TABLE '||PITABLENAME||
    '(
    ID         NUMBER(22) NOT NULL,
    MDAY       NUMBER(11) NOT NULL,
    USERID     VARCHAR2(11) NOT NULL,
    SPID       VARCHAR2(32) DEFAULT ('' '') NOT NULL,
    SPGATE     VARCHAR2(21) NOT NULL,
    CPNO       VARCHAR2(21) NOT NULL,
    PHONE      VARCHAR2(21) NOT NULL,
    SPMSGID    NUMBER(22) NOT NULL,
    RETFLAG    NUMBER(11) NOT NULL,
    FEEFLAG    NUMBER(11) NOT NULL,
    PKNUMBER   NUMBER(11) NOT NULL,
    PKTOTAL    NUMBER(11) NOT NULL,
    SENDSTATUS NUMBER(11) NOT NULL,
    SENDFLAG   NUMBER(11) NOT NULL,
    RECVFLAG   NUMBER(11) NOT NULL,
    DONEDATE   CHAR(10) NOT NULL,
    ERRORCODE  CHAR(7) NOT NULL,
    SENDLEVEL  NUMBER(11) NOT NULL,
    SENDTYPE   NUMBER(11) NOT NULL,
    UNICOM     NUMBER(11) NOT NULL,
    MOBILEAREA NUMBER(11) DEFAULT 0 NOT NULL,
    SENDTIME   TIMESTAMP(6) NOT NULL,
    RECVTIME   TIMESTAMP(6) NOT NULL,
    MESSAGE    VARCHAR2(3000) NOT NULL,
    TASKID     NUMBER(11) NOT NULL,
    ECID       NUMBER(11) NOT NULL,
    PTMSGID    NUMBER(22) NOT NULL,
    USERMSGID  NUMBER(22) DEFAULT 0 NOT NULL,
    MODULEID   NUMBER(11) DEFAULT 0 NOT NULL,
    SVRTYPE    VARCHAR2(64) DEFAULT ('' '') NOT NULL,
    P1         VARCHAR2(64) DEFAULT ('' '') NOT NULL,
    P2         VARCHAR2(64) DEFAULT ('' '') NOT NULL,
    P3         VARCHAR2(64) DEFAULT ('' '') NOT NULL,
    P4         VARCHAR2(64) DEFAULT ('' '') NOT NULL,
    ATTIME     NUMBER(22) DEFAULT 0 NOT NULL,
    VALIDTIME  NUMBER(22) DEFAULT 0 NOT NULL,
    BATCHID    NUMBER(22) DEFAULT 0 NOT NULL,
    AREACODE   NUMBER(11) DEFAULT 0 NOT NULL,
    CUSTID     VARCHAR2(64) DEFAULT ('' '') NOT NULL,
    EXDATA     VARCHAR2(64) DEFAULT ('' '') NOT NULL,
	LONGMSG	 VARCHAR2(4000) DEFAULT ('' '') NOT NULL,
	TMPLID 	 NUMBER(22) DEFAULT 0 NOT NULL,
	CHGRADE 	 NUMBER(11) DEFAULT 0 NOT NULL,
	MSGTYPE 	 NUMBER(11) DEFAULT 0 NOT NULL,
	RMSVALIDTM NUMBER(11) DEFAULT 0 NOT NULL,
	ERRORCODE2 CHAR(7) DEFAULT ('' '') NOT NULL,
	DOWNTM TIMESTAMP(6) DEFAULT SYSTIMESTAMP NOT NULL,
	RMSRPTFLAG NUMBER(11) DEFAULT 1 NOT NULL,
    PROTOCOLVER	NUMBER(11) DEFAULT 0 NOT NULL,
    TMPLTYPE	NUMBER(11) DEFAULT 0 NOT NULL,
    TITLE	 VARCHAR2(40) DEFAULT ('' '') NOT NULL,
    SHOWAY	 VARCHAR2(16) DEFAULT ('' '') NOT NULL,
    DLDWAY	NUMBER(11) DEFAULT 0 NOT NULL,
    DLDNEY	NUMBER(11) DEFAULT 0 NOT NULL,
    ISFREE	NUMBER(11) DEFAULT 0 NOT NULL,
    SHOWTIME 	 NUMBER(22) DEFAULT 0 NOT NULL
    )
    TABLESPACE TBSHISDATA
    PCTFREE 10
    INITRANS 1
    MAXTRANS 255
    STORAGE
    (
      INITIAL 64K
      MINEXTENTS 1
      MAXEXTENTS UNLIMITED
    )';
    EXECUTE IMMEDIATE PISTR;
    PISTR_1:='CREATE INDEX IX_'||PITABLENAME||'_P1 ON '||PITABLENAME||'(P1)'||'
    TABLESPACE TBSHISINDEX
    PCTFREE 10
    INITRANS 2
    MAXTRANS 255
    STORAGE
    (
      INITIAL 64K
      MINEXTENTS 1
      MAXEXTENTS UNLIMITED
    )';
    EXECUTE IMMEDIATE PISTR_1;
    PISTR_1:='CREATE UNIQUE INDEX IX_'||PITABLENAME||'_PTID ON '||PITABLENAME||'(PTMSGID)'||'
    TABLESPACE TBSHISINDEX
    PCTFREE 10
    INITRANS 2
    MAXTRANS 255
    STORAGE
    (
      INITIAL 64K
      MINEXTENTS 1
      MAXEXTENTS UNLIMITED
    )';
    EXECUTE IMMEDIATE PISTR_1;
    PISTR_1:='CREATE INDEX IX_'||PITABLENAME||'_SVRTYPE ON '||PITABLENAME||'(SVRTYPE)'||'
    TABLESPACE TBSHISINDEX
    PCTFREE 10
    INITRANS 2
    MAXTRANS 255
    STORAGE
    (
      INITIAL 64K
      MINEXTENTS 1
      MAXEXTENTS UNLIMITED
    )';
    EXECUTE IMMEDIATE PISTR_1;
    PISTR_1:='CREATE INDEX IX_'||PITABLENAME||'_TASKID ON '||PITABLENAME||'(TASKID)'||'
    TABLESPACE TBSHISINDEX
    PCTFREE 10
    INITRANS 2
    MAXTRANS 255
    STORAGE
    (
      INITIAL 64K
      MINEXTENTS 1
      MAXEXTENTS UNLIMITED
    )';
    EXECUTE IMMEDIATE PISTR_1;
    PISTR_1:='CREATE INDEX IX_'||PITABLENAME||'_SENDTIME ON '||PITABLENAME||'(SENDTIME)'||'
    TABLESPACE TBSHISINDEX
    PCTFREE 10
    INITRANS 2
    MAXTRANS 255
    STORAGE
    (
      INITIAL 64K
      MINEXTENTS 1
      MAXEXTENTS UNLIMITED
    )';
    EXECUTE IMMEDIATE PISTR_1;
    PISTR_1:='CREATE INDEX IX_'||PITABLENAME||'_UID ON '||PITABLENAME||'(USERID)'||'
    TABLESPACE TBSHISINDEX
    PCTFREE 10
    INITRANS 2
    MAXTRANS 255
    STORAGE
    (
      INITIAL 64K
      MINEXTENTS 1
      MAXEXTENTS UNLIMITED
    )';
    EXECUTE IMMEDIATE PISTR_1;
    PISTR_1:='CREATE INDEX IX_'||PITABLENAME||'_BATCHID ON '||PITABLENAME||'(BATCHID)'||'
    TABLESPACE TBSHISINDEX
    PCTFREE 10
    INITRANS 2
    MAXTRANS 255
    STORAGE
    (
      INITIAL 64K
      MINEXTENTS 1
      MAXEXTENTS UNLIMITED
    )';
    EXECUTE IMMEDIATE PISTR_1;
    PISTR_1:='CREATE INDEX IX_'||PITABLENAME||'_AREACODE ON '||PITABLENAME||'(AREACODE)'||'
    TABLESPACE TBSHISINDEX
    PCTFREE 10
    INITRANS 2
    MAXTRANS 255
    STORAGE
    (
      INITIAL 64K
      MINEXTENTS 1
      MAXEXTENTS UNLIMITED
    )';
    EXECUTE IMMEDIATE PISTR_1;
    PISTR_1:='CREATE INDEX IX_'||PITABLENAME||'_PHONE ON '||PITABLENAME||'(PHONE)'||'
    TABLESPACE TBSHISINDEX
    PCTFREE 10
    INITRANS 2
    MAXTRANS 255
    STORAGE
    (
      INITIAL 64K
      MINEXTENTS 1
      MAXEXTENTS UNLIMITED
    )';
    EXECUTE IMMEDIATE PISTR_1;
    
  ELSIF PITYPE=2 THEN
    PITABLENAME:='MMSTASK'||CAST(PIYM AS CHAR);
    PISTR:='CREATE TABLE '||PITABLENAME||
    '(
    ID          NUMBER(22) NOT NULL,
    MDAY        NUMBER(11) DEFAULT 0 NOT NULL,
    USERID      VARCHAR2(11) DEFAULT ('' '') NOT NULL,
    SPGATE      VARCHAR2(21) DEFAULT ('' '') NOT NULL,
    CPNO        VARCHAR2(21) DEFAULT ('' '') NOT NULL,
    PHONE       VARCHAR2(21) DEFAULT ('' '') NOT NULL,
    SPMSGID     NUMBER(22) DEFAULT 0 NOT NULL,
    RETFLAG     NUMBER(11) DEFAULT 0 NOT NULL,
    FEEFLAG     NUMBER(11) DEFAULT 0 NOT NULL,
    PKNUMBER    NUMBER(11) DEFAULT 0 NOT NULL,
    PKTOTAL     NUMBER(11) DEFAULT 0 NOT NULL,
    SENDSTATUS  NUMBER(11) DEFAULT 0 NOT NULL,
    SENDFLAG    NUMBER(11) DEFAULT 0 NOT NULL,
    RECVFLAG    NUMBER(11) DEFAULT 0 NOT NULL,
    DONEDATE    VARCHAR2(10) DEFAULT ('' '') NOT NULL,
    ERRORCODE   VARCHAR2(7) DEFAULT ('' '') NOT NULL,
    SENDLEVEL   NUMBER(11) DEFAULT 0 NOT NULL,
    SENDTYPE    NUMBER(11) DEFAULT 0 NOT NULL,
    UNICOM      NUMBER(11) DEFAULT 0 NOT NULL,
    SENDTIME    TIMESTAMP(6) DEFAULT SYSTIMESTAMP NOT NULL,
    RECVTIME    TIMESTAMP(6) DEFAULT SYSTIMESTAMP NOT NULL,
    MESSAGE     VARCHAR2(3000) DEFAULT ('' '') NOT NULL,
    TASKID      NUMBER(11) DEFAULT 0 NOT NULL,
    ECID        NUMBER(11) DEFAULT 0 NOT NULL,
    PTMSGID     NUMBER(22) DEFAULT 0 NOT NULL,
    SPID        VARCHAR2(32) DEFAULT ('' '') NOT NULL,
    MOBILEAREA  NUMBER(11) DEFAULT 0 NOT NULL,
    SVRTYPE     VARCHAR2(64) DEFAULT ('' '') NOT NULL,
    P1          VARCHAR2(64) DEFAULT ('' '') NOT NULL,
    P2          VARCHAR2(64) DEFAULT ('' '') NOT NULL,
    P3          VARCHAR2(64) DEFAULT ('' '') NOT NULL,
    P4          VARCHAR2(64) DEFAULT ('' '') NOT NULL,
    USERMSGID   NUMBER(22) DEFAULT 0 NOT NULL,
    MODULEID    NUMBER(11) DEFAULT 0 NOT NULL,
    ATTIME      NUMBER(22) DEFAULT 0 NOT NULL,
    VALIDTIME   NUMBER(22) DEFAULT 0 NOT NULL,
    SPMSGID2    VARCHAR2(64) DEFAULT ('' '') NOT NULL,
    JTYPE       NUMBER(11) DEFAULT 0 NOT NULL,
    ORDERCPNO   VARCHAR2(21) DEFAULT ('' '') NOT NULL,
    PASSTHROUGH NUMBER(11) DEFAULT 0 NOT NULL,
    MSGTITLE    VARCHAR2(720) DEFAULT ('' '') NOT NULL,
    TMPLID      NUMBER(22) DEFAULT 0 NOT NULL,
    MSGTYPE     NUMBER(11) DEFAULT 0 NOT NULL,
    ERRORMSG    VARCHAR2(256) DEFAULT ('' '') NOT NULL
    )
    TABLESPACE TBSHISDATA
    PCTFREE 10
    INITRANS 1
    MAXTRANS 255
    STORAGE
    (
      INITIAL 64K
      MINEXTENTS 1
      MAXEXTENTS UNLIMITED
    )';
    EXECUTE IMMEDIATE PISTR;
    PISTR_1:='ALTER TABLE '||PITABLENAME||' ADD CONSTRAINT PK_'||PITABLENAME||' PRIMARY KEY (ID)'||'
    USING INDEX 
    TABLESPACE TBSHISINDEX
    PCTFREE 10
    INITRANS 2
    MAXTRANS 255
    STORAGE
    (
      INITIAL 64K
      MINEXTENTS 1
      MAXEXTENTS UNLIMITED
    )';
    EXECUTE IMMEDIATE PISTR_1;
    PISTR_1:='CREATE INDEX IX_'||PITABLENAME||'_P1 ON '||PITABLENAME||' (P1)'||'
    TABLESPACE TBSHISINDEX
    PCTFREE 10
    INITRANS 2
    MAXTRANS 255
    STORAGE
    (
      INITIAL 64K
      MINEXTENTS 1
      MAXEXTENTS UNLIMITED
    )';
    EXECUTE IMMEDIATE PISTR_1;
    PISTR_1:='CREATE UNIQUE INDEX IX_'||PITABLENAME||'_PTMSGID ON '||PITABLENAME||' (PTMSGID)'||'
    TABLESPACE TBSHISINDEX
    PCTFREE 10
    INITRANS 2
    MAXTRANS 255
    STORAGE
    (
      INITIAL 64K
      MINEXTENTS 1
      MAXEXTENTS UNLIMITED
    )';
    EXECUTE IMMEDIATE PISTR_1;
    PISTR_1:='CREATE INDEX IX_'||PITABLENAME||'_SENDTIME ON '||PITABLENAME||' (SENDTIME)'||'
    TABLESPACE TBSHISINDEX
    PCTFREE 10
    INITRANS 2
    MAXTRANS 255
    STORAGE
    (
      INITIAL 64K
      MINEXTENTS 1
      MAXEXTENTS UNLIMITED
    )';
    EXECUTE IMMEDIATE PISTR_1;
    PISTR_1:='CREATE INDEX IX_'||PITABLENAME||'_SVRTYPE ON '||PITABLENAME||' (SVRTYPE)'||'
    TABLESPACE TBSHISINDEX
    PCTFREE 10
    INITRANS 2
    MAXTRANS 255
    STORAGE
    (
      INITIAL 64K
      MINEXTENTS 1
      MAXEXTENTS UNLIMITED
    )';
    EXECUTE IMMEDIATE PISTR_1;
    PISTR_1:='CREATE INDEX IX_'||PITABLENAME||'_TASKID ON '||PITABLENAME||' (TASKID)'||'
    TABLESPACE TBSHISINDEX
    PCTFREE 10
    INITRANS 2
    MAXTRANS 255
    STORAGE
    (
      INITIAL 64K
      MINEXTENTS 1
      MAXEXTENTS UNLIMITED
    )';
    EXECUTE IMMEDIATE PISTR_1;
    PISTR_1:='CREATE INDEX IX_'||PITABLENAME||'_USERID ON '||PITABLENAME||' (USERID)'||'
    TABLESPACE TBSHISINDEX
    PCTFREE 10
    INITRANS 2
    MAXTRANS 255
    STORAGE
    (
      INITIAL 64K
      MINEXTENTS 1
      MAXEXTENTS UNLIMITED
    )';
    EXECUTE IMMEDIATE PISTR_1;

  ELSIF PITYPE=3 THEN
    PITABLENAME:='MOTASK'||CAST(PIYM AS CHAR);
    PISTR:='CREATE TABLE '||PITABLENAME||
    '(
    ID          NUMBER(22) NOT NULL,
    "UID"         NUMBER(11) NOT NULL,
    USERID      VARCHAR2(11) NOT NULL,
    SPNUMBER    VARCHAR2(21) NOT NULL,
    SERVICEID   VARCHAR2(10) NOT NULL,
    SENDSTATUS  NUMBER(11) NOT NULL,
    DELIVERTIME TIMESTAMP(6) DEFAULT SYSTIMESTAMP NOT NULL,
    PHONE       VARCHAR2(21) NOT NULL,
    MSGCONTENT  VARCHAR2(3000) NOT NULL,
    ECID        NUMBER(11) NOT NULL,
    ORGUID      NUMBER(11) NOT NULL,
    PTMSGID     NUMBER(22) NOT NULL,
    TP_PID      NUMBER(11) NOT NULL,
    TP_UDHI     NUMBER(11) NOT NULL,
    MSGFMT      NUMBER(11) NOT NULL,
    UNICOM      NUMBER(11) DEFAULT 0 NOT NULL
    )
    TABLESPACE TBSHISDATA
    PCTFREE 10
    INITRANS 1
    MAXTRANS 255
    STORAGE
    (
      INITIAL 64K
      MINEXTENTS 1
      MAXEXTENTS UNLIMITED
    )';
    EXECUTE IMMEDIATE PISTR;
    PISTR_1:='ALTER TABLE '||PITABLENAME||' ADD CONSTRAINT '||PITABLENAME||'_PRIMARY PRIMARY KEY (ID)'||'
    USING INDEX 
    TABLESPACE TBSHISINDEX
    PCTFREE 10
    INITRANS 2
    MAXTRANS 255
    STORAGE
    (
      INITIAL 64K
      MINEXTENTS 1
      MAXEXTENTS UNLIMITED
    )';
    EXECUTE IMMEDIATE PISTR_1;
  ELSE
     PITABLENAME:='MMSMOTASK'||CAST(PIYM AS CHAR);
     PISTR:='CREATE TABLE '||PITABLENAME||
     '(
      ID          NUMBER(22) NOT NULL,
      "UID"         NUMBER(11) DEFAULT 0 NOT NULL,
      USERID      VARCHAR2(11) DEFAULT ('' '') NOT NULL,
      SPNUMBER    VARCHAR2(11) DEFAULT ('' '') NOT NULL,
      SERVICEID   VARCHAR2(10) DEFAULT ('' '') NOT NULL,
      SENDSTATUS  NUMBER(11) DEFAULT 0 NOT NULL,
      DELIVERTIME TIMESTAMP(6) DEFAULT SYSTIMESTAMP NOT NULL,
      PHONE       VARCHAR2(21) DEFAULT ('' '') NOT NULL,
      MSGCONTENT  VARCHAR2(3000) DEFAULT ('' '') NOT NULL,
      ECID        NUMBER(11) DEFAULT 0 NOT NULL,
      ORGUID      NUMBER(11) DEFAULT 0 NOT NULL,
      PTMSGID     NUMBER(22) DEFAULT 0 NOT NULL,
      TP_PID      NUMBER(11) DEFAULT 0 NOT NULL,
      TP_UDHI     NUMBER(11) DEFAULT 0 NOT NULL,
      MSGFMT      NUMBER(11) DEFAULT 15 NOT NULL,
      UNICOM      NUMBER(11) DEFAULT 0 NOT NULL,
      MSGTYPE     NUMBER(11) DEFAULT 0 NOT NULL,
      MSGTITLE    VARCHAR2(200) DEFAULT ('' '') NOT NULL,
      PASSTHROUGH NUMBER(11) DEFAULT 0 NOT NULL
    )
    TABLESPACE TBSHISDATA
    PCTFREE 10
    INITRANS 1
    MAXTRANS 255
    STORAGE
    (
      INITIAL 64K
      MINEXTENTS 1
      MAXEXTENTS UNLIMITED
    )';
    EXECUTE IMMEDIATE PISTR;
    PISTR_1:='ALTER TABLE '||PITABLENAME||' ADD CONSTRAINT PK_'||PITABLENAME||' PRIMARY KEY (ID)'||'
    USING INDEX 
    TABLESPACE TBSHISINDEX
    PCTFREE 10
    INITRANS 2
    MAXTRANS 255
    STORAGE
    (
      INITIAL 64K
      MINEXTENTS 1
      MAXEXTENTS UNLIMITED
    )';
    EXECUTE IMMEDIATE PISTR_1;
  END IF;
  END;
/

DECLARE I int;
BEGIN
SELECT count(*) INTO I  FROM  USER_TABLES WHERE TABLE_NAME='GW_RMSRPT_RVOK';
if i=1 then
   execute immediate 'drop TABLE  GW_RMSRPT_RVOK';
end if;
end;
/    

CREATE TABLE GW_RMSRPT_RVOK(
  ID         NUMBER(20) NOT NULL,
  USERID     VARCHAR(6) DEFAULT ' ' NOT NULL,
  USERUID    INT DEFAULT 0 NOT NULL,
  PTMSGID    NUMBER(20) DEFAULT 0 NOT NULL,
  SPNUMBER   VARCHAR(21) DEFAULT ' ' NOT NULL,
  PHONE   	 VARCHAR(21) DEFAULT ' ' NOT NULL,
  ERRORCODE  CHAR(7) DEFAULT ' ' NOT NULL,
  MOBILEAREA INT DEFAULT 0 NOT NULL,
  MOBILETYPE NUMBER(3) DEFAULT 0 NOT NULL,
  SENDSTATUS NUMBER(3) DEFAULT 0 NOT NULL,
  FIRSTDOWNTM TIMESTAMP(6) DEFAULT SYSTIMESTAMP NOT NULL,
  ENDDOWNTM   TIMESTAMP(6) DEFAULT SYSTIMESTAMP NOT NULL,
  RDNRPTOKTM  TIMESTAMP(6) DEFAULT SYSTIMESTAMP NOT NULL,
  RDNTRANSRPTTM  TIMESTAMP(6) DEFAULT SYSTIMESTAMP NOT NULL,
  RECVRDNRPTTM  TIMESTAMP(6) DEFAULT SYSTIMESTAMP NOT NULL,
  MOBILECOUNTRY VARCHAR(10) DEFAULT ' ' NOT NULL,
  ECID VARCHAR(10) DEFAULT ' ' NOT NULL,
  MSGTYPE NUMBER(3) DEFAULT 0 NOT NULL,
  IN_TIME  TIMESTAMP(6) DEFAULT SYSTIMESTAMP NOT NULL
) TABLESPACE TBSSMSACC
  PCTFREE 10
  INITRANS 1
  MAXTRANS 255
  STORAGE
  (
    INITIAL 64K
    MINEXTENTS 1
    MAXEXTENTS UNLIMITED
  );
  ALTER TABLE GW_RMSRPT_RVOK
  ADD CONSTRAINT PK_GWRMSRPTRVOK PRIMARY KEY (ID)
  USING INDEX 
  TABLESPACE TBSSVRINDEX
  PCTFREE 10
  INITRANS 2
  MAXTRANS 255
  STORAGE
  (
    INITIAL 64K
    MINEXTENTS 1
    MAXEXTENTS UNLIMITED
  ); 
  CREATE INDEX IX_GWRPTRVOK_PTMSGID ON GW_RMSRPT_RVOK(PTMSGID)
  TABLESPACE TBMTINDEX_PTMSGID
  PCTFREE 10
  INITRANS 2
  MAXTRANS 255
  STORAGE
  (
    INITIAL 64K
    MINEXTENTS 1
    MAXEXTENTS UNLIMITED
  );
  CREATE INDEX IX_GWRPTRVOK_RECVRDNRPTTM ON GW_RMSRPT_RVOK(RECVRDNRPTTM)
  TABLESPACE TBMTINDEX_PTMSGID
  PCTFREE 10
  INITRANS 2
  MAXTRANS 255
  STORAGE
  (
    INITIAL 64K
    MINEXTENTS 1
    MAXEXTENTS UNLIMITED
  );
  CREATE INDEX IX_GWMTSDOK_IN_TIME ON GW_RMSRPT_RVOK(IN_TIME)
  TABLESPACE TBSSVRINDEX   REVERSE
  PCTFREE 10
  INITRANS 2
  MAXTRANS 255
  STORAGE
  (
    INITIAL 64K
    MINEXTENTS 1
    MAXEXTENTS UNLIMITED
  ); 
/

DECLARE I int;
BEGIN
SELECT count(*) INTO I  FROM  USER_TABLES WHERE TABLE_NAME='GW_RMSRPT_RVOK_ERR';
if i=1 then
   execute immediate 'drop TABLE  GW_RMSRPT_RVOK_ERR';
end if;
end;
/    

CREATE TABLE GW_RMSRPT_RVOK_ERR(
  ID         NUMBER(20) NOT NULL,
  USERID     VARCHAR(6) DEFAULT ' ' NOT NULL,
  USERUID    INT DEFAULT 0 NOT NULL,
  PTMSGID    NUMBER(20) DEFAULT 0 NOT NULL,
  SPNUMBER   VARCHAR(21) DEFAULT ' ' NOT NULL,
  PHONE   	 VARCHAR(21) DEFAULT ' ' NOT NULL,
  ERRORCODE  CHAR(7) DEFAULT ' ' NOT NULL,
  MOBILEAREA INT DEFAULT 0 NOT NULL,
  MOBILETYPE NUMBER(3) DEFAULT 0 NOT NULL,
  SENDSTATUS NUMBER(3) DEFAULT 0 NOT NULL,
  FIRSTDOWNTM TIMESTAMP(6) DEFAULT SYSTIMESTAMP NOT NULL,
  ENDDOWNTM   TIMESTAMP(6) DEFAULT SYSTIMESTAMP NOT NULL,
  RDNRPTOKTM  TIMESTAMP(6) DEFAULT SYSTIMESTAMP NOT NULL,
  RDNTRANSRPTTM  TIMESTAMP(6) DEFAULT SYSTIMESTAMP NOT NULL,
  RECVRDNRPTTM  TIMESTAMP(6) DEFAULT SYSTIMESTAMP NOT NULL,
  MOBILECOUNTRY VARCHAR(10) DEFAULT ' ' NOT NULL,
  ECID VARCHAR(10) DEFAULT ' ' NOT NULL,
  MSGTYPE NUMBER(3) DEFAULT 0 NOT NULL,
  IN_TIME  TIMESTAMP(6) DEFAULT SYSTIMESTAMP NOT NULL
) TABLESPACE TBSSMSACC
  PCTFREE 10
  INITRANS 1
  MAXTRANS 255
  STORAGE
  (
    INITIAL 64K
    MINEXTENTS 1
    MAXEXTENTS UNLIMITED
  );
  ALTER TABLE GW_RMSRPT_RVOK_ERR
  ADD CONSTRAINT PK_GWRMSRPTRVOKERR PRIMARY KEY (ID)
  USING INDEX 
  TABLESPACE TBSSVRINDEX
  PCTFREE 10
  INITRANS 2
  MAXTRANS 255
  STORAGE
  (
    INITIAL 64K
    MINEXTENTS 1
    MAXEXTENTS UNLIMITED
  ); 
  CREATE INDEX IX_GWRPTRVOKERR_PTMSGID ON GW_RMSRPT_RVOK_ERR(PTMSGID)
  TABLESPACE TBMTINDEX_PTMSGID
  PCTFREE 10
  INITRANS 2
  MAXTRANS 255
  STORAGE
  (
    INITIAL 64K
    MINEXTENTS 1
    MAXEXTENTS UNLIMITED
  );
  CREATE INDEX IX_GWRPTRVOKERR_RECVRDNRPTTM ON GW_RMSRPT_RVOK_ERR(RECVRDNRPTTM)
  TABLESPACE TBMTINDEX_PTMSGID
  PCTFREE 10
  INITRANS 2
  MAXTRANS 255
  STORAGE
  (
    INITIAL 64K
    MINEXTENTS 1
    MAXEXTENTS UNLIMITED
  );
  CREATE INDEX IX_GWMTSDOKERR_IN_TIME ON GW_RMSRPT_RVOK_ERR(IN_TIME)
  TABLESPACE TBSSVRINDEX   REVERSE
  PCTFREE 10
  INITRANS 2
  MAXTRANS 255
  STORAGE
  (
    INITIAL 64K
    MINEXTENTS 1
    MAXEXTENTS UNLIMITED
  ); 
/

DECLARE I int;
BEGIN
SELECT count(*) INTO I  FROM  USER_TABLES WHERE TABLE_NAME='GW_RMSRPT_RVOK_BAK';
if i=1 then
   execute immediate 'drop TABLE  GW_RMSRPT_RVOK_BAK';
end if;
end;
/   
CREATE TABLE GW_RMSRPT_RVOK_BAK(
  ID         NUMBER(20) NOT NULL,
  USERID     VARCHAR(6) DEFAULT ' ' NOT NULL,
  USERUID    INT DEFAULT 0 NOT NULL,
  PTMSGID    NUMBER(20) DEFAULT 0 NOT NULL,
  SPNUMBER   VARCHAR(21) DEFAULT ' ' NOT NULL,
  PHONE   	 VARCHAR(21) DEFAULT ' ' NOT NULL,
  ERRORCODE  CHAR(7) DEFAULT ' ' NOT NULL,
  MOBILEAREA INT DEFAULT 0 NOT NULL,
  MOBILETYPE NUMBER(3) DEFAULT 0 NOT NULL,
  SENDSTATUS NUMBER(3) DEFAULT 0 NOT NULL,
  FIRSTDOWNTM TIMESTAMP(6) DEFAULT SYSTIMESTAMP NOT NULL,
  ENDDOWNTM   TIMESTAMP(6) DEFAULT SYSTIMESTAMP NOT NULL,
  RDNRPTOKTM  TIMESTAMP(6) DEFAULT SYSTIMESTAMP NOT NULL,
  RDNTRANSRPTTM  TIMESTAMP(6) DEFAULT SYSTIMESTAMP NOT NULL,
  RECVRDNRPTTM  TIMESTAMP(6) DEFAULT SYSTIMESTAMP NOT NULL,
  MOBILECOUNTRY VARCHAR(10) DEFAULT ' ' NOT NULL,
  ECID VARCHAR(10) DEFAULT ' ' NOT NULL,
  MSGTYPE NUMBER(3) DEFAULT 0 NOT NULL,
  IN_TIME  TIMESTAMP(6) DEFAULT SYSTIMESTAMP NOT NULL
) TABLESPACE TBSSMSACC
  PCTFREE 10
  INITRANS 1
  MAXTRANS 255
  STORAGE
  (
    INITIAL 64K
    MINEXTENTS 1
    MAXEXTENTS UNLIMITED
  );
  ALTER TABLE GW_RMSRPT_RVOK_BAK
  ADD CONSTRAINT PK_GWRMSRPTRVOKBAK PRIMARY KEY (ID)
  USING INDEX 
  TABLESPACE TBSSVRINDEX
  PCTFREE 10
  INITRANS 2
  MAXTRANS 255
  STORAGE
  (
    INITIAL 64K
    MINEXTENTS 1
    MAXEXTENTS UNLIMITED
  ); 
  CREATE INDEX IX_GWRPTRVOKBAK_PTMSGID ON GW_RMSRPT_RVOK_BAK(PTMSGID)
  TABLESPACE TBMTINDEX_PTMSGID
  PCTFREE 10
  INITRANS 2
  MAXTRANS 255
  STORAGE
  (
    INITIAL 64K
    MINEXTENTS 1
    MAXEXTENTS UNLIMITED
  );
  CREATE INDEX IX_GWRPTRVOKBAK_RECVRDNRPTTM ON GW_RMSRPT_RVOK_BAK(RECVRDNRPTTM)
  TABLESPACE TBMTINDEX_PTMSGID
  PCTFREE 10
  INITRANS 2
  MAXTRANS 255
  STORAGE
  (
    INITIAL 64K
    MINEXTENTS 1
    MAXEXTENTS UNLIMITED
  );
  CREATE INDEX IX_GWRPTRVOKBAK_IN_TIME ON GW_RMSRPT_RVOK_BAK(IN_TIME)
  TABLESPACE TBSSVRINDEX   REVERSE
  PCTFREE 10
  INITRANS 2
  MAXTRANS 255
  STORAGE
  (
    INITIAL 64K
    MINEXTENTS 1
    MAXEXTENTS UNLIMITED
  ); 
/

CREATE OR REPLACE PROCEDURE GW_WR_RMSRPT_RVOK
 (
  PIUSERID IN VARCHAR2,
  PIUSERUID IN VARCHAR2, 
  PIPTMSGID IN NUMBER,
  PISPNUMBER IN VARCHAR2,
  PIPHONE IN VARCHAR2,
  PIERRORCODE IN VARCHAR2,
  PIMOBILEAREA IN VARCHAR2,
  PIMOBILETYPE IN NUMBER,
  PISENDSTATUS IN NUMBER,
  PIFIRSTDOWNTM IN TIMESTAMP,
  PIENDDOWNTM IN TIMESTAMP,
  PIRDNRPTOKTM IN TIMESTAMP,
  PIRDNTRANSRPTTM IN TIMESTAMP,
  PIRECVRDNRPTTM IN TIMESTAMP,
  PIMOBILECOUNTRY  IN VARCHAR2,
  PIECID  IN VARCHAR2,
  PIMSGTYPE IN NUMBER
 )
AS
  ICOUNT PLS_INTEGER;
BEGIN
  ICOUNT:=0;
  SELECT COUNT(PTMSGID) INTO ICOUNT FROM GW_RMSRPT_RVOK WHERE PTMSGID = PIPTMSGID;
  IF ICOUNT<1 THEN
    INSERT INTO GW_RMSRPT_RVOK(USERID,USERUID,PTMSGID,SPNUMBER,PHONE,ERRORCODE,MOBILEAREA,MOBILETYPE,SENDSTATUS,FIRSTDOWNTM,ENDDOWNTM,RDNRPTOKTM,RDNTRANSRPTTM,RECVRDNRPTTM,MOBILECOUNTRY,ECID,MSGTYPE )
     VALUES(PIUSERID,PIUSERUID,PIPTMSGID,PISPNUMBER,PIPHONE,PIERRORCODE,PIMOBILEAREA,PIMOBILETYPE,PISENDSTATUS,PIFIRSTDOWNTM,PIENDDOWNTM,PIRDNRPTOKTM,PIRDNTRANSRPTTM,PIRECVRDNRPTTM,PIMOBILECOUNTRY,PIECID,PIMSGTYPE);
  END IF;
END;
/


CREATE OR REPLACE PROCEDURE GW_DEL_ERR
is
 STR VARCHAR2(3000);
 STR1 VARCHAR2(3000);
 PROCESSFLAG NUMBER(11);
 PIERROR VARCHAR2(5120);
 PICODE NUMBER(11) DEFAULT 0;
 I  NUMBER(22) DEFAULT 0;
 EXCP_ORA_00001  EXCEPTION;
 PRAGMA EXCEPTION_INIT(EXCP_ORA_00001,-00001);
BEGIN
  PROCESSFLAG:=3;
  I:=0;
 WHILE (I<3) LOOP
    BEGIN
   STR1:=' ID,PTMSGID,SPMSGID,SENDSTATUS,SPID,TRANSMTTIME,MTSUBMITTIME,SENDTIME,ERRRESENDCNT,NETERRCNT,SENDRESULT,SPGATESEND,SPNUMBER,PHONE,SENDERRCODE,TPUDHI,TPPID,PKTOTAL,PKNUMBER,LONGMSGSEQ,IN_TIME ';
   STR :='INSERT  INTO GW_MTSDOK_ERR nologging SELECT '||STR1||' FROM GW_MTSDOK WHERE (IN_TIME < TO_DATE(TO_CHAR(SYSDATE-:1,''YYYY-MM-DD''),''YYYY-MM-DD HH24:MI:SS '') )';
   EXECUTE IMMEDIATE STR USING PROCESSFLAG;
  -- DBMS_OUTPUT.PUT_LINE(STR); 
    PIERROR:=SQLERRM; PICODE:=SQLCODE;
    EXCEPTION WHEN EXCP_ORA_00001 THEN
       BEGIN
      STR := 'DELETE FROM GW_MTSDOK_ERR WHERE EXISTS (SELECT ID FROM GW_MTSDOK WHERE GW_MTSDOK.ID=GW_MTSDOK_ERR.ID) AND (IN_TIME < TO_DATE(TO_CHAR(SYSDATE-:1,''YYYY-MM-DD''),''YYYY-MM-DD HH24:MI:SS '') )';
      EXECUTE IMMEDIATE STR  USING PROCESSFLAG;
      END;
    WHEN OTHERS THEN
      INSERT INTO TRANS_LOG(USETYPE, TRANSNAME, TSTATUS) VALUES('TRANERR','GW_MTSDOK..TO..GW_MTSDOK_ERR',PIERROR);
     COMMIT; END;
   IF PICODE >=0  THEN
      
      DELETE FROM GW_MTSDOK WHERE (IN_TIME < TO_DATE(TO_CHAR(SYSDATE-PROCESSFLAG,'YYYY-MM-DD'),'YYYY-MM-DD HH24:MI:SS ') );
      COMMIT;
      I:=3;
   END IF;
     I:=I+1;
 END LOOP;

 I:=0;
 WHILE (I<3) LOOP
    BEGIN
   STR1:='ID,PTMSGID,SPMSGID,SENDSTATUS,RECVTIME,DONEDATE,SUBMITDATE,ERRORCODE ,PHONE,SPNUMBER,IN_TIME ';
  STR :='INSERT  INTO GW_RPTRVOK_ERR nologging SELECT '||STR1||' FROM GW_RPTRVOK WHERE (IN_TIME < TO_DATE(TO_CHAR(SYSDATE-:1,''YYYY-MM-DD''),''YYYY-MM-DD HH24:MI:SS '') )';
   EXECUTE IMMEDIATE STR USING PROCESSFLAG;
     PIERROR:=SQLERRM; PICODE:=SQLCODE;
    EXCEPTION WHEN EXCP_ORA_00001 THEN
      STR := 'DELETE FROM GW_RPTRVOK_ERR WHERE EXISTS (SELECT ID FROM GW_RPTRVOK WHERE ID=GW_RPTRVOK_ERR.ID) AND (IN_TIME < TO_DATE(TO_CHAR(SYSDATE-:1,''YYYY-MM-DD''),''YYYY-MM-DD HH24:MI:SS ''))';
     EXECUTE IMMEDIATE STR USING PROCESSFLAG;
    WHEN OTHERS THEN
     INSERT INTO TRANS_LOG(USETYPE, TRANSNAME, TSTATUS) VALUES('TRANERR','GW_RPTRVOK..TO..GW_RPTRVOK_ERR',PIERROR);
     COMMIT; END;
   IF PICODE >=0  THEN
      
      DELETE FROM GW_RPTRVOK WHERE (IN_TIME < TO_DATE(TO_CHAR(SYSDATE-PROCESSFLAG,'YYYY-MM-DD'),'YYYY-MM-DD HH24:MI:SS ') );
      COMMIT;
      I:=3;
   END IF;
     I:=I+1;
 END LOOP;

  I:=0;
 WHILE (I<3) LOOP
    BEGIN
    STR1:=' ID,PTMSGID,SPMSGID,SENDSTATUS,SENDFLAG,SENDRPTTIME,TRANSRPTTIME,ERRORCODE,PHONE,SPNUMBER,IN_TIME';
   STR :='INSERT  INTO GW_RPTSDOK_ERR nologging SELECT '||STR1||' FROM GW_RPTSDOK WHERE (IN_TIME < TO_DATE(TO_CHAR(SYSDATE-:1,''YYYY-MM-DD''),''YYYY-MM-DD HH24:MI:SS '') )';
   EXECUTE IMMEDIATE STR USING PROCESSFLAG;
     PIERROR:=SQLERRM; PICODE:=SQLCODE;
    EXCEPTION WHEN EXCP_ORA_00001 THEN
      STR := 'DELETE FROM GW_RPTSDOK_ERR WHERE EXISTS (SELECT ID FROM GW_RPTSDOK WHERE ID=GW_RPTSDOK_ERR.ID) AND (IN_TIME < TO_DATE(TO_CHAR(SYSDATE-:1,''YYYY-MM-DD''),''YYYY-MM-DD HH24:MI:SS '') )';
     EXECUTE IMMEDIATE STR USING PROCESSFLAG;
   WHEN OTHERS THEN
     INSERT INTO TRANS_LOG(USETYPE, TRANSNAME, TSTATUS) VALUES('TRANERR','GW_RPTSDOK..TO..GW_RPTSDOK_ERR',PIERROR);
     COMMIT; END;
    IF PICODE >=0  THEN
      
      DELETE FROM GW_RPTSDOK WHERE (IN_TIME < TO_DATE(TO_CHAR(SYSDATE-PROCESSFLAG,'YYYY-MM-DD'),'YYYY-MM-DD HH24:MI:SS ') );
    COMMIT;
    I:=3;
   END IF;
    I:=I+1;
 END LOOP;
 
DELETE FROM GW_TRAN_DEL_LOG WHERE END_TIME<sysdate - 90;
DELETE FROM GW_UPD_DEL_LOG WHERE END_TIME<sysdate - 90;

DELETE FROM GW_MTSDOK_ERR WHERE IN_TIME<sysdate - 90;
DELETE FROM GW_RPTRVOK_ERR WHERE IN_TIME<sysdate - 90;
DELETE FROM GW_RPTSDOK_ERR WHERE IN_TIME<sysdate - 90;
COMMIT;
END;
/


CREATE OR REPLACE PROCEDURE GW_UPPRMSRPTRVOK(PRETIME IN NUMBER,INCRES IN  NUMBER,STARTTIME IN VARCHAR2)
IS
 ROWS1 NUMBER(11) DEFAULT 0 ;
 LOGID NUMBER(11) DEFAULT 0 ;
 PICODE NUMBER(11);

 MAXID  NUMBER(22) DEFAULT 0;
 MINID  NUMBER(22) DEFAULT 0;
 CURMINID  NUMBER(22) DEFAULT 0;
 CURMAXID  NUMBER(22) DEFAULT 0;

 I  NUMBER(11) DEFAULT 0;
 J  NUMBER(11) DEFAULT 0;
 REMAINDER  NUMBER(11) DEFAULT 0;
  MINLONG NUMBER(11) DEFAULT 0;
  
 ISEXIST NUMBER(11) DEFAULT 0;
 P_NUMALL NUMBER(22) DEFAULT 0;
 COUNTID NUMBER(22) DEFAULT 0;
 INCRESDEL NUMBER(22) DEFAULT 0;

 EXCP_ORA_30926  EXCEPTION;
 PRAGMA EXCEPTION_INIT(EXCP_ORA_30926,-30926);

BEGIN
  
--创建临时表
 SELECT COUNT(TABLE_NAME) INTO ISEXIST FROM USER_TABLES WHERE TABLE_NAME='TMP_DEL';
  IF(ISEXIST>0) THEN
    BEGIN
          EXECUTE IMMEDIATE 'TRUNCATE TABLE TMP_DEL';
    END;
   ELSE
     EXECUTE IMMEDIATE 'CREATE GLOBAL TEMPORARY TABLE TMP_DEL(PTMSGID NUMBER(22)) ON COMMIT PRESERVE ROWS';
  END IF;



------------------更新GW_RMSRPT_RVOK表-------------------------------------------

SELECT NVL(MIN(ID),0),NVL(MAX(ID),0) INTO MINID,MAXID FROM GW_RPTRVOK;
IF MINID=0 AND MAXID=0 THEN
RETURN;
END IF;
SELECT (MAXID-MINID+1)/INCRES,MOD((MAXID-MINID+1),INCRES) INTO J,REMAINDER  FROM DUAL;
IF REMAINDER<>0 THEN
 J:=J+1;END IF;
 I:=0;
 INCRESDEL:=INCRES+100000;
WHILE (I<J) LOOP
INSERT INTO GW_UPD_DEL_LOG(ID,OPRTYPE,UPTYPE,COUNTID,ISSUCCES,IN_TIME,END_TIME) VALUES(SEQ_GW_UPD_DEL_LOG.NEXTVAL,7,1,0,0,sysdate,sysdate);
SELECT SEQ_GW_UPD_DEL_LOG.CURRVAL INTO LOGID FROM DUAL;
 CURMINID:=MINID+INCRES*I;
 CURMAXID:=CURMINID+INCRES-1;
IF I=J-1 THEN
   CURMAXID:=MAXID;
END IF;

ROWS1:=0;  PICODE:=0;
BEGIN
MERGE INTO   GW_MT_TASK_BAK  A USING (SELECT PTMSGID,FIRSTDOWNTM,ERRORCODE FROM GW_RMSRPT_RVOK WHERE ID <= CURMAXID AND ID >= CURMINID) B ON ( A.PTMSGID=B.PTMSGID)
WHEN MATCHED THEN
 UPDATE SET  A.ERRORCODE2=B.ERRORCODE,
             A.DOWNTM=B.FIRSTDOWNTM;
      ROWS1:=SQL%ROWCOUNT; PICODE:=SQLCODE;
   EXCEPTION WHEN EXCP_ORA_30926 THEN
    --------------若有重复的 则去重 更新
MERGE INTO   GW_MT_TASK_BAK  A USING (SELECT  PTMSGID,FIRSTDOWNTM,ERRORCODE FROM  GW_RMSRPT_RVOK where  ID <= CURMAXID AND ID >= CURMINID GROUP BY PTMSGID )   B  on ( A.PTMSGID=B.PTMSGID )
WHEN MATCHED THEN
 UPDATE SET  A.ERRORCODE2=B.ERRORCODE,
             A.DOWNTM=B.FIRSTDOWNTM;
       ROWS1:=SQL%ROWCOUNT;
    UPDATE GW_UPD_DEL_LOG SET UPTYPE=2,COUNTID=ROWS1, ISSUCCES=1,END_TIME=sysdate WHERE ID=LOGID  AND ISSUCCES=0;
  WHEN OTHERS THEN
   ROLLBACK; END;

   IF PICODE>=0 THEN
      UPDATE GW_UPD_DEL_LOG SET COUNTID=ROWS1,ISSUCCES=1, END_TIME=sysdate WHERE ID=LOGID  AND ISSUCCES=0;
   END IF;
  COMMIT;

 -------------删除更新成功的
 EXECUTE IMMEDIATE 'TRUNCATE TABLE TMP_DEL';
INSERT INTO TMP_DEL 
SELECT PTMSGID
  FROM (SELECT  PTMSGID FROM GW_RMSRPT_RVOK WHERE ID <= CURMAXID AND ID >= CURMINID) GR
 WHERE EXISTS (SELECT PTMSGID
          FROM GW_MT_TASK_BAK
         WHERE GR.PTMSGID = GW_MT_TASK_BAK.PTMSGID) ;
           
  INSERT INTO GW_UPD_DEL_LOG(ID,OPRTYPE,UPTYPE,COUNTID,ISSUCCES,IN_TIME,END_TIME) VALUES(SEQ_GW_UPD_DEL_LOG.NEXTVAL,8,0,0,0,sysdate,sysdate);
  SELECT SEQ_GW_UPD_DEL_LOG.CURRVAL INTO LOGID FROM DUAL;
  --DELETE FROM  GW_RMSRPT_RVOK WHERE EXISTS (SELECT PTMSGID FROM GW_MT_TASK_BAK WHERE GW_RMSRPT_RVOK.PTMSGID =GW_MT_TASK_BAK.PTMSGID AND GW_MT_TASK_BAK.FLAGRPTRVOK=1 ) AND ID >= CURMINID AND ID <= CURMAXID;
  GW_DEL_DATA(INCRESDEL,10001,2,P_NUMALL); 
  ROWS1:=P_NUMALL;

  IF ROWS1>=0 THEN
    UPDATE GW_UPD_DEL_LOG SET COUNTID=ROWS1,ISSUCCES=1, END_TIME=sysdate WHERE ID=LOGID;
  END IF;
 COMMIT;
 MINLONG:=FLOOR(TO_NUMBER(SYSDATE-TO_DATE(STARTTIME,'YYYY-MM-DD HH24:MI:SS'))*24*60);
IF MINLONG>=PRETIME THEN
    I:=J;
ELSE
    I:=I+1;
END IF;

 END LOOP;
COMMIT;
END;
/


CREATE OR REPLACE PROCEDURE GW_LOADLFTEMPLATE(OUT_CURSOR OUT SYS_REFCURSOR)
IS
BEGIN
  OPEN OUT_CURSOR FOR
  SELECT TM_ID,USER_ID,TM_NAME,TM_MSG,DSFLAG,TM_STATE,ADDTIME,ISPASS,TMP_TYPE,BIZ_CODE,CORP_CODE,PARAMCNT,TM_CODE,SP_TEMPLID,DEGREE,ISPUBLIC,PARAMSNUM,RMSRESSIZE,H5RESSIZE,VER  FROM LF_TEMPLATE WHERE TM_STATE=1 AND (TMP_TYPE=3 OR TMP_TYPE=11);
END;
/


CREATE OR REPLACE PROCEDURE GW_H_DATATRANV3(ISP1 IN NUMBER,ISP2 IN NUMBER,ISP3 IN NUMBER,ISP4 IN NUMBER)
AUTHID CURRENT_USER
AS
  PRAGMA AUTONOMOUS_TRANSACTION ;
  PROCESSINGSTATUSCOUNT NUMBER; --PROCESSINGSTATUS表记录数(根据USEID设置值判断,为1正常)
  PIUSEID                 NUMBER; --使用哪一个USEID作为当前状态处理
  PICURRINDEX             NUMBER; --当前处理位置
  PIMAXINDEX              NUMBER; --此次执行的最大位置
  COUNTSTATUS           NUMBER; --统计状态0:正常,1:错误
  DISTRACTSTATUS        NUMBER; --数据转移状态0:正常,1:错误
  DELETESTATUS          NUMBER; --删除状态0:正常,1:错误
  PROCESSFLAG           NUMBER; --转移方式0:处理今天（含今天)以前的，1为前一天以前的 ,2为前二天以前的...以此类推,
  --异常退出
  COUNTEXCEPTION        NUMBER; --允许统计异常最大值
  DISTRACTEXCEPTION     NUMBER; --允许数据转移异常最大值
  DELETEEXCEPTION       NUMBER; --允许删除数据异常最大值
  ALLEXCEPTION          NUMBER; --允许所有异常最大值
  --批量转移临时变量
  PI_CURINDEX           NUMBER;
  PI_MININDEX           NUMBER;
  PI_MAXINDEX           NUMBER;
  EACHMAX               NUMBER; --每次处理最大数

  MAXYM  NUMBER;
  MINYM  NUMBER;
  CURYM  NUMBER;
  PITBNUM NUMBER;
  PITABLENAME VARCHAR2(20);
  PISTR VARCHAR2(256);
  PIERROR VARCHAR2(4000);

BEGIN
--------------------VER 3.2-------------------------------------
INSERT INTO TRANS_LOG(USETYPE, TRANSNAME, TSTATUS) VALUES('SMS','GW_H_DATATRANV3','短信汇总调度存储过程执行开始');
COMMIT;

--初始化
  PROCESSINGSTATUSCOUNT := 0;
  PIUSEID                 := 1;
  PICURRINDEX             := 0;
  PIMAXINDEX              := 0;
  COUNTSTATUS           := 1;
  DISTRACTSTATUS        := 1;
  DELETESTATUS          := 1;
  PROCESSFLAG           := 3;
  EACHMAX               := 500000;
  COUNTEXCEPTION        := 5;
  DISTRACTEXCEPTION     := 5;
  DELETEEXCEPTION       := 5;
  ALLEXCEPTION          := 10;


  --先汇总
  SELECT NVL(MIN(ID),0),NVL(MAX(ID),0) INTO PICURRINDEX,PIMAXINDEX  FROM GW_MT_TASK_BAK MT_TASK WHERE ( MT_TASK.SENDTIME >= TO_DATE(TO_CHAR(SYSDATE-PROCESSFLAG,'YYYY-MM-DD'),'YYYY-MM-DD HH24:MI:SS ') AND MT_TASK.SENDTIME < TO_DATE(TO_CHAR(SYSDATE,'YYYY-MM-DD'),'YYYY-MM-DD HH24:MI:SS '));

    BEGIN
      GW_H_STATISTIV3(PROCESSFLAG,ISP1,ISP2,ISP3,ISP4);
      EXCEPTION WHEN OTHERS THEN
        PIERROR:=SQLERRM;
        INSERT INTO TRANS_LOG(USETYPE, TRANSNAME, TSTATUS) VALUES('SMS','短信下行汇总GW_H_STATISTIV3',PIERROR);
        COMMIT;
    END;


  --再转移
  --先根据指定USEID判断是否有值
  SELECT COUNT(USEID) INTO PROCESSINGSTATUSCOUNT FROM PROCESSINGSTATUS WHERE USEID = PIUSEID;
  --如果没有先初始化PROCESSINGSTATUS,否则取当表中值
  IF (PROCESSINGSTATUSCOUNT = 0) THEN
  BEGIN
    H_PROCESSSTATUS(PIUSEID,0,0,0,0,0);
    SELECT CURRINDEX,MAXINDEX,COUNTSTATUS,DISTRACTSTATUS,DELETESTATUS
    INTO PICURRINDEX,PIMAXINDEX,COUNTSTATUS,DISTRACTSTATUS,DELETESTATUS
    FROM PROCESSINGSTATUS WHERE USEID = PIUSEID;
  END;
  ELSE
    SELECT CURRINDEX,MAXINDEX,COUNTSTATUS,DISTRACTSTATUS,DELETESTATUS
    INTO PICURRINDEX,PIMAXINDEX,COUNTSTATUS,DISTRACTSTATUS,DELETESTATUS
    FROM PROCESSINGSTATUS WHERE USEID = PIUSEID;
  END IF;

  --转移符合当前时间的数据
  SELECT NVL(MIN(ID),0) INTO PIMAXINDEX  FROM GW_MT_TASK_BAK MT_TASK WHERE  MT_TASK.SENDTIME >= TO_DATE(TO_CHAR(SYSDATE-PROCESSFLAG,'YYYY-MM-DD'),'YYYY-MM-DD HH24:MI:SS ');

IF   PIMAXINDEX>0 THEN
PIMAXINDEX:=PIMAXINDEX-1;
END IF;

IF(PICURRINDEX<PIMAXINDEX)THEN
    --创建不存在的表
    SELECT CAST(TO_CHAR(MIN(SENDTIME),'YYYYMM')AS INT),CAST(TO_CHAR(MAX(SENDTIME),'YYYYMM')AS INT) INTO  MINYM,MAXYM  FROM GW_MT_TASK_BAK   WHERE  ID<=PIMAXINDEX;
    CURYM := MINYM;
    WHILE CURYM<=MAXYM LOOP
      PITABLENAME := 'MTTASK'||CAST(CURYM AS CHAR);
      PISTR:='SELECT COUNT(1) AS CNT FROM USER_TABLES T WHERE T.TABLE_NAME='''||PITABLENAME||'''';
      EXECUTE IMMEDIATE PISTR INTO PITBNUM;
      IF PITBNUM<1 THEN
        PISTR:='CALL CREATETABLE (1,'||CAST(CURYM AS CHAR)||')';
        BEGIN
          EXECUTE IMMEDIATE PISTR;
          EXCEPTION WHEN OTHERS THEN
            PIERROR:=SQLERRM;
            INSERT INTO TRANS_LOG(USETYPE, TRANSNAME, TSTATUS) VALUES('SMS','短信下行历史表创建：CREATETABLE',PIERROR);
            COMMIT;
        END;
      END IF;

      IF CAST(SUBSTR(CAST(CURYM AS CHAR),5,2) AS INT)=12 THEN
        CURYM := CAST(CAST(CAST(SUBSTR(CAST(CURYM AS CHAR),1,4)AS INT)+1 AS CHAR)||'01' AS INT);
      ELSE
        CURYM := CURYM+1;
      END IF;
    END LOOP;
    --转移数据
    IF (PIMAXINDEX-PICURRINDEX>=EACHMAX) THEN
      PI_MININDEX:=PICURRINDEX;
      PI_CURINDEX:=PI_MININDEX+EACHMAX;
    ELSE
      PI_MININDEX:=PICURRINDEX;
      PI_CURINDEX:=PIMAXINDEX;
    END IF;
    SAVEPOINT A;
    WHILE (PI_MININDEX < PIMAXINDEX) LOOP
      --跳到此处重复执行
      <<LABEL_LOCAL_ERROR>>
      BEGIN
      GW_H_TRANSFERV1(PI_MININDEX,PI_CURINDEX,0,0);
      GW_H_DELTASKV1(PI_MININDEX,PI_CURINDEX,PROCESSFLAG,0);
      H_PROCESSSTATUS(PIUSEID,PI_CURINDEX,PI_CURINDEX,0,0,0);
      EXCEPTION WHEN OTHERS THEN
        ROLLBACK;--事务回滚
        PIERROR:=SQLERRM;
        INSERT INTO TRANS_LOG(USETYPE, TRANSNAME, TSTATUS) VALUES('SMS','短信下行数据转移',PIERROR);
        COMMIT;
      DISTRACTEXCEPTION := DISTRACTEXCEPTION - 1;
      ALLEXCEPTION      := ALLEXCEPTION - 1;
      DBMS_OUTPUT.PUT_LINE('您还有'||DISTRACTEXCEPTION||'次(数据转移)机会,共'||ALLEXCEPTION||'次机会');
      IF(DISTRACTEXCEPTION <= 0 OR ALLEXCEPTION <= 0) THEN
         --DBMS_OUTPUT.PUT_LINE('短信下行调度异常，发生回滚！');
         RETURN;
      ELSE
         GOTO LABEL_LOCAL_ERROR;
      END IF;
      END;--EXCEPTION WHEN OTHERS THEN截止
      IF (PIMAXINDEX-PI_CURINDEX>=EACHMAX) THEN
        PI_CURINDEX:=PI_CURINDEX+EACHMAX;
        PI_MININDEX:=PI_MININDEX+EACHMAX;
      ELSE
        PI_CURINDEX:=PIMAXINDEX;
        PI_MININDEX:=PI_MININDEX+EACHMAX;
      END IF;
      COMMIT ;--事务提交
   END LOOP;
   END IF;
   -- 执行上行统计
   H_TRANSFERMO();
   GW_DELWAIT();
      INSERT INTO TRANS_LOG(USETYPE, TRANSNAME, TSTATUS, RUNFLAG) VALUES('SMS','GW_H_DATATRANV3','短信汇总调度存储过程执行结束', 1);
      COMMIT;

END;
/

CREATE OR REPLACE PROCEDURE GW_H_STATISTIV3(PROCESSFLAG IN NUMBER,ISP1 IN NUMBER,ISP2 IN NUMBER,ISP3 IN NUMBER,ISP4 IN NUMBER)
AUTHID CURRENT_USER
IS
   STR VARCHAR2(4000);
   TABLENAME VARCHAR2(20);
   ISEXIST NUMBER;
   MAXIYMD NUMBER;
   DIFFDATE NUMBER;
   CURPROCESSFLAG NUMBER;
BEGIN
  --------------------VER 3.2-------------------------------------
--删除临时
          TABLENAME :='TMEP_STATISTICS';
          ISEXIST:=0;
          SELECT COUNT(TABLE_NAME) INTO ISEXIST FROM USER_TABLES WHERE TABLE_NAME=UPPER(TABLENAME);
          IF(ISEXIST>0) THEN
            BEGIN
                  STR := 'DROP TABLE '||TABLENAME;
                  EXECUTE IMMEDIATE STR;
            END;
          END IF;
--创建临时表

      --  SPISUNCM NUMBER(11),
 STR :='CREATE GLOBAL TEMPORARY TABLE '|| TABLENAME ||'(
        USERID VARCHAR2(11),
        TASKID NUMBER(11),
        SPGATE VARCHAR2(21),
        SPISUNCM NUMBER(11),
        SPID VARCHAR2(32),
        SVRTYPE VARCHAR2(64),
        P1 VARCHAR2(64),
        P2 VARCHAR2(64),
        P3 VARCHAR2(64),
        P4 VARCHAR2(64),
        IYMD NUMBER(11),
        IYEAR NUMBER(11),
        IMONTH NUMBER(11),
        IHOUR NUMBER(11),
        ICOUNT NUMBER(11),
        SUCC NUMBER(11),
        FAIL NUMBER(11),
        NRET NUMBER(11),
        SENDTYPE NUMBER(11),
        MOBILEAREA NUMBER(11),
        BATCHID NUMBER(22),
        AREACODE NUMBER(11),
		TMPLID NUMBER(22),
		CHGRADE NUMBER(11),
		MSGTYPE NUMBER(11)
 )';

--DBMS_OUTPUT.PUT_LINE(STR);
 EXECUTE IMMEDIATE STR;
 --统计
  CURPROCESSFLAG:=PROCESSFLAG;
  SELECT NVL(MAX(IYMD),20000101) INTO MAXIYMD  FROM MT_DATAREPORT;
  DIFFDATE:= TO_DATE(TO_CHAR(SYSDATE-2,'YYYY-MM-DD'),'YYYY-MM-DD HH24:MI:SS')-to_date(MAXIYMD,'YYYY-MM-DD HH24:MI:SS') ;
  IF DIFFDATE>0 THEN
          CURPROCESSFLAG:=CURPROCESSFLAG+DIFFDATE;
  END IF;
 STR:= 'INSERT INTO  '|| TABLENAME ||' (USERID,TASKID,SPGATE,SPISUNCM,SPID,SVRTYPE,P1,P2,P3,P4,IYMD,IYEAR,IMONTH,IHOUR,ICOUNT,SUCC,FAIL,NRET,SENDTYPE,MOBILEAREA,BATCHID,AREACODE,TMPLID,CHGRADE,MSGTYPE)
               SELECT  USERID,TASKID,SPGATE,UNICOM,SPID,SVRTYPE';
               IF ISP1=1 THEN
                  STR:=STR||',P1';
                ELSE
                  STR:=STR||','' '' AS P1';
                END IF;
               IF ISP2=1 THEN
                  STR:=STR||',P2';
                ELSE
                  STR:=STR||','' '' AS P2';
                END IF;
                IF ISP3=1 THEN
                  STR:=STR||',P3';
                ELSE
                  STR:=STR||','' '' AS P3';
                END IF;
                IF ISP4=1 THEN
                  STR:=STR||',P4';
                ELSE
                  STR:=STR||','' '' AS P4';
                END IF;

               STR:=STR||',
               TO_NUMBER(TO_CHAR(SENDTIME,''YYYYMMDD'')) AS IYMD,
               TO_NUMBER(TO_CHAR(SENDTIME,''YYYY'')) AS IYEAR,
               TO_NUMBER(TO_CHAR(SENDTIME,''MM'')) AS MON,
               TO_NUMBER(TO_CHAR(SENDTIME,''HH24'')) AS HOUR,
               COUNT(ID),
               NVL(COUNT(CASE TRIM(ERRORCODE) WHEN ''DELIVRD'' THEN 1 WHEN ''0'' THEN 1 ELSE NULL END),0),
               NVL(COUNT(CASE SUBSTR(ERRORCODE,1,3) WHEN ''E1:'' THEN 1 WHEN ''E2:'' THEN 1 ELSE NULL END),0),
               NVL(COUNT(CASE NVL(TRIM(ERRORCODE),''0'') WHEN ''0'' THEN 1 ELSE NULL END),0),
               SENDTYPE,
               MOBILEAREA,
               BATCHID,
               AREACODE,
			   TMPLID,
			   CHGRADE,
			   MSGTYPE
               FROM GW_MT_TASK_BAK
               WHERE  SENDTIME >=  '|| 'TO_DATE(TO_CHAR(SYSDATE-'||CURPROCESSFLAG||',''YYYY-MM-DD''),''YYYY-MM-DD HH24:MI:SS '') '|| ' AND SENDTIME < '|| 'TO_DATE(TO_CHAR(SYSDATE,''YYYY-MM-DD''),''YYYY-MM-DD HH24:MI:SS '')' ||'
               GROUP BY USERID,TASKID,SPGATE,UNICOM,SPID,SVRTYPE';
                 IF ISP1=1 THEN
                  STR:=STR||',P1';
                 END IF;
                IF ISP2=1 THEN
                  STR:=STR||',P2';
                 END IF;
                IF ISP3=1 THEN
                  STR:=STR||',P3';
                 END IF;
                 IF ISP4=1 THEN
                  STR:=STR||',P4';
                 END IF;
               STR:=STR||',SENDTYPE,MOBILEAREA,BATCHID,AREACODE,TMPLID,CHGRADE,MSGTYPE,
               TO_NUMBER(TO_CHAR(SENDTIME,''YYYYMMDD'')),
               TO_NUMBER(TO_CHAR(SENDTIME,''YYYY'')),
               TO_NUMBER(TO_CHAR(SENDTIME,''MM'')),
               TO_NUMBER(TO_CHAR(SENDTIME,''HH24''))';
        -- DBMS_OUTPUT.PUT_LINE(STR);

 EXECUTE IMMEDIATE STR;
       --SELECT MIN(),MAX() INTO  FROM TMEP_STATISTICS 
 --插入或更新统计表
       STR:='DELETE FROM MT_DATAREPORT WHERE EXISTS (SELECT IYMD FROM '||TABLENAME||' A WHERE A.IYMD=MT_DATAREPORT.IYMD)';
      -- EXECUTE IMMEDIATE STR;
       
       --STR:='DELETE FROM MT_DATAREPORT WHERE IYMD BETWEEN CAST(TO_CHAR(SYSDATE-'||PROCESSFLAG||',''YYYYMMDD'') AS INT) AND CAST(TO_CHAR(SYSDATE,''YYYYMMDD'') AS INT)' ;
       EXECUTE IMMEDIATE STR;

       STR:='INSERT INTO MT_DATAREPORT M
       (USERID,TASKID,SPGATE,SPISUNCM,SPID,SVRTYPE,P1,P2,P3,P4,IYMD,IHOUR,IMONTH,Y,ICOUNT,RSUCC,RFAIL1,RFAIL2,RNRET,SENDTYPE,MOBILEAREA,BATCHID,AREACODE,TMPLID,CHGRADE,MSGTYPE)
       SELECT T.USERID,T.TASKID,T.SPGATE,T.SPISUNCM,T.SPID,T.SVRTYPE,T.P1,T.P2,T.P3,T.P4,T.IYMD,T.IHOUR,T.IMONTH,T.IYEAR,T.ICOUNT,T.SUCC,T.FAIL,
       (T.ICOUNT-T.SUCC-T.FAIL-T.NRET),T.NRET,T.SENDTYPE,T.MOBILEAREA,T.BATCHID,T.AREACODE,T.TMPLID,T.CHGRADE,T.MSGTYPE FROM '|| TABLENAME ||'  T';

--DBMS_OUTPUT.PUT_LINE(STR);
 EXECUTE IMMEDIATE STR;

 EXECUTE IMMEDIATE  'DROP TABLE '||TABLENAME;
 COMMIT;

END ;
/


CREATE OR REPLACE PROCEDURE GW_H_TRANSFERV1(MININDEX IN NUMBER,
                                     MAXINDEX IN NUMBER,
                                     PROCESSFLAG IN NUMBER,
                                     LOTSIZE IN NUMBER) IS
PISTR VARCHAR2(4000);
PITABLENAME VARCHAR2(20);
MINYM NUMBER;
MAXYM NUMBER;
CURYM NUMBER;
BEGIN
  --------------------VER 3.1-------------------------------------
   SELECT CAST(TO_CHAR(MAX(SENDTIME),'YYYYMM')AS INT),CAST(TO_CHAR(MIN(SENDTIME),'YYYYMM')AS INT) INTO MAXYM,MINYM FROM GW_MT_TASK_BAK WHERE ID BETWEEN MININDEX AND MAXINDEX;

   CURYM := MINYM;
   WHILE CURYM<=MAXYM LOOP
      PITABLENAME := 'MTTASK'||CAST(CURYM AS CHAR);

      PISTR:= 'INSERT INTO '||PITABLENAME||' NOLOGGING (ID,MDAY,USERID,SPGATE,CPNO,PHONE,SPMSGID,RETFLAG,FEEFLAG,PKNUMBER,
      PKTOTAL,SENDSTATUS,SENDFLAG,RECVFLAG,DONEDATE,ERRORCODE,SENDLEVEL,SENDTYPE,UNICOM,SENDTIME,RECVTIME,MESSAGE,TASKID,
      ECID,PTMSGID,MOBILEAREA,SPID,SVRTYPE,P1,P2,P3,P4,USERMSGID,MODULEID,ATTIME,VALIDTIME,BATCHID,AREACODE,CUSTID,EXDATA,LONGMSG,TMPLID,CHGRADE,MSGTYPE,RMSVALIDTM,RMSRPTFLAG,PROTOCOLVER,TMPLTYPE,TITLE,SHOWAY,DLDWAY,DLDNEY,ISFREE,SHOWTIME)
      SELECT ID,TO_NUMBER(TO_CHAR(M.SENDTIME,''DD'')),USERID,SPGATE,CPNO,PHONE,SPMSGID,RETFLAG,FEEFLAG,PKNUMBER,PKTOTAL,
      SENDSTATUS,SENDFLAG,RECVFLAG,DONEDATE,ERRORCODE,SENDLEVEL,SENDTYPE,UNICOM,SENDTIME,RECVTIME,MESSAGE,TASKID,ECID,
      PTMSGID,MOBILEAREA,SPID,SVRTYPE,P1,P2,P3,P4,USERMSGID,MODULEID,ATTIME,VALIDTIME,BATCHID,AREACODE,CUSTID,EXDATA,LONGMSG,TMPLID,CHGRADE,MSGTYPE,RMSVALIDTM,RMSRPTFLAG,PROTOCOLVER,TMPLTYPE,TITLE,SHOWAY,DLDWAY,DLDNEY,ISFREE,SHOWTIME
      FROM GW_MT_TASK_BAK M
      WHERE CAST(TO_CHAR(SENDTIME,''YYYYMM'')AS INT) ='||CURYM||' AND (M.ID <='||MAXINDEX||') ';
      --DBMS_OUTPUT.PUT_LINE(PISTR);
      EXECUTE IMMEDIATE PISTR;

      IF CAST(SUBSTR(CAST(CURYM AS CHAR),5,2) AS INT)=12 THEN
        CURYM := CAST(CAST(CAST(SUBSTR(CAST(CURYM AS CHAR),1,4)AS INT)+1 AS CHAR)||'01' AS INT);
      ELSE
        CURYM := CURYM+1;
      END IF;
   END LOOP;
END GW_H_TRANSFERV1;

/


CREATE OR REPLACE PROCEDURE GW_RD_MTLVLQUEV1
(
  PIDESTUID      IN NUMBER,
  PISENDLEVEL    IN NUMBER,
  PIMAXREADCNT   IN NUMBER,
  PISTRUID       IN VARCHAR2,
  SPCURTIME      IN NUMBER DEFAULT 0,
  PITABLENO      IN NUMBER,
  OUT_CURSOR     OUT SYS_REFCURSOR
  )
AS
  PISQLSTR VARCHAR2(4000);
BEGIN
  PISQLSTR :=
  'SELECT /*+RULE*/ ID,"UID",DESTUID,LOGINUID,ECID,TASKID,FEEFLAG,USERID,SPGATE,CPNO,PHONE,PTMSGID,'
  ||'RETFLAG,TPUDHI,PKNUMBER,PKTOTAL,SENDSTATUS,PHONECOUNT,SPLITFLAG,SENDLEVEL,LONGMSGSEQ,MSGFMT,MESSAGE,'
  ||'TO_DATE(TO_CHAR(SENDTIME, ''YYYY-MM-DD HH24:MI:SS''),''YYYY-MM-DD HH24:MI:SS'') AS RECVMTTIME, '
  ||'SVRTYPE,P1,P2,P3,P4,USERMSGID,MODULEID,ATTIME,VALIDTIME,SENDTYPE,BATCHID,AREACODE,CUSTID,EXDATA,LONGMSG,TMPLID,CHGRADE,MSGTYPE,RMSVALIDTM,PROTOCOLVER,TMPLTYPE,TITLE,SHOWAY,DLDWAY,DLDNEY,ISFREE,SHOWTIME '
  ||'FROM MT_LEVEL'||PITABLENO||'_QUEUE WHERE DESTUID='||PIDESTUID||' AND "UID" NOT IN('||PISTRUID||') 
  AND SENDLEVEL='||PISENDLEVEL ||'AND (ATTIME<='||SPCURTIME||'OR ATTIME<0) AND ROWNUM<='||PIMAXREADCNT||'';
  --DBMS_OUTPUT.PUT_LINE(PISQLSTR);
  --EXECUTE IMMEDIATE PISQLSTR;
  --返回给上层数据
  OPEN OUT_CURSOR FOR PISQLSTR;
END;
/


CREATE OR REPLACE PROCEDURE GW_WR_MTTASKV3
 (
    PIUID          IN NUMBER,
    PIPTMSGID      IN NUMBER,
    PISENDSTATUS   IN NUMBER,
    PIRETFLAG      IN NUMBER,
    PIPKTOTAL      IN NUMBER,
    PIPHONECOUNT   IN NUMBER,
    PISPLITLEN_P   IN NUMBER,
    PIMULTILEN1_P  IN NUMBER,
    PIMULTILEN2_P  IN NUMBER,
    PISIGNLEN_P    IN NUMBER,
    PIECID         IN NUMBER,
    PIUSERID       IN VARCHAR2,
    PISPGATE       IN VARCHAR2,
    PICPNO         IN VARCHAR2,
    PIRECVMTTIME   IN VARCHAR2,
    PIMESSAGE      IN VARCHAR2,
    PISHOUJI       IN VARCHAR2,
    PIFEEFLAG      IN NUMBER,
    PISENDLEVEL    IN NUMBER,
    PITASKID       IN NUMBER,
    PIERCODE       IN VARCHAR2,
    PITPUDHI       IN NUMBER,
    PILONGMSGSEQ   IN NUMBER,
    PIMSGFMT       IN NUMBER,
    PIUNICOM       IN NUMBER,
    PIMOBILEAREA   IN NUMBER,
    PIPKNUMBER     IN NUMBER,
    PISVRTYPE      IN VARCHAR2,
    PIP1      IN VARCHAR2,
    PIP2      IN VARCHAR2,
    PIP3      IN VARCHAR2,
    PIP4      IN VARCHAR2,
    PIUSERMSGID    IN NUMBER DEFAULT 0,
    PIMODULEID     IN NUMBER DEFAULT 0,
    PIATTIME       IN NUMBER DEFAULT 0,
    PIVALIDTIME    IN NUMBER DEFAULT 0,
    PISENDTYPE     IN NUMBER DEFAULT 1,
    PIBATCHID      IN NUMBER DEFAULT 0,
    PIAREACODE     IN NUMBER DEFAULT 0,
    PICUSTID       IN VARCHAR2,
    PIEXDATA       IN VARCHAR2,
	PILONGMSG 	   IN VARCHAR2,
	PITMPLID	   IN NUMBER,
	PICHGRADE	   IN NUMBER,
	PIMSGTYPE	   IN NUMBER,
	PIRMSVALIDTM   IN NUMBER,
	PIRMSRPTFLAG   IN NUMBER,
	PIPROTOCOLVER  IN NUMBER,
    PITMPLTYPE	  IN NUMBER,
    PITITLE        IN VARCHAR2,
    PISHOWAY       IN VARCHAR2,
    PIDLDWAY       IN NUMBER,
    PIDLDNEY       IN NUMBER,
    PIISFREE       IN NUMBER,
    PISHOWTIME     IN NUMBER
 )
AS
--临时变量
PITMPMSGID NUMBER(22,0);
PILOCATION PLS_INTEGER;
PISTART PLS_INTEGER;
PIRESULTPHONE VARCHAR(21);
PISTRSPLIT VARCHAR(2);
PILEN PLS_INTEGER;
PIRESULTMSG VARCHAR(720);
PIPKNUM PLS_INTEGER;
PITMPNUM PLS_INTEGER;
ICOUNT PLS_INTEGER;
PISHOUJI_P VARCHAR2(3500);
PIRECVMTTIME_P TIMESTAMP(6);
PIPTMSGID_P NUMBER(22,0);

PISPLITLEN PLS_INTEGER;
PIMULTILEN1 PLS_INTEGER;
PIMULTILEN2 PLS_INTEGER;
PISIGNLEN PLS_INTEGER;

BEGIN
--变量赋值
PILEN := LENGTH(PILONGMSG)-PISIGNLEN_P;
PITMPNUM := 0;
PIPKNUM := 1;
PISTRSPLIT := ',';
PISHOUJI_P :=PISHOUJI;
PIPTMSGID_P:=PIPTMSGID;


IF PIRECVMTTIME IS NULL THEN
   PIRECVMTTIME_P:=SYSTIMESTAMP;
ELSE
   PIRECVMTTIME_P:=TO_TIMESTAMP(PIRECVMTTIME,'YYYY-MM-DD HH24:MI:SS.FF');
END IF;
--清空临时表,如果临时表不存在直接返回不处理
/*SELECT  COUNT(*) INTO ICOUNT FROM USER_TABLES T WHERE UPPER(T.TABLE_NAME)=UPPER('TMP_MTTASK');
IF ICOUNT>0 THEN
    EXECUTE IMMEDIATE 'TRUNCATE TABLE TMP_MTTASK';
ELSE
  RETURN;
END IF;
*/
--验证手机号合法性
IF (PISHOUJI_P IS NULL) THEN
  PISHOUJI_P := ' ';
END IF;
IF /*(PISHOUJI_P IS NULL) OR */(PIPHONECOUNT < 1) THEN
   RETURN;
END IF;

--变量赋值
IF PIMSGFMT=4 OR PIMSGFMT=248 OR PIMSGFMT=246 THEN
  PISPLITLEN:=140;
  PIMULTILEN1:=134;
  PIMULTILEN2:=134;
  PISIGNLEN:=0;
ELSE
  PISPLITLEN  :=PISPLITLEN_P;
  PIMULTILEN1 :=PIMULTILEN1_P;
  PIMULTILEN2 :=PIMULTILEN2_P;
  PISIGNLEN   :=PISIGNLEN_P;
END IF;
IF PIMSGFMT=25 THEN
  SELECT COUNT(PTMSGID) INTO ICOUNT FROM GW_MT_TASK_BAK WHERE PTMSGID=PIPTMSGID_P;
  IF ICOUNT<1 THEN
    INSERT INTO GW_MT_TASK_BAK("UID",USERID,SPGATE,CPNO,PHONE,PTMSGID,MESSAGE,SENDSTATUS,
    RETFLAG,PKNUMBER,PKTOTAL,RECVMTTIME,ECID,FEEFLAG,SENDLEVEL,TASKID,ERRORCODE,TPUDHI,LONGMSGSEQ,MSGFMT,
    UNICOM,MOBILEAREA,SVRTYPE,P1,P2,P3,P4,USERMSGID,MODULEID,ATTIME,VALIDTIME,SENDTYPE,BATCHID,AREACODE,CUSTID,EXDATA,LONGMSG,TMPLID,CHGRADE,MSGTYPE,RMSVALIDTM,RMSRPTFLAG,PROTOCOLVER,TMPLTYPE,TITLE,SHOWAY,DLDWAY,DLDNEY,ISFREE,SHOWTIME)
    VALUES(PIUID,PIUSERID,PISPGATE,PICPNO,PISHOUJI_P,PIPTMSGID_P,NVL(PIMESSAGE,' '),PISENDSTATUS,
    PIRETFLAG,PIPKNUMBER,PIPKTOTAL,PIRECVMTTIME_P,PIECID,PIFEEFLAG,PISENDLEVEL,PITASKID,PIERCODE,PITPUDHI,PILONGMSGSEQ,
    PIMSGFMT,PIUNICOM,PIMOBILEAREA,PISVRTYPE,PIP1,PIP2,PIP3,PIP4,PIUSERMSGID,PIMODULEID,PIATTIME,PIVALIDTIME,PISENDTYPE,PIBATCHID,PIAREACODE,PICUSTID,PIEXDATA,PILONGMSG,PITMPLID,PICHGRADE,PIMSGTYPE,PIRMSVALIDTM,PIRMSRPTFLAG,PIPROTOCOLVER,PITMPLTYPE,PITITLE,PISHOWAY,PIDLDWAY,PIDLDNEY,PIISFREE,PISHOWTIME);
  END IF;
  RETURN;
END IF;
IF PIPHONECOUNT = 1 --单发
THEN
 SELECT COUNT(PTMSGID) INTO ICOUNT FROM GW_MT_TASK_BAK WHERE PTMSGID=PIPTMSGID_P;
  --IF NOT EXISTS(SELECT PTMSGID FROM MT_TASK WHERE PTMSGID = PIPTMSGID_P)
  IF ICOUNT<1 THEN
    IF PIPKTOTAL = 1 THEN
      INSERT INTO GW_MT_TASK_BAK("UID",USERID,SPGATE,CPNO,PHONE,PTMSGID,MESSAGE,SENDSTATUS,
      RETFLAG,PKNUMBER,PKTOTAL,RECVMTTIME,ECID,FEEFLAG,SENDLEVEL,TASKID,ERRORCODE,TPUDHI,LONGMSGSEQ,MSGFMT,
      UNICOM,MOBILEAREA,SVRTYPE,P1,P2,P3,P4,USERMSGID,MODULEID,ATTIME,VALIDTIME,SENDTYPE,BATCHID,AREACODE,CUSTID,EXDATA,LONGMSG,TMPLID,CHGRADE,MSGTYPE,RMSVALIDTM,RMSRPTFLAG,PROTOCOLVER,TMPLTYPE,TITLE,SHOWAY,DLDWAY,DLDNEY,ISFREE,SHOWTIME)
      VALUES(PIUID,PIUSERID,PISPGATE,PICPNO,PISHOUJI_P,PIPTMSGID_P,NVL(PIMESSAGE,' '),PISENDSTATUS,
      PIRETFLAG,PIPKTOTAL,PIPKTOTAL,PIRECVMTTIME_P,PIECID,PIFEEFLAG,PISENDLEVEL,PITASKID,PIERCODE,PITPUDHI,PILONGMSGSEQ,
      PIMSGFMT,PIUNICOM,PIMOBILEAREA,PISVRTYPE,PIP1,PIP2,PIP3,PIP4,PIUSERMSGID,PIMODULEID,PIATTIME,PIVALIDTIME,PISENDTYPE,PIBATCHID,PIAREACODE,PICUSTID,PIEXDATA,PILONGMSG,PITMPLID,PICHGRADE,PIMSGTYPE,PIRMSVALIDTM,PIRMSRPTFLAG,PIPROTOCOLVER,PITMPLTYPE,PITITLE,PISHOWAY,PIDLDWAY,PIDLDNEY,PIISFREE,PISHOWTIME);
    ELSE
      PIPKNUM := 1;
      PITMPMSGID := PIPTMSGID_P;
      IF PIPKTOTAL = 2 AND PILEN <= PIMULTILEN1 THEN
        PIRESULTMSG := SUBSTR(PIMESSAGE,1,PISPLITLEN);
        PITMPMSGID := PITMPMSGID;
        ICOUNT:=0;
        SELECT COUNT(PTMSGID) INTO ICOUNT FROM GW_MT_TASK_BAK WHERE PTMSGID=PITMPMSGID;
        IF ICOUNT<1 THEN
          INSERT INTO TMP_MTTASK("UID",USERID,SPGATE,CPNO,PHONE,PTMSGID,MESSAGE,SENDSTATUS,
          RETFLAG,PKNUMBER,PKTOTAL,RECVMTTIME,ECID,FEEFLAG,SENDLEVEL,TASKID,ERRORCODE,TPUDHI,LONGMSGSEQ,MSGFMT,
          UNICOM,MOBILEAREA,SVRTYPE,P1,P2,P3,P4,USERMSGID,MODULEID,ATTIME,VALIDTIME,SENDTYPE)
          VALUES(PIUID, PIUSERID,PISPGATE,PICPNO,PISHOUJI_P,PITMPMSGID,PIRESULTMSG,PISENDSTATUS,
          PIRETFLAG,PIPKNUM,PIPKTOTAL,PIRECVMTTIME_P,PIECID,PIFEEFLAG,PISENDLEVEL,PITASKID,PIERCODE,PITPUDHI,PILONGMSGSEQ,
          PIMSGFMT,PIUNICOM,PIMOBILEAREA,PISVRTYPE,PIP1,PIP2,PIP3,PIP4,PIUSERMSGID,PIMODULEID,PIATTIME,PIVALIDTIME,PISENDTYPE);
        END IF;
        PIRESULTMSG := SUBSTR(PIMESSAGE,PISPLITLEN+1, PILEN-PISPLITLEN+PISIGNLEN);
        PITMPMSGID := PITMPMSGID+17179869184;
        PIPKNUM := PIPKNUM+1;
        ICOUNT:=0;
        SELECT COUNT(PTMSGID) INTO ICOUNT FROM GW_MT_TASK_BAK WHERE PTMSGID = PITMPMSGID;
        IF ICOUNT<1 THEN
          INSERT INTO TMP_MTTASK("UID",USERID,SPGATE,CPNO,PHONE,PTMSGID,MESSAGE,SENDSTATUS,
          RETFLAG,PKNUMBER,PKTOTAL,RECVMTTIME,ECID,FEEFLAG,SENDLEVEL,TASKID,ERRORCODE,TPUDHI,LONGMSGSEQ,MSGFMT,
          UNICOM,MOBILEAREA,SVRTYPE,P1,P2,P3,P4,USERMSGID,MODULEID,ATTIME,VALIDTIME,SENDTYPE)
          VALUES(PIUID,PIUSERID,PISPGATE,PICPNO,PISHOUJI_P,PITMPMSGID,PIRESULTMSG,PISENDSTATUS,
          PIRETFLAG,PIPKNUM,PIPKTOTAL,PIRECVMTTIME_P,PIECID,PIFEEFLAG,PISENDLEVEL,PITASKID,PIERCODE,PITPUDHI,PILONGMSGSEQ,
          PIMSGFMT,PIUNICOM,PIMOBILEAREA,PISVRTYPE,PIP1,PIP2,PIP3,PIP4,PIUSERMSGID,PIMODULEID,PIATTIME,PIVALIDTIME,PISENDTYPE);
        END IF;
      ELSE
        WHILE PIPKNUM <= PIPKTOTAL LOOP
          IF PIPKNUM = PIPKTOTAL THEN
             PIRESULTMSG := SUBSTR(PIMESSAGE,PITMPNUM+1, PIMULTILEN2+PISIGNLEN);
             PITMPMSGID := PIPTMSGID_P+(PIPKNUM-1)*17179869184;
          ELSIF PIPKNUM = PIPKTOTAL-1 THEN
            IF ((PILEN-(PIPKNUM-1)*PIMULTILEN1) > PIMULTILEN2) AND ((PILEN-(PIPKNUM-1)*PIMULTILEN1) <= PIMULTILEN1) THEN
               PIRESULTMSG := SUBSTR(PIMESSAGE,(PIPKNUM-1)*PIMULTILEN1+1, PILEN-(PIPKNUM-1)*PIMULTILEN1-1);
               PITMPNUM := PILEN-1;
               --DBMS_OUTPUT.PUT_LINE('123');
            ELSE
               PIRESULTMSG := SUBSTR(PIMESSAGE,(PIPKNUM-1)*PIMULTILEN1+1, PIMULTILEN1);
               DBMS_OUTPUT.PUT_LINE(PIRESULTMSG);
               PITMPNUM := (PIPKNUM-1)*PIMULTILEN1+PIMULTILEN1;
               --DBMS_OUTPUT.PUT_LINE('456');
            END IF;
            PITMPMSGID := PIPTMSGID_P+(PIPKNUM-1)*17179869184;
          ELSE
               PIRESULTMSG := SUBSTR(PIMESSAGE,(PIPKNUM-1)*PIMULTILEN1+1, PIMULTILEN1);
               PITMPMSGID := PIPTMSGID_P+(PIPKNUM-1)*17179869184;
               --DBMS_OUTPUT.PUT_LINE(PIRESULTMSG);
          END IF;
          ICOUNT:=0;
          SELECT COUNT(PTMSGID) INTO ICOUNT FROM GW_MT_TASK_BAK WHERE PTMSGID = PITMPMSGID;
          IF ICOUNT<1 THEN
            INSERT INTO TMP_MTTASK("UID",USERID,SPGATE,CPNO,PHONE,PTMSGID,MESSAGE,SENDSTATUS,
            RETFLAG,PKNUMBER,PKTOTAL,RECVMTTIME,ECID,FEEFLAG,SENDLEVEL,TASKID,ERRORCODE,TPUDHI,LONGMSGSEQ,MSGFMT,
            UNICOM,MOBILEAREA,SVRTYPE,P1,P2,P3,P4,USERMSGID,MODULEID,ATTIME,VALIDTIME,SENDTYPE)
            VALUES(PIUID,PIUSERID,PISPGATE,PICPNO,PISHOUJI_P,PITMPMSGID,PIRESULTMSG,PISENDSTATUS,
            PIRETFLAG,PIPKNUM,PIPKTOTAL,PIRECVMTTIME_P,PIECID,PIFEEFLAG,PISENDLEVEL,PITASKID,PIERCODE,PITPUDHI,PILONGMSGSEQ,
            PIMSGFMT,PIUNICOM,PIMOBILEAREA,PISVRTYPE,PIP1,PIP2,PIP3,PIP4,PIUSERMSGID,PIMODULEID,PIATTIME,PIVALIDTIME,PISENDTYPE);
          END IF;--END IF OF IF NOT EXISTS(SELECT PTMSGID FROM MT_TASK WHERE PTMSGID = PITMPMSGID)
          --EXECUTE IMMEDIATE STR;
          PIPKNUM := PIPKNUM+1;
        END LOOP;--END WHILE OF WHILE PIPKNUM <= PIPKTOTAL
      END IF;--END IF OF IF PIPKTOTAL = 2 AND PILEN <= PIMULTILEN1;
      INSERT INTO GW_MT_TASK_BAK("UID",USERID,SPGATE,CPNO,PHONE,PTMSGID,MESSAGE,SENDSTATUS,
      RETFLAG,PKNUMBER,PKTOTAL,RECVMTTIME,ECID,FEEFLAG,SENDLEVEL,TASKID,ERRORCODE,TPUDHI,LONGMSGSEQ,MSGFMT,
      UNICOM,MOBILEAREA,SVRTYPE,P1,P2,P3,P4,USERMSGID,MODULEID,ATTIME,VALIDTIME,SENDTYPE,BATCHID,AREACODE,CUSTID,EXDATA,LONGMSG,TMPLID,CHGRADE,MSGTYPE,RMSVALIDTM,RMSRPTFLAG,PROTOCOLVER,TMPLTYPE,TITLE,SHOWAY,DLDWAY,DLDNEY,ISFREE,SHOWTIME)
      SELECT A."UID",A.USERID,A.SPGATE,A.CPNO,A.PHONE,A.PTMSGID,NVL(A.MESSAGE,' '),A.SENDSTATUS,A.RETFLAG,
      A.PKNUMBER,A.PKTOTAL,A.RECVMTTIME,A.ECID,A.FEEFLAG,A.SENDLEVEL,A.TASKID,A.ERRORCODE,A.TPUDHI,A.LONGMSGSEQ,
      A.MSGFMT,A.UNICOM,A.MOBILEAREA,A.SVRTYPE,A.P1,A.P2,A.P3,A.P4,A.USERMSGID,A.MODULEID,A.ATTIME,A.VALIDTIME,A.SENDTYPE,PIBATCHID,PIAREACODE,PICUSTID,PIEXDATA,PILONGMSG,PITMPLID,PICHGRADE,PIMSGTYPE,PIRMSVALIDTM,PIRMSRPTFLAG,PIPROTOCOLVER,PITMPLTYPE,PITITLE,PISHOWAY,PIDLDWAY,PIDLDNEY,PIISFREE,PISHOWTIME FROM TMP_MTTASK A;
      COMMIT;
    END IF;--END IF OF IF PIPKTOTAL = 1
  --ELSE  --MSGID存在是写入MSGIDTEST表
  --  INSERT INTO MSGIDTEST(MSGID) VALUES(PIPTMSGID);
  END IF; --END IF OF IF NOT EXISTS(SELECT PTMSGID FROM GW_MT_TASK_BAK WHERE PTMSGID = PIPTMSGID_P)
ELSE --群发
    PISHOUJI_P := PISTRSPLIT||PISHOUJI_P||PISTRSPLIT;
    PILOCATION := INSTR(PISHOUJI_P,PISTRSPLIT);
  IF PIPKTOTAL < 1 THEN--没有短信内容
    RETURN;
  END IF;

  IF PIPKTOTAL >= 1 --需要拆分长短信
  THEN
    WHILE PILOCATION <> 0 LOOP--拆分手机号码
        PISTART := PILOCATION;
        PILOCATION := INSTR(PISHOUJI_P,PISTRSPLIT,PISTART+1);
      IF PILOCATION > 0 THEN
        PIRESULTPHONE := SUBSTR(PISHOUJI_P,PISTART+1,PILOCATION-PISTART-1);--拆分后的字符
        IF (PIRESULTPHONE IS NULL) THEN
          PIRESULTPHONE := ' ';
        END IF;
        PITMPMSGID := PIPTMSGID_P;
        ICOUNT:=0;
        SELECT COUNT(PTMSGID) INTO ICOUNT FROM GW_MT_TASK_BAK WHERE PTMSGID = PITMPMSGID;
        IF ICOUNT<1 THEN
          IF PIPKTOTAL = 1 THEN
            INSERT INTO TMP_MTTASK("UID",USERID,SPGATE,CPNO,PHONE,PTMSGID,MESSAGE,SENDSTATUS,
            RETFLAG,PKNUMBER,PKTOTAL,RECVMTTIME,ECID,FEEFLAG,SENDLEVEL,TASKID,ERRORCODE,TPUDHI,LONGMSGSEQ,MSGFMT,
            UNICOM,MOBILEAREA,SVRTYPE,P1,P2,P3,P4,USERMSGID,MODULEID,ATTIME,VALIDTIME,SENDTYPE)
            VALUES(PIUID,PIUSERID,PISPGATE,PICPNO,PIRESULTPHONE,PITMPMSGID,PIMESSAGE,PISENDSTATUS,
            PIRETFLAG, PIPKTOTAL,PIPKTOTAL,PIRECVMTTIME_P,PIECID,PIFEEFLAG,PISENDLEVEL,PITASKID,PIERCODE,PITPUDHI,PILONGMSGSEQ,
            PIMSGFMT,PIUNICOM,PIMOBILEAREA,PISVRTYPE,PIP1,PIP2,PIP3,PIP4,PIUSERMSGID,PIMODULEID,PIATTIME,PIVALIDTIME,PISENDTYPE);
          ELSE
            PIPKNUM := 1;
            IF PIPKTOTAL = 2 AND PILEN <= PIMULTILEN1 THEN
              PIRESULTMSG := SUBSTR(PIMESSAGE,1, PISPLITLEN);--拆分后的字符
              PITMPMSGID := PITMPMSGID;
              ICOUNT:=0;
              SELECT COUNT(PTMSGID) INTO ICOUNT FROM GW_MT_TASK_BAK WHERE PTMSGID = PITMPMSGID;
              IF ICOUNT<1 THEN
                INSERT INTO TMP_MTTASK("UID",USERID,SPGATE,CPNO,PHONE,PTMSGID,MESSAGE,SENDSTATUS,
                RETFLAG,PKNUMBER,PKTOTAL,RECVMTTIME,ECID,FEEFLAG,SENDLEVEL,TASKID,ERRORCODE,TPUDHI,LONGMSGSEQ,MSGFMT,
                UNICOM,MOBILEAREA,SVRTYPE,P1,P2,P3,P4,USERMSGID,MODULEID,ATTIME,VALIDTIME,SENDTYPE)
                VALUES(PIUID,PIUSERID, PISPGATE,PICPNO,PIRESULTPHONE, PITMPMSGID,PIRESULTMSG,PISENDSTATUS,
                PIRETFLAG, PIPKNUM, PIPKTOTAL,PIRECVMTTIME_P,PIECID,PIFEEFLAG,PISENDLEVEL,PITASKID,PIERCODE,PITPUDHI,PILONGMSGSEQ,
                PIMSGFMT,PIUNICOM,PIMOBILEAREA,PISVRTYPE,PIP1,PIP2,PIP3,PIP4,PIUSERMSGID,PIMODULEID,PIATTIME,PIVALIDTIME,PISENDTYPE);
              END IF;
              PIRESULTMSG := SUBSTR(PIMESSAGE,PISPLITLEN+1, PILEN-PISPLITLEN+PISIGNLEN);
              PITMPMSGID := PITMPMSGID+17179869184;
              PIPKNUM := PIPKNUM+1;
              ICOUNT:=0;
              SELECT COUNT(PTMSGID) INTO ICOUNT FROM GW_MT_TASK_BAK WHERE PTMSGID = PITMPMSGID;
              IF ICOUNT<1 THEN
                INSERT INTO TMP_MTTASK("UID",USERID,SPGATE,CPNO,PHONE,PTMSGID,MESSAGE,SENDSTATUS,
                RETFLAG,PKNUMBER,PKTOTAL,RECVMTTIME,ECID,FEEFLAG,SENDLEVEL,TASKID,ERRORCODE,TPUDHI,LONGMSGSEQ,MSGFMT,
                UNICOM,MOBILEAREA,SVRTYPE,P1,P2,P3,P4,USERMSGID,MODULEID,ATTIME,VALIDTIME,SENDTYPE)
                VALUES(PIUID,PIUSERID,PISPGATE,PICPNO,PIRESULTPHONE,PITMPMSGID,PIRESULTMSG,PISENDSTATUS,
                PIRETFLAG,PIPKNUM,PIPKTOTAL,PIRECVMTTIME_P,PIECID,PIFEEFLAG,PISENDLEVEL,PITASKID,PIERCODE,PITPUDHI,PILONGMSGSEQ,
                PIMSGFMT,PIUNICOM,PIMOBILEAREA,PISVRTYPE,PIP1,PIP2,PIP3,PIP4,PIUSERMSGID,PIMODULEID,PIATTIME,PIVALIDTIME,PISENDTYPE);
              END IF; --END IF OF IF NOT EXISTS(SELECT PTMSGID FROM MT_TASK WHERE PTMSGID = PITMPMSGID)
            ELSE
              WHILE PIPKNUM <= PIPKTOTAL LOOP--PIPKNUM:1    PIPKTOTAL 2
                IF PIPKNUM = PIPKTOTAL THEN
                  PIRESULTMSG := SUBSTR(PIMESSAGE,PITMPNUM+1, PIMULTILEN2+PISIGNLEN);
                  PITMPMSGID := PIPTMSGID_P+(PIPKNUM-1)*17179869184;
                ELSIF PIPKNUM = PIPKTOTAL-1 THEN
                  IF ((PILEN-(PIPKNUM-1)*PIMULTILEN1) > PIMULTILEN2) AND ((PILEN-(PIPKNUM-1)*PIMULTILEN1) <= PIMULTILEN1) THEN
                    PIRESULTMSG := SUBSTR(PIMESSAGE,(PIPKNUM-1)*PIMULTILEN1+1, PILEN-(PIPKNUM-1)*PIMULTILEN1-1);
                    PITMPNUM := PILEN-1;
                  ELSE
                    PIRESULTMSG := SUBSTR(PIMESSAGE,(PIPKNUM-1)*PIMULTILEN1+1, PIMULTILEN1);
                    PITMPNUM := (PIPKNUM-1)*PIMULTILEN1+PIMULTILEN1;
                     ----第一条
                  END IF; --END IF OF PILEN-(PIPKNUM-1)*PIMULTILEN1 > PIMULTILEN2 AND PILEN-(PIPKNUM-1)*PIMULTILEN1 <= PIMULTILEN1
                  PITMPMSGID := PIPTMSGID_P+(PIPKNUM-1)*17179869184;
                ELSE
                  PIRESULTMSG := SUBSTR(PIMESSAGE,(PIPKNUM-1)*PIMULTILEN1+1, PIMULTILEN1);
                  PITMPMSGID := PIPTMSGID_P+(PIPKNUM-1)*17179869184;
                END IF; --END IF OF IF PIPKNUM = PIPKTOTAL
                ICOUNT:=0;
                SELECT COUNT(PTMSGID) INTO ICOUNT FROM GW_MT_TASK_BAK WHERE PTMSGID = PITMPMSGID;
                IF ICOUNT<1 THEN
                  INSERT INTO TMP_MTTASK("UID",USERID,SPGATE,CPNO,PHONE,PTMSGID,MESSAGE,SENDSTATUS,
                  RETFLAG,PKNUMBER,PKTOTAL,RECVMTTIME,ECID,FEEFLAG,SENDLEVEL,TASKID,ERRORCODE,TPUDHI,LONGMSGSEQ,MSGFMT,
                  UNICOM,MOBILEAREA,SVRTYPE,P1,P2,P3,P4,USERMSGID,MODULEID,ATTIME,VALIDTIME,SENDTYPE)
                  VALUES(PIUID,PIUSERID,PISPGATE,PICPNO,PIRESULTPHONE,PITMPMSGID,PIRESULTMSG,PISENDSTATUS,
                  PIRETFLAG,PIPKNUM,PIPKTOTAL,PIRECVMTTIME_P,PIECID,PIFEEFLAG,PISENDLEVEL,PITASKID,PIERCODE,PITPUDHI,PILONGMSGSEQ,
                  PIMSGFMT,PIUNICOM,PIMOBILEAREA,PISVRTYPE,PIP1,PIP2,PIP3,PIP4,PIUSERMSGID,PIMODULEID,PIATTIME,PIVALIDTIME,PISENDTYPE);
                END IF;--END IF OF IF NOT EXISTS(SELECT PTMSGID FROM MT_TASK WHERE PTMSGID = PITMPMSGID)
                PIPKNUM := PIPKNUM+1;
              END LOOP;-- END WHILE OF WHILE PIPKNUM <= PIPKTOTAL
            END IF;--END IF OF IF PIPKTOTAL = 2 AND PILEN <= PIMULTILEN1
          END  IF;--END IF OF IF PIPKTOTAL = 1
        END IF; --END IF OF IF NOT EXISTS(SELECT PTMSGID FROM GW_MT_TASK_BAK WHERE PTMSGID = PITMPMSGID)
        PIPTMSGID_P := PIPTMSGID_P+1;
      END  IF; --END IF OF IF PILOCATION > 0
    END LOOP; --END WHILE OF WHILE PILOCATION <> 0
      INSERT INTO GW_MT_TASK_BAK("UID",USERID,SPGATE,CPNO,PHONE,PTMSGID,MESSAGE,SENDSTATUS,
      RETFLAG,PKNUMBER,PKTOTAL,RECVMTTIME,ECID,FEEFLAG,SENDLEVEL,TASKID,ERRORCODE,TPUDHI,LONGMSGSEQ,MSGFMT,
      UNICOM,MOBILEAREA,SVRTYPE,P1,P2,P3,P4,USERMSGID,MODULEID,ATTIME,VALIDTIME,SENDTYPE,BATCHID,AREACODE,CUSTID,EXDATA,LONGMSG,TMPLID,CHGRADE,MSGTYPE,RMSVALIDTM,RMSRPTFLAG,PROTOCOLVER,TMPLTYPE,TITLE,SHOWAY,DLDWAY,DLDNEY,ISFREE,SHOWTIME)
      SELECT A."UID",A.USERID,A.SPGATE,A.CPNO,A.PHONE,A.PTMSGID,NVL(A.MESSAGE,' '),A.SENDSTATUS,A.RETFLAG,
      A.PKNUMBER,A.PKTOTAL,A.RECVMTTIME,A.ECID,A.FEEFLAG,A.SENDLEVEL,A.TASKID,A.ERRORCODE,A.TPUDHI,A.LONGMSGSEQ,A.MSGFMT,A.UNICOM,
      A.MOBILEAREA,A.SVRTYPE,A.P1,A.P2,A.P3,A.P4,A.USERMSGID,A.MODULEID,A.ATTIME,A.VALIDTIME,A.SENDTYPE,PIBATCHID,PIAREACODE,PICUSTID,PIEXDATA,PILONGMSG,PITMPLID,PICHGRADE,PIMSGTYPE,PIRMSVALIDTM,PIRMSRPTFLAG,PIPROTOCOLVER,PITMPLTYPE,PITITLE,PISHOWAY,PIDLDWAY,PIDLDNEY,PIISFREE,PISHOWTIME FROM TMP_MTTASK A;
      COMMIT;
   END IF; --END IF OF IF PIPKTOTAL >= 1
END IF; --END IF OF IF PIPHONECOUNT = 1 --单发
END;

/

CREATE OR REPLACE PROCEDURE GW_WR_MTTASKSRV3
 (
    PIUID          IN NUMBER,
    PIPTMSGID      IN NUMBER,
    PISENDSTATUS   IN NUMBER,
    PIRETFLAG      IN NUMBER,
    PIPKTOTAL      IN NUMBER,
    PIPHONECOUNT   IN NUMBER,
    PIECID         IN NUMBER,
    PIUSERID       IN VARCHAR2,
    PISPGATE       IN VARCHAR2,
    PICPNO         IN VARCHAR2,
    PIRECVMTTIME   IN VARCHAR2,
    PIMESSAGE      IN VARCHAR2,
    PISHOUJI       IN VARCHAR2,
    PIFEEFLAG      IN NUMBER,
    PIPKNUMBER     IN NUMBER,
    PISENDLEVEL    IN NUMBER,
    PITASKID       IN NUMBER,
    PIERCODE       IN VARCHAR2,
    PITPUDHI       IN NUMBER,
    PILONGMSGSEQ   IN NUMBER,
    PIMSGFMT       IN NUMBER,
    PIUNICOM       IN NUMBER,
    PIMOBILEAREA   IN NUMBER,
    PISVRTYPE      IN VARCHAR2,
    PIP1           IN VARCHAR2,
    PIP2           IN VARCHAR2,
    PIP3           IN VARCHAR2,
    PIP4           IN VARCHAR2,
    PIUSERMSGID    IN NUMBER DEFAULT 0,
    PIMODULEID     IN NUMBER DEFAULT 0,
    PIATTIME       IN NUMBER DEFAULT 0,
    PIVALIDTIME    IN NUMBER DEFAULT 0,
    PISENDTYPE     IN NUMBER DEFAULT 1,
    PIBATCHID      IN NUMBER DEFAULT 0,
    PIAREACODE     IN NUMBER DEFAULT 0,
    PICUSTID       IN VARCHAR2,
    PIEXDATA       IN VARCHAR2,
	PILONGMSG 	   IN VARCHAR2,
	PITMPLID	   IN NUMBER,
	PICHGRADE	   IN NUMBER,
	PIMSGTYPE	   IN NUMBER,
	PIRMSVALIDTM   IN NUMBER,
	PIRMSRPTFLAG   IN NUMBER,
	PIPROTOCOLVER  IN NUMBER,
    PITMPLTYPE	  IN NUMBER,
    PITITLE        IN VARCHAR2,
    PISHOWAY       IN VARCHAR2,
    PIDLDWAY       IN NUMBER,
    PIDLDNEY       IN NUMBER,
    PIISFREE       IN NUMBER,
    PISHOWTIME     IN NUMBER
 )
AS
PILOCATION PLS_INTEGER;
PISTART PLS_INTEGER;
PIRESULTPHONE VARCHAR2(21);
PISTRSPLIT VARCHAR2(2);
PIRECVMTTIME_P TIMESTAMP(6);
ICOUNT PLS_INTEGER;
PISHOUJI_P VARCHAR2(3500);
PIPTMSGID_P NUMBER(22,0);

BEGIN

PISTRSPLIT := ',';
PISHOUJI_P := PISHOUJI;
PIPTMSGID_P:=PIPTMSGID;

IF PIRECVMTTIME IS NULL THEN
   PIRECVMTTIME_P:=SYSTIMESTAMP;
ELSE
   PIRECVMTTIME_P:=TO_TIMESTAMP(PIRECVMTTIME,'YYYY-MM-DD HH24:MI:SS.FF');
END IF;
/*
SELECT  COUNT(*) INTO ICOUNT FROM USER_TABLES T WHERE UPPER(T.TABLE_NAME)=UPPER('TMP_MTTASKSR');
IF ICOUNT>0 THEN
  EXECUTE IMMEDIATE 'TRUNCATE TABLE TMP_MTTASKSR';
ELSE
  RETURN;
END IF;
*/
IF (PISHOUJI_P IS NULL) THEN
   PISHOUJI_P := ' ';
END IF;
IF (PIPHONECOUNT < 1) THEN--手机号码为空
  RETURN;
END IF;

IF PIPHONECOUNT = 1 THEN--单发
  SELECT COUNT(PTMSGID) INTO ICOUNT FROM GW_MT_TASK_BAK WHERE PTMSGID=PIPTMSGID_P;
  IF ICOUNT<1 THEN
    INSERT INTO GW_MT_TASK_BAK("UID",USERID, SPGATE, CPNO, PHONE, PTMSGID, MESSAGE,SENDSTATUS,
    RETFLAG, PKNUMBER, PKTOTAL, RECVMTTIME, ECID, FEEFLAG, SENDLEVEL,TASKID,ERRORCODE,TPUDHI,LONGMSGSEQ,
    MSGFMT,UNICOM,MOBILEAREA,SVRTYPE,P1,P2,P3,P4,USERMSGID,MODULEID,ATTIME,VALIDTIME,SENDTYPE,BATCHID,AREACODE,CUSTID,EXDATA,LONGMSG,TMPLID,CHGRADE,MSGTYPE,RMSVALIDTM,RMSRPTFLAG,PROTOCOLVER,TMPLTYPE,TITLE,SHOWAY,DLDWAY,DLDNEY,ISFREE,SHOWTIME)
    VALUES(PIUID,PIUSERID, PISPGATE, PICPNO, PISHOUJI_P, PIPTMSGID_P, PIMESSAGE,PISENDSTATUS,
    PIRETFLAG, PIPKNUMBER, PIPKTOTAL, PIRECVMTTIME_P, PIECID, PIFEEFLAG, PISENDLEVEL,PITASKID,PIERCODE,PITPUDHI,
    PILONGMSGSEQ,PIMSGFMT,PIUNICOM,PIMOBILEAREA,PISVRTYPE,PIP1,PIP2,PIP3,PIP4,PIUSERMSGID,PIMODULEID,PIATTIME,
    PIVALIDTIME,PISENDTYPE,PIBATCHID,PIAREACODE,PICUSTID,PIEXDATA,PILONGMSG,PITMPLID,PICHGRADE,PIMSGTYPE,PIRMSVALIDTM,PIRMSRPTFLAG,PIPROTOCOLVER,PITMPLTYPE,PITITLE,PISHOWAY,PIDLDWAY,PIDLDNEY,PIISFREE,PISHOWTIME);
  END IF;
ELSE --群发
  PISHOUJI_P := PISTRSPLIT||PISHOUJI_P||PISTRSPLIT;
  PILOCATION := INSTR(PISHOUJI_P,PISTRSPLIT);
  WHILE PILOCATION <> 0 LOOP--拆分手机号码
    PISTART := PILOCATION;
    PILOCATION := INSTR(PISHOUJI_P,PISTRSPLIT,PISTART+1);
    IF PILOCATION > 0 THEN
      PIRESULTPHONE := SUBSTR(PISHOUJI_P,PISTART+1,PILOCATION-PISTART-1);
      IF (PIRESULTPHONE IS NULL) THEN
        PIRESULTPHONE := ' ';
      END IF;
      ICOUNT:=0;
      SELECT COUNT(PTMSGID) INTO ICOUNT FROM GW_MT_TASK_BAK WHERE PTMSGID=PIPTMSGID_P;

      IF ICOUNT<1 THEN
        INSERT INTO TMP_MTTASKSR("UID",USERID, SPGATE, CPNO, PHONE, PTMSGID, MESSAGE,SENDSTATUS,
        RETFLAG, PKNUMBER, PKTOTAL, RECVMTTIME,ECID, FEEFLAG, SENDLEVEL,TASKID,ERRORCODE,TPUDHI,LONGMSGSEQ,
        MSGFMT,UNICOM,MOBILEAREA,SVRTYPE,P1,P2,P3,P4,USERMSGID,MODULEID,ATTIME,VALIDTIME,SENDTYPE)
        VALUES(PIUID,PIUSERID,PISPGATE,PICPNO,PIRESULTPHONE,PIPTMSGID_P,PIMESSAGE,PISENDSTATUS,PIRETFLAG,
        PIPKNUMBER,PIPKTOTAL,PIRECVMTTIME_P,PIECID,PIFEEFLAG,PISENDLEVEL,PITASKID,PIERCODE,PITPUDHI,PILONGMSGSEQ,PIMSGFMT,
        PIUNICOM,PIMOBILEAREA,PISVRTYPE,PIP1,PIP2,PIP3,PIP4,PIUSERMSGID,PIMODULEID,PIATTIME,PIVALIDTIME,PISENDTYPE);
      END IF;
      PIPTMSGID_P := PIPTMSGID_P+1;
    END IF;
  END LOOP;
  INSERT INTO GW_MT_TASK_BAK("UID",USERID, SPGATE, CPNO, PHONE, PTMSGID, MESSAGE,SENDSTATUS, RETFLAG,
  PKNUMBER, PKTOTAL, RECVMTTIME, ECID, FEEFLAG, SENDLEVEL,TASKID,ERRORCODE,TPUDHI,LONGMSGSEQ,MSGFMT,
  UNICOM,MOBILEAREA,SVRTYPE,P1,P2,P3,P4,USERMSGID,MODULEID,ATTIME,VALIDTIME,SENDTYPE,BATCHID,AREACODE,CUSTID,EXDATA,LONGMSG,TMPLID,CHGRADE,MSGTYPE,RMSVALIDTM,RMSRPTFLAG,PROTOCOLVER,TMPLTYPE,TITLE,SHOWAY,DLDWAY,DLDNEY,ISFREE,SHOWTIME)
  SELECT A."UID",A.USERID,A.SPGATE,A.CPNO,A.PHONE,A.PTMSGID,A.MESSAGE,A.SENDSTATUS,A.RETFLAG,
  A.PKNUMBER,A.PKTOTAL,A.RECVMTTIME,A.ECID,A.FEEFLAG,A.SENDLEVEL,A.TASKID,A.ERRORCODE,A.TPUDHI,A.LONGMSGSEQ,A.MSGFMT,A.UNICOM,
  A.MOBILEAREA,A.SVRTYPE,A.P1,A.P2,A.P3,A.P4,A.USERMSGID,A.MODULEID,A.ATTIME,A.VALIDTIME,A.SENDTYPE,PIBATCHID,PIAREACODE,PICUSTID,PIEXDATA,PILONGMSG,PITMPLID,PICHGRADE,PIMSGTYPE,PIRMSVALIDTM,PIRMSRPTFLAG,PIPROTOCOLVER,PITMPLTYPE,PITITLE,PISHOWAY,PIDLDWAY,PIDLDNEY,PIISFREE,PISHOWTIME FROM TMP_MTTASKSR A;
  COMMIT;
END IF;
  EXECUTE IMMEDIATE 'TRUNCATE TABLE TMP_MTTASKSR';
END;
/


CREATE OR REPLACE PROCEDURE GW_WR_MTLVLQUEV3
 (
   PIUID        IN NUMBER,
   PIPTMSGID    IN NUMBER,
   PIRETFLAG    IN NUMBER,
   PIPKTOTAL    IN NUMBER,
   PIPHONECOUNT IN NUMBER,
   PISENDSTATUS IN NUMBER,
   PISPLITFLAG  IN NUMBER,
   PIECID       IN NUMBER,
   PIUSERID     IN VARCHAR2,
   PISPGATE     IN VARCHAR2,
   PICPNO       IN VARCHAR2,
   PIRECVMTTIME IN VARCHAR2,
   PIPHONE      IN VARCHAR2,
   PIMESSAGE    IN VARCHAR2,
   PIFEEFLAG    IN NUMBER,
   PIDESTUID    IN NUMBER,
   PILOGINUID   IN NUMBER,
   PIPKNUMBER   IN NUMBER,
   PISENDLEVEL  IN NUMBER,
   PITPUDHI     IN NUMBER,
   PITASKID     IN NUMBER,
   PILONGMSGSEQ IN NUMBER,
   PIMSGFMT     IN NUMBER,
   PITOTALCOUNT IN NUMBER,
   PISVRTYPE      IN VARCHAR2,
   PIP1           IN VARCHAR2,
   PIP2           IN VARCHAR2,
   PIP3           IN VARCHAR2,
   PIP4           IN VARCHAR2,
   PIUSERMSGID    IN NUMBER DEFAULT 0,
   PIMODULEID     IN NUMBER DEFAULT 0,
   PIATTIME       IN NUMBER DEFAULT 0,
   PIVALIDTIME    IN NUMBER DEFAULT 0,
   PISENDTYPE     IN NUMBER DEFAULT 1,
   PIBATCHID      IN NUMBER DEFAULT 0,
   PIAREACODE     IN NUMBER DEFAULT 0,
   PICUSTID       IN MT_LEVEL0_QUEUE.CUSTID%TYPE,
   PIEXDATA       IN MT_LEVEL0_QUEUE.EXDATA%TYPE,
   PILONGMSG 	  IN VARCHAR2,
   PITMPLID	   	  IN NUMBER,
   PICHGRADE	  IN NUMBER,
   PIMSGTYPE	  IN NUMBER,
   PIRMSVALIDTM   IN NUMBER,
   PIPROTOCOLVER  IN NUMBER,
   PITMPLTYPE	  IN NUMBER,
   PITITLE        IN VARCHAR2,
   PISHOWAY       IN VARCHAR2,
   PIDLDWAY       IN NUMBER,
   PIDLDNEY       IN NUMBER,
   PIISFREE       IN NUMBER,
   PISHOWTIME     IN NUMBER,
   PITABLENO   	  IN NUMBER
 )
AS
PIRECVMTTIME_P TIMESTAMP(6);
ICOUNT PLS_INTEGER;
BEGIN
  IF PITABLENO = 0 THEN
  ICOUNT:=0;
  SELECT COUNT(PTMSGID) INTO ICOUNT FROM MT_LEVEL0_QUEUE WHERE PTMSGID = PIPTMSGID;
  IF ICOUNT<1 THEN
    IF (PIRECVMTTIME IS NULL) THEN
       PIRECVMTTIME_P:=SYSTIMESTAMP;
    ELSE
       PIRECVMTTIME_P:=TO_TIMESTAMP(PIRECVMTTIME,'YYYY-MM-DD HH24:MI:SS.FF');
    END IF;
       INSERT INTO /*+APPEND*/ MT_LEVEL0_QUEUE("UID", USERID, SPGATE, CPNO, PHONE, PTMSGID, MESSAGE, RETFLAG, PKTOTAL, TOTALCOUNT,
       PHONECOUNT, SENDTIME, SENDSTATUS, SPLITFLAG, ECID, FEEFLAG,DESTUID,LOGINUID,PKNUMBER,TPUDHI,SENDLEVEL,TASKID,LONGMSGSEQ,
       MSGFMT,SVRTYPE,P1,P2,P3,P4,USERMSGID,MODULEID,ATTIME,VALIDTIME,SENDTYPE,BATCHID,AREACODE,CUSTID,EXDATA,LONGMSG,TMPLID,CHGRADE,MSGTYPE,RMSVALIDTM,PROTOCOLVER,TMPLTYPE,TITLE,SHOWAY,DLDWAY,DLDNEY,ISFREE,SHOWTIME)
       VALUES(PIUID, PIUSERID, PISPGATE, PICPNO, PIPHONE, PIPTMSGID, PIMESSAGE, PIRETFLAG, PIPKTOTAL, PITOTALCOUNT, PIPHONECOUNT,
       PIRECVMTTIME_P, PISENDSTATUS, PISPLITFLAG, PIECID, PIFEEFLAG, PIDESTUID,PILOGINUID,PIPKNUMBER,PITPUDHI,PISENDLEVEL,PITASKID,
       PILONGMSGSEQ,PIMSGFMT,PISVRTYPE,PIP1,PIP2,PIP3,PIP4,PIUSERMSGID,PIMODULEID,PIATTIME,PIVALIDTIME,PISENDTYPE,PIBATCHID,PIAREACODE,PICUSTID,PIEXDATA,PILONGMSG,PITMPLID,PICHGRADE,PIMSGTYPE,PIRMSVALIDTM,PIPROTOCOLVER,PITMPLTYPE,PITITLE,PISHOWAY,PIDLDWAY,PIDLDNEY,PIISFREE,PISHOWTIME);
  END IF;
  ELSIF PITABLENO = 1 THEN
  ICOUNT:=0;
  SELECT COUNT(PTMSGID) INTO ICOUNT FROM MT_LEVEL1_QUEUE WHERE PTMSGID = PIPTMSGID;
  IF ICOUNT<1 THEN
    IF (PIRECVMTTIME IS NULL) THEN
       PIRECVMTTIME_P:=SYSTIMESTAMP;
    ELSE
       PIRECVMTTIME_P:=TO_TIMESTAMP(PIRECVMTTIME,'YYYY-MM-DD HH24:MI:SS.FF');
    END IF;
       INSERT INTO /*+APPEND*/ MT_LEVEL1_QUEUE("UID", USERID, SPGATE, CPNO, PHONE, PTMSGID, MESSAGE, RETFLAG, PKTOTAL, TOTALCOUNT,
       PHONECOUNT, SENDTIME, SENDSTATUS, SPLITFLAG, ECID, FEEFLAG,DESTUID,LOGINUID,PKNUMBER,TPUDHI,SENDLEVEL,TASKID,LONGMSGSEQ,
       MSGFMT,SVRTYPE,P1,P2,P3,P4,USERMSGID,MODULEID,ATTIME,VALIDTIME,SENDTYPE,BATCHID,AREACODE,CUSTID,EXDATA,LONGMSG,TMPLID,CHGRADE,MSGTYPE,RMSVALIDTM,PROTOCOLVER,TMPLTYPE,TITLE,SHOWAY,DLDWAY,DLDNEY,ISFREE,SHOWTIME)
       VALUES(PIUID, PIUSERID, PISPGATE, PICPNO, PIPHONE, PIPTMSGID, PIMESSAGE, PIRETFLAG, PIPKTOTAL, PITOTALCOUNT, PIPHONECOUNT,
       PIRECVMTTIME_P, PISENDSTATUS, PISPLITFLAG, PIECID, PIFEEFLAG, PIDESTUID,PILOGINUID,PIPKNUMBER,PITPUDHI,PISENDLEVEL,PITASKID,
       PILONGMSGSEQ,PIMSGFMT,PISVRTYPE,PIP1,PIP2,PIP3,PIP4,PIUSERMSGID,PIMODULEID,PIATTIME,PIVALIDTIME,PISENDTYPE,PIBATCHID,PIAREACODE,PICUSTID,PIEXDATA,PILONGMSG,PITMPLID,PICHGRADE,PIMSGTYPE,PIRMSVALIDTM,PIPROTOCOLVER,PITMPLTYPE,PITITLE,PISHOWAY,PIDLDWAY,PIDLDNEY,PIISFREE,PISHOWTIME);
  END IF;
  ELSIF PITABLENO = 2 THEN
  ICOUNT:=0;
  SELECT COUNT(PTMSGID) INTO ICOUNT FROM MT_LEVEL2_QUEUE WHERE PTMSGID = PIPTMSGID;
  IF ICOUNT<1 THEN
    IF (PIRECVMTTIME IS NULL) THEN
       PIRECVMTTIME_P:=SYSTIMESTAMP;
    ELSE
       PIRECVMTTIME_P:=TO_TIMESTAMP(PIRECVMTTIME,'YYYY-MM-DD HH24:MI:SS.FF');
    END IF;
       INSERT INTO /*+APPEND*/ MT_LEVEL2_QUEUE("UID", USERID, SPGATE, CPNO, PHONE, PTMSGID, MESSAGE, RETFLAG, PKTOTAL, TOTALCOUNT,
       PHONECOUNT, SENDTIME, SENDSTATUS, SPLITFLAG, ECID, FEEFLAG,DESTUID,LOGINUID,PKNUMBER,TPUDHI,SENDLEVEL,TASKID,LONGMSGSEQ,
       MSGFMT,SVRTYPE,P1,P2,P3,P4,USERMSGID,MODULEID,ATTIME,VALIDTIME,SENDTYPE,BATCHID,AREACODE,CUSTID,EXDATA,LONGMSG,TMPLID,CHGRADE,MSGTYPE,RMSVALIDTM,PROTOCOLVER,TMPLTYPE,TITLE,SHOWAY,DLDWAY,DLDNEY,ISFREE,SHOWTIME)
       VALUES(PIUID, PIUSERID, PISPGATE, PICPNO, PIPHONE, PIPTMSGID, PIMESSAGE, PIRETFLAG, PIPKTOTAL, PITOTALCOUNT, PIPHONECOUNT,
       PIRECVMTTIME_P, PISENDSTATUS, PISPLITFLAG, PIECID, PIFEEFLAG, PIDESTUID,PILOGINUID,PIPKNUMBER,PITPUDHI,PISENDLEVEL,PITASKID,
       PILONGMSGSEQ,PIMSGFMT,PISVRTYPE,PIP1,PIP2,PIP3,PIP4,PIUSERMSGID,PIMODULEID,PIATTIME,PIVALIDTIME,PISENDTYPE,PIBATCHID,PIAREACODE,PICUSTID,PIEXDATA,PILONGMSG,PITMPLID,PICHGRADE,PIMSGTYPE,PIRMSVALIDTM,PIPROTOCOLVER,PITMPLTYPE,PITITLE,PISHOWAY,PIDLDWAY,PIDLDNEY,PIISFREE,PISHOWTIME);
  END IF;
  ELSIF PITABLENO = 3 THEN
  ICOUNT:=0;
  SELECT COUNT(PTMSGID) INTO ICOUNT FROM MT_LEVEL3_QUEUE WHERE PTMSGID = PIPTMSGID;
  IF ICOUNT<1 THEN
    IF (PIRECVMTTIME IS NULL) THEN
       PIRECVMTTIME_P:=SYSTIMESTAMP;
    ELSE
       PIRECVMTTIME_P:=TO_TIMESTAMP(PIRECVMTTIME,'YYYY-MM-DD HH24:MI:SS.FF');
    END IF;
       INSERT INTO /*+APPEND*/ MT_LEVEL3_QUEUE("UID", USERID, SPGATE, CPNO, PHONE, PTMSGID, MESSAGE, RETFLAG, PKTOTAL, TOTALCOUNT,
       PHONECOUNT, SENDTIME, SENDSTATUS, SPLITFLAG, ECID, FEEFLAG,DESTUID,LOGINUID,PKNUMBER,TPUDHI,SENDLEVEL,TASKID,LONGMSGSEQ,
       MSGFMT,SVRTYPE,P1,P2,P3,P4,USERMSGID,MODULEID,ATTIME,VALIDTIME,SENDTYPE,BATCHID,AREACODE,CUSTID,EXDATA,LONGMSG,TMPLID,CHGRADE,MSGTYPE,RMSVALIDTM,PROTOCOLVER,TMPLTYPE,TITLE,SHOWAY,DLDWAY,DLDNEY,ISFREE,SHOWTIME)
       VALUES(PIUID, PIUSERID, PISPGATE, PICPNO, PIPHONE, PIPTMSGID, PIMESSAGE, PIRETFLAG, PIPKTOTAL, PITOTALCOUNT, PIPHONECOUNT,
       PIRECVMTTIME_P, PISENDSTATUS, PISPLITFLAG, PIECID, PIFEEFLAG, PIDESTUID,PILOGINUID,PIPKNUMBER,PITPUDHI,PISENDLEVEL,PITASKID,
       PILONGMSGSEQ,PIMSGFMT,PISVRTYPE,PIP1,PIP2,PIP3,PIP4,PIUSERMSGID,PIMODULEID,PIATTIME,PIVALIDTIME,PISENDTYPE,PIBATCHID,PIAREACODE,PICUSTID,PIEXDATA,PILONGMSG,PITMPLID,PICHGRADE,PIMSGTYPE,PIRMSVALIDTM,PIPROTOCOLVER,PITMPLTYPE,PITITLE,PISHOWAY,PIDLDWAY,PIDLDNEY,PIISFREE,PISHOWTIME);
  END IF;
  ELSIF PITABLENO = 4 THEN
  ICOUNT:=0;
  SELECT COUNT(PTMSGID) INTO ICOUNT FROM MT_LEVEL4_QUEUE WHERE PTMSGID = PIPTMSGID;
  IF ICOUNT<1 THEN
    IF (PIRECVMTTIME IS NULL) THEN
       PIRECVMTTIME_P:=SYSTIMESTAMP;
    ELSE
       PIRECVMTTIME_P:=TO_TIMESTAMP(PIRECVMTTIME,'YYYY-MM-DD HH24:MI:SS.FF');
    END IF;
       INSERT INTO /*+APPEND*/ MT_LEVEL4_QUEUE("UID", USERID, SPGATE, CPNO, PHONE, PTMSGID, MESSAGE, RETFLAG, PKTOTAL, TOTALCOUNT,
       PHONECOUNT, SENDTIME, SENDSTATUS, SPLITFLAG, ECID, FEEFLAG,DESTUID,LOGINUID,PKNUMBER,TPUDHI,SENDLEVEL,TASKID,LONGMSGSEQ,
       MSGFMT,SVRTYPE,P1,P2,P3,P4,USERMSGID,MODULEID,ATTIME,VALIDTIME,SENDTYPE,BATCHID,AREACODE,CUSTID,EXDATA,LONGMSG,TMPLID,CHGRADE,MSGTYPE,RMSVALIDTM,PROTOCOLVER,TMPLTYPE,TITLE,SHOWAY,DLDWAY,DLDNEY,ISFREE,SHOWTIME)
       VALUES(PIUID, PIUSERID, PISPGATE, PICPNO, PIPHONE, PIPTMSGID, PIMESSAGE, PIRETFLAG, PIPKTOTAL, PITOTALCOUNT, PIPHONECOUNT,
       PIRECVMTTIME_P, PISENDSTATUS, PISPLITFLAG, PIECID, PIFEEFLAG, PIDESTUID,PILOGINUID,PIPKNUMBER,PITPUDHI,PISENDLEVEL,PITASKID,
       PILONGMSGSEQ,PIMSGFMT,PISVRTYPE,PIP1,PIP2,PIP3,PIP4,PIUSERMSGID,PIMODULEID,PIATTIME,PIVALIDTIME,PISENDTYPE,PIBATCHID,PIAREACODE,PICUSTID,PIEXDATA,PILONGMSG,PITMPLID,PICHGRADE,PIMSGTYPE,PIRMSVALIDTM,PIPROTOCOLVER,PITMPLTYPE,PITITLE,PISHOWAY,PIDLDWAY,PIDLDNEY,PIISFREE,PISHOWTIME);
  END IF;
  ELSIF PITABLENO = 5 THEN
  ICOUNT:=0;
  SELECT COUNT(PTMSGID) INTO ICOUNT FROM MT_LEVEL5_QUEUE WHERE PTMSGID = PIPTMSGID;
  IF ICOUNT<1 THEN
    IF (PIRECVMTTIME IS NULL) THEN
       PIRECVMTTIME_P:=SYSTIMESTAMP;
    ELSE
       PIRECVMTTIME_P:=TO_TIMESTAMP(PIRECVMTTIME,'YYYY-MM-DD HH24:MI:SS.FF');
    END IF;
       INSERT INTO /*+APPEND*/ MT_LEVEL5_QUEUE("UID", USERID, SPGATE, CPNO, PHONE, PTMSGID, MESSAGE, RETFLAG, PKTOTAL, TOTALCOUNT,
       PHONECOUNT, SENDTIME, SENDSTATUS, SPLITFLAG, ECID, FEEFLAG,DESTUID,LOGINUID,PKNUMBER,TPUDHI,SENDLEVEL,TASKID,LONGMSGSEQ,
       MSGFMT,SVRTYPE,P1,P2,P3,P4,USERMSGID,MODULEID,ATTIME,VALIDTIME,SENDTYPE,BATCHID,AREACODE,CUSTID,EXDATA,LONGMSG,TMPLID,CHGRADE,MSGTYPE,RMSVALIDTM,PROTOCOLVER,TMPLTYPE,TITLE,SHOWAY,DLDWAY,DLDNEY,ISFREE,SHOWTIME)
       VALUES(PIUID, PIUSERID, PISPGATE, PICPNO, PIPHONE, PIPTMSGID, PIMESSAGE, PIRETFLAG, PIPKTOTAL, PITOTALCOUNT, PIPHONECOUNT,
       PIRECVMTTIME_P, PISENDSTATUS, PISPLITFLAG, PIECID, PIFEEFLAG, PIDESTUID,PILOGINUID,PIPKNUMBER,PITPUDHI,PISENDLEVEL,PITASKID,
       PILONGMSGSEQ,PIMSGFMT,PISVRTYPE,PIP1,PIP2,PIP3,PIP4,PIUSERMSGID,PIMODULEID,PIATTIME,PIVALIDTIME,PISENDTYPE,PIBATCHID,PIAREACODE,PICUSTID,PIEXDATA,PILONGMSG,PITMPLID,PICHGRADE,PIMSGTYPE,PIRMSVALIDTM,PIPROTOCOLVER,PITMPLTYPE,PITITLE,PISHOWAY,PIDLDWAY,PIDLDNEY,PIISFREE,PISHOWTIME);
  END IF;
  ELSIF PITABLENO = 6 THEN
  ICOUNT:=0;
  SELECT COUNT(PTMSGID) INTO ICOUNT FROM MT_LEVEL6_QUEUE WHERE PTMSGID = PIPTMSGID;
  IF ICOUNT<1 THEN
    IF (PIRECVMTTIME IS NULL) THEN
       PIRECVMTTIME_P:=SYSTIMESTAMP;
    ELSE
       PIRECVMTTIME_P:=TO_TIMESTAMP(PIRECVMTTIME,'YYYY-MM-DD HH24:MI:SS.FF');
    END IF;
       INSERT INTO /*+APPEND*/ MT_LEVEL6_QUEUE("UID", USERID, SPGATE, CPNO, PHONE, PTMSGID, MESSAGE, RETFLAG, PKTOTAL, TOTALCOUNT,
       PHONECOUNT, SENDTIME, SENDSTATUS, SPLITFLAG, ECID, FEEFLAG,DESTUID,LOGINUID,PKNUMBER,TPUDHI,SENDLEVEL,TASKID,LONGMSGSEQ,
       MSGFMT,SVRTYPE,P1,P2,P3,P4,USERMSGID,MODULEID,ATTIME,VALIDTIME,SENDTYPE,BATCHID,AREACODE,CUSTID,EXDATA,LONGMSG,TMPLID,CHGRADE,MSGTYPE,RMSVALIDTM,PROTOCOLVER,TMPLTYPE,TITLE,SHOWAY,DLDWAY,DLDNEY,ISFREE,SHOWTIME)
       VALUES(PIUID, PIUSERID, PISPGATE, PICPNO, PIPHONE, PIPTMSGID, PIMESSAGE, PIRETFLAG, PIPKTOTAL, PITOTALCOUNT, PIPHONECOUNT,
       PIRECVMTTIME_P, PISENDSTATUS, PISPLITFLAG, PIECID, PIFEEFLAG, PIDESTUID,PILOGINUID,PIPKNUMBER,PITPUDHI,PISENDLEVEL,PITASKID,
       PILONGMSGSEQ,PIMSGFMT,PISVRTYPE,PIP1,PIP2,PIP3,PIP4,PIUSERMSGID,PIMODULEID,PIATTIME,PIVALIDTIME,PISENDTYPE,PIBATCHID,PIAREACODE,PICUSTID,PIEXDATA,PILONGMSG,PITMPLID,PICHGRADE,PIMSGTYPE,PIRMSVALIDTM,PIPROTOCOLVER,PITMPLTYPE,PITITLE,PISHOWAY,PIDLDWAY,PIDLDNEY,PIISFREE,PISHOWTIME);
  END IF;
  ELSIF PITABLENO = 7 THEN
  ICOUNT:=0;
  SELECT COUNT(PTMSGID) INTO ICOUNT FROM MT_LEVEL7_QUEUE WHERE PTMSGID = PIPTMSGID;
  IF ICOUNT<1 THEN
    IF (PIRECVMTTIME IS NULL) THEN
       PIRECVMTTIME_P:=SYSTIMESTAMP;
    ELSE
       PIRECVMTTIME_P:=TO_TIMESTAMP(PIRECVMTTIME,'YYYY-MM-DD HH24:MI:SS.FF');
    END IF;
       INSERT INTO /*+APPEND*/ MT_LEVEL7_QUEUE("UID", USERID, SPGATE, CPNO, PHONE, PTMSGID, MESSAGE, RETFLAG, PKTOTAL, TOTALCOUNT,
       PHONECOUNT, SENDTIME, SENDSTATUS, SPLITFLAG, ECID, FEEFLAG,DESTUID,LOGINUID,PKNUMBER,TPUDHI,SENDLEVEL,TASKID,LONGMSGSEQ,
       MSGFMT,SVRTYPE,P1,P2,P3,P4,USERMSGID,MODULEID,ATTIME,VALIDTIME,SENDTYPE,BATCHID,AREACODE,CUSTID,EXDATA,LONGMSG,TMPLID,CHGRADE,MSGTYPE,RMSVALIDTM,PROTOCOLVER,TMPLTYPE,TITLE,SHOWAY,DLDWAY,DLDNEY,ISFREE,SHOWTIME)
       VALUES(PIUID, PIUSERID, PISPGATE, PICPNO, PIPHONE, PIPTMSGID, PIMESSAGE, PIRETFLAG, PIPKTOTAL, PITOTALCOUNT, PIPHONECOUNT,
       PIRECVMTTIME_P, PISENDSTATUS, PISPLITFLAG, PIECID, PIFEEFLAG, PIDESTUID,PILOGINUID,PIPKNUMBER,PITPUDHI,PISENDLEVEL,PITASKID,
       PILONGMSGSEQ,PIMSGFMT,PISVRTYPE,PIP1,PIP2,PIP3,PIP4,PIUSERMSGID,PIMODULEID,PIATTIME,PIVALIDTIME,PISENDTYPE,PIBATCHID,PIAREACODE,PICUSTID,PIEXDATA,PILONGMSG,PITMPLID,PICHGRADE,PIMSGTYPE,PIRMSVALIDTM,PIPROTOCOLVER,PITMPLTYPE,PITITLE,PISHOWAY,PIDLDWAY,PIDLDNEY,PIISFREE,PISHOWTIME);
  END IF;
  ELSIF PITABLENO = 8 THEN
  ICOUNT:=0;
  SELECT COUNT(PTMSGID) INTO ICOUNT FROM MT_LEVEL8_QUEUE WHERE PTMSGID = PIPTMSGID;
  IF ICOUNT<1 THEN
    IF (PIRECVMTTIME IS NULL) THEN
       PIRECVMTTIME_P:=SYSTIMESTAMP;
    ELSE
       PIRECVMTTIME_P:=TO_TIMESTAMP(PIRECVMTTIME,'YYYY-MM-DD HH24:MI:SS.FF');
    END IF;
       INSERT INTO /*+APPEND*/ MT_LEVEL8_QUEUE("UID", USERID, SPGATE, CPNO, PHONE, PTMSGID, MESSAGE, RETFLAG, PKTOTAL, TOTALCOUNT,
       PHONECOUNT, SENDTIME, SENDSTATUS, SPLITFLAG, ECID, FEEFLAG,DESTUID,LOGINUID,PKNUMBER,TPUDHI,SENDLEVEL,TASKID,LONGMSGSEQ,
       MSGFMT,SVRTYPE,P1,P2,P3,P4,USERMSGID,MODULEID,ATTIME,VALIDTIME,SENDTYPE,BATCHID,AREACODE,CUSTID,EXDATA,LONGMSG,TMPLID,CHGRADE,MSGTYPE,RMSVALIDTM,PROTOCOLVER,TMPLTYPE,TITLE,SHOWAY,DLDWAY,DLDNEY,ISFREE,SHOWTIME)
       VALUES(PIUID, PIUSERID, PISPGATE, PICPNO, PIPHONE, PIPTMSGID, PIMESSAGE, PIRETFLAG, PIPKTOTAL, PITOTALCOUNT, PIPHONECOUNT,
       PIRECVMTTIME_P, PISENDSTATUS, PISPLITFLAG, PIECID, PIFEEFLAG, PIDESTUID,PILOGINUID,PIPKNUMBER,PITPUDHI,PISENDLEVEL,PITASKID,
       PILONGMSGSEQ,PIMSGFMT,PISVRTYPE,PIP1,PIP2,PIP3,PIP4,PIUSERMSGID,PIMODULEID,PIATTIME,PIVALIDTIME,PISENDTYPE,PIBATCHID,PIAREACODE,PICUSTID,PIEXDATA,PILONGMSG,PITMPLID,PICHGRADE,PIMSGTYPE,PIRMSVALIDTM,PIPROTOCOLVER,PITMPLTYPE,PITITLE,PISHOWAY,PIDLDWAY,PIDLDNEY,PIISFREE,PISHOWTIME);
  END IF;
  ELSIF PITABLENO = 9 THEN
  ICOUNT:=0;
  SELECT COUNT(PTMSGID) INTO ICOUNT FROM MT_LEVEL9_QUEUE WHERE PTMSGID = PIPTMSGID;
  IF ICOUNT<1 THEN
    IF (PIRECVMTTIME IS NULL) THEN
       PIRECVMTTIME_P:=SYSTIMESTAMP;
    ELSE
       PIRECVMTTIME_P:=TO_TIMESTAMP(PIRECVMTTIME,'YYYY-MM-DD HH24:MI:SS.FF');
    END IF;
       INSERT INTO /*+APPEND*/ MT_LEVEL9_QUEUE("UID", USERID, SPGATE, CPNO, PHONE, PTMSGID, MESSAGE, RETFLAG, PKTOTAL, TOTALCOUNT,
       PHONECOUNT, SENDTIME, SENDSTATUS, SPLITFLAG, ECID, FEEFLAG,DESTUID,LOGINUID,PKNUMBER,TPUDHI,SENDLEVEL,TASKID,LONGMSGSEQ,
       MSGFMT,SVRTYPE,P1,P2,P3,P4,USERMSGID,MODULEID,ATTIME,VALIDTIME,SENDTYPE,BATCHID,AREACODE,CUSTID,EXDATA,LONGMSG,TMPLID,CHGRADE,MSGTYPE,RMSVALIDTM,PROTOCOLVER,TMPLTYPE,TITLE,SHOWAY,DLDWAY,DLDNEY,ISFREE,SHOWTIME)
       VALUES(PIUID, PIUSERID, PISPGATE, PICPNO, PIPHONE, PIPTMSGID, PIMESSAGE, PIRETFLAG, PIPKTOTAL, PITOTALCOUNT, PIPHONECOUNT,
       PIRECVMTTIME_P, PISENDSTATUS, PISPLITFLAG, PIECID, PIFEEFLAG, PIDESTUID,PILOGINUID,PIPKNUMBER,PITPUDHI,PISENDLEVEL,PITASKID,
       PILONGMSGSEQ,PIMSGFMT,PISVRTYPE,PIP1,PIP2,PIP3,PIP4,PIUSERMSGID,PIMODULEID,PIATTIME,PIVALIDTIME,PISENDTYPE,PIBATCHID,PIAREACODE,PICUSTID,PIEXDATA,PILONGMSG,PITMPLID,PICHGRADE,PIMSGTYPE,PIRMSVALIDTM,PIPROTOCOLVER,PITMPLTYPE,PITITLE,PISHOWAY,PIDLDWAY,PIDLDNEY,PIISFREE,PISHOWTIME);
  END IF;
END IF;
END;
/

declare 
primaryKeyExistedCount number;
num int;  --声明变量存储要查询的表中的列是否存在
begin
    --从系统表中查询表是否存在主键（因一个表只可能有一个主键，所以只需判断约束类型即可）
    select count(1) into primaryKeyExistedCount from user_constraints t where t.table_name = upper('MT_DATAREPORT') and t.constraint_type = 'P';   
  if primaryKeyExistedCount = 1 then
  execute immediate 'ALTER TABLE MT_DATAREPORT DROP CONSTRAINT MT_DATAREPORT_PRIMARY';
  end if;



select count(1) into num from user_ind_columns  where index_name=('IX_MT_DATAREPORT_UNION');
if num =1 then
 execute immediate 'drop index IX_MT_DATAREPORT_UNION';
end if;
if num =0 then
 execute immediate 'create UNIQUE index IX_MT_DATAREPORT_UNION on MT_DATAREPORT(USERID,TASKID,SPGATE,IYMD,IHOUR,SPISUNCM,SPID,SVRTYPE,P1,P2,P3,P4,MOBILEAREA,SENDTYPE,BATCHID,AREACODE,TMPLID,CHGRADE,MSGTYPE)';
end if;
end;
/

DECLARE I INT;
BEGIN
select count('MSGTYPE') INTO I from cols where table_name=upper('MT_TASK_C') and column_name=upper('MSGTYPE');
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE mt_task_c ADD MSGTYPE NUMBER DEFAULT 0 NOT NULL';
END IF;
END;
/  

DECLARE I INT;
BEGIN
select count('VALIDTM') INTO I from cols where table_name=upper('MT_TASK_C') and column_name=upper('VALIDTM');
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE mt_task_c ADD VALIDTM NUMBER DEFAULT 0 NOT NULL';
END IF;
END;
/  

DECLARE I INT;
BEGIN
select count('TMPLID') INTO I from cols where table_name=upper('MT_TASK_C') and column_name=upper('TMPLID');
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE mt_task_c ADD TMPLID NUMBER DEFAULT 0 NOT NULL';
END IF;
END;
/  

DECLARE I INT;
BEGIN
select count('PROTOCOLVER') INTO I from cols where table_name=upper('MT_TASK_C') and column_name=upper('PROTOCOLVER');
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE mt_task_c ADD PROTOCOLVER NUMBER DEFAULT 0 NOT NULL';
END IF;
END;
/  


DECLARE I INT;
BEGIN
select count('TITLE') INTO I from cols where table_name=upper('MT_TASK_C') and column_name=upper('TITLE');
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE mt_task_c ADD TITLE VARCHAR2(40) DEFAULT ('' '') NOT NULL';
END IF;
END;
/  

DECLARE I INT;
BEGIN
select count('SHOWAY') INTO I from cols where table_name=upper('MT_TASK_C') and column_name=upper('SHOWAY');
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE mt_task_c ADD SHOWAY VARCHAR2(16) DEFAULT ('' '') NOT NULL';
END IF;
END;
/  


DECLARE I INT;
BEGIN
select count('DLDWAY') INTO I from cols where table_name=upper('MT_TASK_C') and column_name=upper('DLDWAY');
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE mt_task_c ADD DLDWAY NUMBER DEFAULT 0 NOT NULL';
END IF;
END;
/  


DECLARE I INT;
BEGIN
select count('DLDNEY') INTO I from cols where table_name=upper('MT_TASK_C') and column_name=upper('DLDNEY');
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE mt_task_c ADD DLDNEY NUMBER DEFAULT 0 NOT NULL';
END IF;
END;
/  


DECLARE I INT;
BEGIN
select count('ISFREE') INTO I from cols where table_name=upper('MT_TASK_C') and column_name=upper('ISFREE');
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE mt_task_c ADD ISFREE NUMBER DEFAULT 0 NOT NULL';
END IF;
END;
/  


DECLARE I INT;
BEGIN
select count('SHOWTIME') INTO I from cols where table_name=upper('MT_TASK_C') and column_name=upper('SHOWTIME');
IF I=0 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE mt_task_c ADD SHOWTIME NUMBER DEFAULT 0 NOT NULL';
END IF;
END;
/  

CREATE OR REPLACE PROCEDURE GW_WRMTTASKCV3
 (
  PIUID          IN NUMBER,
  PIPTMSGID      IN NUMBER,
  PISENDSTATUS   IN NUMBER,
  PIRETFLAG      IN NUMBER,
  PIPKNUMBER     IN NUMBER,
  PIPKTOTAL      IN NUMBER,
  PIPHONECOUNT   IN NUMBER,
  PIUSERID       IN VARCHAR2,
  PISPGATE       IN VARCHAR2,
  PICPNO         IN VARCHAR2,
  PIRECVMTTIME   IN VARCHAR2,
  PIPHONE        IN VARCHAR2,
  PIMESSAGE      IN VARCHAR2,
  PITPUDHI       IN NUMBER,
  PILOGINID      IN VARCHAR2,
  PITRANSMTTIME  IN TIMESTAMP,
  PIMSGFMT       IN NUMBER,
  PILONGMSGSEQ   IN NUMBER,
  PIUSERMSGID    IN NUMBER DEFAULT 0,
  PIMODULEID     IN NUMBER DEFAULT 0,
  PISENDLEVEL    IN NUMBER DEFAULT 5,
  PIVALIDTIME    IN NUMBER DEFAULT 0,
  PIUNICOM       IN NUMBER DEFAULT 0,
  PITASKID       IN NUMBER DEFAULT 0,
  PIMOBILEAREA   IN NUMBER DEFAULT 0,
  PINETERRORCNT       IN NUMBER DEFAULT 0,
  PISUBMITERRORCNT   IN NUMBER DEFAULT 0,
  PICUSTID     IN MT_TASK_C.CUSTID%TYPE,
  PIEXDATA    IN MT_TASK_C.EXDATA%TYPE,
  P_MSGTYPE   IN NUMBER DEFAULT 0,
  P_VALIDTM   IN NUMBER DEFAULT 0,
  P_TMPLID   IN NUMBER DEFAULT 0,
  P_PROTOCOLVER   IN NUMBER DEFAULT 0,
  P_TITLE      IN VARCHAR2,
  P_SHOWAY      IN VARCHAR2,
  P_DLDWAY   IN NUMBER DEFAULT 0,
  P_DLDNEY   IN NUMBER DEFAULT 0,
  P_ISFREE   IN NUMBER DEFAULT 0,
  P_SHOWTIME   IN NUMBER DEFAULT 0 
 )
AS
--TO_DATE(NVL(PISENDTIME,' '),'YYYY-MM-DD HH24:MI:SS.FF')
ICOUNT PLS_INTEGER;
PIRECVMTTIME_P TIMESTAMP(6);
BEGIN
  ICOUNT:=0;
  SELECT COUNT(PTMSGID) INTO ICOUNT FROM MT_TASK_C WHERE PTMSGID = PIPTMSGID;
  IF ICOUNT<1 THEN
    IF (PIRECVMTTIME IS NULL) THEN
       PIRECVMTTIME_P:=SYSTIMESTAMP;
    ELSE
       PIRECVMTTIME_P:=TO_TIMESTAMP(PIRECVMTTIME,'YYYY-MM-DD HH24:MI:SS.FF');
    END IF;
    INSERT INTO MT_TASK_C("UID", LOGINID, USERID, SPGATE, CPNO, SHOUJI, PTMSGID, MESSAGE,
    SENDSTATUS, RETFLAG, PKNUMBER, PKTOTAL, SENDTIME, TPUDHI, LONGMSGSEQ,TRANSMTTIME, MSGFMT,USERMSGID,MODULEID,SENDLEVEL,VALIDTIME,UNICOM ,TASKID ,MOBILEAREA,NETERRORCNT,SUBMITERRORCNT,CUSTID,EXDATA,MSGTYPE,VALIDTM,TMPLID,PROTOCOLVER,TITLE,SHOWAY,DLDWAY,DLDNEY,ISFREE,SHOWTIME)
    VALUES(PIUID, PILOGINID,PIUSERID, PISPGATE, PICPNO, PIPHONE, PIPTMSGID, PIMESSAGE,
    PISENDSTATUS, PIRETFLAG, PIPKNUMBER, PIPKTOTAL, PIRECVMTTIME_P, PITPUDHI, PILONGMSGSEQ,PITRANSMTTIME, PIMSGFMT,PIUSERMSGID,PIMODULEID,PISENDLEVEL,PIVALIDTIME,PIUNICOM ,PITASKID ,PIMOBILEAREA ,PINETERRORCNT,PISUBMITERRORCNT,PICUSTID,PIEXDATA,P_MSGTYPE,P_VALIDTM,P_TMPLID,P_PROTOCOLVER,P_TITLE,P_SHOWAY,P_DLDWAY,P_DLDNEY,P_ISFREE,P_SHOWTIME);
  END IF;
END;
/

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='GT_PORT_USED' AND COLUMN_NAME='SIGNSTR';
IF I=1 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE GT_PORT_USED MODIFY (SIGNSTR VARCHAR2(60))';
END IF;
END;
/

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='GT_PORT_USED' AND COLUMN_NAME='ENSIGNSTR';
IF I=1 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE GT_PORT_USED MODIFY (ENSIGNSTR VARCHAR2(60))';
END IF;
END;
/

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='XT_GATE_QUEUE' AND COLUMN_NAME='SIGNSTR';
IF I=1 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE XT_GATE_QUEUE MODIFY (SIGNSTR VARCHAR2(60))';
END IF;
END;
/

DECLARE I INT;
BEGIN
SELECT COUNT(*) INTO I FROM USER_TAB_COLS WHERE TABLE_NAME='XT_GATE_QUEUE' AND COLUMN_NAME='ENSIGNSTR';
IF I=1 THEN
   EXECUTE IMMEDIATE 'ALTER TABLE XT_GATE_QUEUE MODIFY (ENSIGNSTR VARCHAR2(60))';
END IF;
END;
/

CREATE OR REPLACE PROCEDURE GW_MTTASKSUPPV4
(
  PIOLDMSGID IN NUMBER,
  PINEWMSGID  IN NUMBER,
  PISRCUID  IN NUMBER,
  PISRCUSRID  IN VARCHAR2,
  PISRCSPGATE  IN VARCHAR2,
  PISRCSPNUMBER IN  VARCHAR2,
  PIDESTUID  IN NUMBER,
  PIDESTUSRID  IN VARCHAR2,
  PIDESTSPGATE  IN VARCHAR2,
  PIDESTSPNUMBER  IN VARCHAR2,
  PIDESTFEEFLAG  IN NUMBER,
  PISPLITLEN  IN NUMBER,
  PIMULTILEN1  IN NUMBER,
  PIMULTILEN2  IN NUMBER,
  PINEWSIGNLEN  IN NUMBER,
  PIOLDSIGNLEN  IN NUMBER,
  PISIGNATURE  IN VARCHAR2,
  PINEWSIGNPOS IN NUMBER,
  PIOLDSIGNPOS IN NUMBER,
  PIENSPLITLEN IN NUMBER, --英文短信单条长度，小于等于0标识不支持英文短信
  PIENMULTILEN1  IN NUMBER, --英文长短信拆分长度
  PIENMULTILEN2  IN NUMBER, --英文长短信最后一条长度
  PINEWENSIGNLEN  IN NUMBER, --补发英文签名长度
  PIOLDENSIGNLEN  IN NUMBER, --原英文签名长度
  PIENSIGNATURE  IN VARCHAR2, --英文签名
  PIRECVMTTIME  IN VARCHAR2,
  OUT_CURSOR      OUT SYS_REFCURSOR
  )
AS
  PISENDNUM NUMBER(11);
  PIPKTOTAL NUMBER(11);
  PIPKNUM   NUMBER(11);
  PIINITMSGID NUMBER(22);
  PISINGLEMSG VARCHAR2(720);
  PISINGLEMSG1 VARCHAR2(720);
  PILONGMSG VARCHAR2(3000);
  PITOTALCNT NUMBER(11);
  PILONGMSGLEN NUMBER(11);
  PIECID NUMBER(11);
  PIPHONE VARCHAR2(21);
  PISENDLEVEL NUMBER(11);
  PITASKID NUMBER(11);
  --PIRECVMTTIME TIMESTAMP;
  PISRCCPNO  VARCHAR2(21);
  PIDESTCPNO VARCHAR2(21);
  PITPUDHI NUMBER(11);
  PITPPID NUMBER(11);
  PILONGMSGSEQ NUMBER(11);
  PIMSGFMT NUMBER(11);
  PIUNICOM NUMBER(11);
  PIMOBILEAREA NUMBER(11);
  PISVRTYPE VARCHAR2(64);
  PIUSERMSGID NUMBER(22);
  PISENDTYPE NUMBER(11);
  PIP1 VARCHAR2(64);
  PIP2 VARCHAR2(64);
  PIP3 VARCHAR2(64);
  PIP4 VARCHAR2(64);
  PIMODULEID NUMBER(11);
  PIATTIME NUMBER(22);
  PIVALIDTIME NUMBER(22);
  PIBATCHID NUMBER(22);
  PIAREACODE NUMBER(11);
  PICUSTID VARCHAR2(64);
  PIEXDATA VARCHAR2(64);
  
  ICOUNT NUMBER(11);
  PITEMPCNT1 NUMBER(11);
  PITEMPCNT2 NUMBER(11);

  PISPLITLEN_V NUMBER(11);
  PIMULTILEN1_V  NUMBER(11);
  PIMULTILEN2_V  NUMBER(11);
  PINEWSIGNLEN_V  NUMBER(11);
  PIOLDSIGNLEN_V  NUMBER(11);
  PISIGNATURE_V  VARCHAR2(60);
  PIPTMSGID_P  NUMBER(22);
BEGIN

  /*--检查查临时表是否存在,如果存在则清空,不存在直接返回
  SELECT  COUNT(*) INTO ICOUNT FROM USER_TABLES T WHERE UPPER(T.TABLE_NAME)=UPPER('TMP_RDMTTASK');
  IF ICOUNT>0 THEN
    EXECUTE IMMEDIATE 'TRUNCATE TABLE TMP_RDMTTASK';
  ELSE
    RETURN;
  END IF;
  */
  PILONGMSG:='';
  --PIRECVMTTIME:= SYSTIMESTAMP;
  PISRCCPNO:= SUBSTR(PISRCSPNUMBER,LENGTH(PISRCSPGATE)+1,LENGTH(PISRCSPNUMBER)-LENGTH(PISRCSPGATE));
  PIDESTCPNO:= NVL(SUBSTR(PIDESTSPNUMBER,LENGTH(PIDESTSPGATE)+1,LENGTH(PIDESTSPNUMBER)-LENGTH(PIDESTSPGATE)), ' ');
   --取补发帐号的费用
  --SELECT SENDNUM INTO PISENDNUM FROM USERFEE WHERE USERID=PIDESTUSRID;

  --每次调用存储过程时候，先清空TMP_RDMTTASK会话级别的临时表
  EXECUTE IMMEDIATE 'TRUNCATE TABLE TMP_RDMTTASK';

  --该模式可以把原始MSGID返给用户--用旧的MSGID复制一份记录插入临时表
  INSERT INTO TMP_RDMTTASK("UID",PTMSGID,ECID,TASKID,USERID,SPGATE,CPNO,PHONE,
  SPMSGID,RETFLAG,FEEFLAG,PKNUMBER,PKTOTAL,SENDSTATUS,SENDFLAG,RECVFLAG,
  DONEDATE,ERRORCODE,SENDLEVEL,SENDTYPE,UNICOM,RESENDCNT,RECVMTTIME,RECVTIME,
  MESSAGE,TPUDHI,LONGMSGSEQ,MSGFMT,MOBILEAREA,SVRTYPE,TPPID,USERMSGID,
  P1,P2,P3,P4,MODULEID,ATTIME,VALIDTIME,BATCHID,AREACODE,CUSTID,EXDATA)
  SELECT "UID",PTMSGID,ECID,TASKID,USERID,SPGATE,CPNO,PHONE,
  SPMSGID,RETFLAG,FEEFLAG,PKNUMBER,PKTOTAL,2,SENDFLAG,RECVFLAG,
  DONEDATE,ERRORCODE,SENDLEVEL,SENDTYPE,UNICOM,RESENDCNT,RECVMTTIME,RECVTIME,
  MESSAGE,TPUDHI,LONGMSGSEQ,MSGFMT,MOBILEAREA,SVRTYPE,TPPID,USERMSGID,
  P1,P2,P3,P4,MODULEID,ATTIME,VALIDTIME,BATCHID,AREACODE,CUSTID,EXDATA
  FROM GW_MT_TASK_BAK WHERE PTMSGID=PIOLDMSGID AND USERID=PISRCUSRID AND MSGFMT IN (0,8,15) AND RESENDCNT<1 AND INSTR(TRIM(SPGATE)||TRIM(CPNO),PISRCSPNUMBER)=1 ;
  PITEMPCNT1:=NVL(SQL%ROWCOUNT,0);

  IF PITEMPCNT1<=0 THEN
  INSERT INTO TMP_RDMTTASK("UID",PTMSGID,ECID,TASKID,USERID,SPGATE,CPNO,PHONE,
  SPMSGID,RETFLAG,FEEFLAG,PKNUMBER,PKTOTAL,SENDSTATUS,SENDFLAG,RECVFLAG,
  DONEDATE,ERRORCODE,SENDLEVEL,SENDTYPE,UNICOM,RESENDCNT,RECVMTTIME,RECVTIME,
  MESSAGE,TPUDHI,LONGMSGSEQ,MSGFMT,MOBILEAREA,SVRTYPE,TPPID,USERMSGID,
  P1,P2,P3,P4,MODULEID,ATTIME,VALIDTIME,BATCHID,AREACODE,CUSTID,EXDATA)
  SELECT "UID",PTMSGID,ECID,TASKID,USERID,SPGATE,CPNO,PHONE,
  SPMSGID,RETFLAG,FEEFLAG,PKNUMBER,PKTOTAL,2,SENDFLAG,RECVFLAG,
  DONEDATE,ERRORCODE,SENDLEVEL,SENDTYPE,UNICOM,RESENDCNT,RECVMTTIME,RECVTIME,
  MESSAGE,TPUDHI,LONGMSGSEQ,MSGFMT,MOBILEAREA,SVRTYPE,TPPID,USERMSGID,
  P1,P2,P3,P4,MODULEID,ATTIME,VALIDTIME,BATCHID,AREACODE,'',''
  FROM MT_TASK WHERE PTMSGID=PIOLDMSGID AND USERID=PISRCUSRID AND MSGFMT IN (0,8,15) AND RESENDCNT<1 AND INSTR(TRIM(SPGATE)||TRIM(CPNO),PISRCSPNUMBER)=1 ;
  PITEMPCNT1:=NVL(SQL%ROWCOUNT,0);
  END IF;

  DELETE FROM TMP_RDMTTASK WHERE UNICOM=5 AND MSGFMT=0;
  PITEMPCNT2:=NVL(SQL%ROWCOUNT,0);

  IF PITEMPCNT1 - PITEMPCNT2>0 THEN
    SELECT PKTOTAL,PKNUMBER,ECID,PHONE,SENDLEVEL,
        TASKID,TPUDHI,LONGMSGSEQ,MSGFMT,UNICOM,
        MOBILEAREA,SVRTYPE,TPPID,USERMSGID,
        SENDTYPE,P1,P2,P3,P4,MODULEID,ATTIME,VALIDTIME,BATCHID,AREACODE,CUSTID,EXDATA  INTO
        PIPKTOTAL,PIPKNUM,PIECID,PIPHONE,PISENDLEVEL,
        PITASKID,PITPUDHI,PILONGMSGSEQ,PIMSGFMT,PIUNICOM,
        PIMOBILEAREA,PISVRTYPE,PITPPID,PIUSERMSGID,
        PISENDTYPE,PIP1,PIP2,PIP3,PIP4,PIMODULEID,PIATTIME,PIVALIDTIME,PIBATCHID,PIAREACODE,PICUSTID,PIEXDATA
    FROM TMP_RDMTTASK WHERE PTMSGID=PIOLDMSGID;
    --如果原信息内容编码为0且英文签名长度大于等于0 按英文短信处理
     IF (0 = PIMSGFMT AND 0 <= PIOLDENSIGNLEN) THEN
       PIOLDSIGNLEN_V:=PIOLDENSIGNLEN;
     ELSE
       PIOLDSIGNLEN_V:=PIOLDSIGNLEN;
     END IF; --IF (0 == PIMSGFMT AND 0 <= PIOLDENSIGNLEN) THEN
     --如果原信息内容编码为0且补发路由单条长度大于0表示支持英文短信
     IF (0 = PIMSGFMT AND 0 < PIENSPLITLEN) THEN
       PISPLITLEN_V:=PIENSPLITLEN;
       PIMULTILEN1_V:=PIENMULTILEN1;
       PIMULTILEN2_V:=PIENMULTILEN2;
       PINEWSIGNLEN_V:=PINEWENSIGNLEN;
       PISIGNATURE_V:=PIENSIGNATURE;
     ELSE
       PISPLITLEN_V:=PISPLITLEN;
       PIMULTILEN1_V:=PIMULTILEN1;
       PIMULTILEN2_V:=PIMULTILEN2;
       PINEWSIGNLEN_V:=PINEWSIGNLEN;
       PISIGNATURE_V:=PISIGNATURE;
     END IF;

     if (0 = PINEWSIGNLEN_V) THEN
       PISIGNATURE_V:='';
     END IF;

     IF (PIPKTOTAL <= 1 AND ((PIPKTOTAL <= PISENDNUM AND PIDESTFEEFLAG=1) OR PIDESTFEEFLAG=2)) THEN--对于非长短信补发的处理
        PILONGMSG:='';
        --取短信内容
        SELECT MESSAGE INTO PILONGMSG FROM TMP_RDMTTASK WHERE PTMSGID=PIOLDMSGID;
        --更新替换MSGID
        UPDATE GW_MT_TASK_BAK SET RESENDCNT=1 WHERE PTMSGID=PIOLDMSGID;
        UPDATE MT_TASK SET RESENDCNT=1 WHERE PTMSGID=PIOLDMSGID;
        PILONGMSGLEN := LENGTH(PILONGMSG)-PIOLDSIGNLEN_V; --减去签名的净长度

        IF PIOLDSIGNPOS=0 THEN--去掉原短信的签名
          PILONGMSG:=SUBSTR(PILONGMSG,1,PILONGMSGLEN);
        ELSE
          PILONGMSG:=SUBSTR(PILONGMSG,1+PIOLDSIGNLEN_V,PILONGMSGLEN);
        END IF;

        PILONGMSGLEN := LENGTH(PILONGMSG);
        IF PILONGMSGLEN > 0 THEN
          --计算拆分条数
          IF PILONGMSGLEN<=PISPLITLEN_V THEN
          PIPKTOTAL:=1;
          ELSE
          PIPKTOTAL:=TRUNC(1+(PILONGMSGLEN-PIMULTILEN2_V+PIMULTILEN1_V-1)/(PIMULTILEN1_V));
          END IF;--END OF IF PILONGMSGLEN<=PISPLITLEN

          IF PINEWSIGNPOS=0 THEN--增加新的签名
            PILONGMSG := TRIM(PILONGMSG)||PISIGNATURE_V;
          ELSE
            PILONGMSG := PISIGNATURE_V||TRIM(PILONGMSG);
          END IF;

          --调用插入存储过程
          GW_WR_MTTASKV2(PIDESTUID,PINEWMSGID,2,1,PIPKTOTAL,1,
                  PISPLITLEN_V,PIMULTILEN1_V,PIMULTILEN2_V,PINEWSIGNLEN_V,PIECID,
                  PIDESTUSRID,PIDESTSPGATE,PIDESTCPNO,PIRECVMTTIME,PILONGMSG,
                  PIPHONE,PIDESTFEEFLAG,PISENDLEVEL,PITASKID,' ',PITPUDHI,
                  PILONGMSGSEQ,PIMSGFMT,PIUNICOM,PIMOBILEAREA,PIPKNUM,PISVRTYPE,
                  PIP1,PIP2,PIP3,PIP4,PIUSERMSGID,PIMODULEID,PIATTIME,PIVALIDTIME,PISENDTYPE,PIBATCHID,PIAREACODE,PICUSTID,PIEXDATA);
        ELSE
          PILONGMSG:='';
        END IF;--END OF IF PILONGMSGLEN > 0
        PIPKNUM:=1;
    /*
    ELSIF (PIPKTOTAL > 1 AND ((PIPKTOTAL <= PISENDNUM AND PIDESTFEEFLAG=1) OR PIDESTFEEFLAG=2) AND PITPUDHI=1) THEN--对标准协议长短信的补发
      PILONGMSG:='';
      --取短信内容
      SELECT MESSAGE INTO PILONGMSG FROM TMP_RDMTTASK WHERE PTMSGID=PIOLDMSGID;
      --更新替换MSGID
      UPDATE MT_TASK SET PTMSGID=PINEWMSGID,RESENDCNT=1 WHERE PTMSGID=PIOLDMSGID;
      IF (PIPKTOTAL=PIPKNUM)THEN ---如果是最后一条，去掉旧签名，加上新签名
        PILONGMSGLEN := LENGTH(PILONGMSG)-PIOLDSIGNLEN; --减去签名的净长度
        PILONGMSG:=SUBSTR(PILONGMSG,1,PILONGMSGLEN);
        PILONGMSG := PILONGMSG||PISIGNATURE;
      END IF;
      PILONGMSGLEN := LENGTH(PILONGMSG);
      IF PILONGMSGLEN > 0 THEN
        --调用插入存储过程
        GW_WR_MTTASKSRV2(PIDESTUID,PIOLDMSGID,2,1,PIPKTOTAL,1,PIECID,
                PIDESTUSRID,PIDESTSPGATE,PIDESTCPNO,TO_CHAR(PIRECVMTTIME, 'YYYY-MM-DD HH24:MI:SS'),PILONGMSG,
                PIPHONE,PIDESTFEEFLAG,PIPKNUM,PISENDLEVEL,PITASKID,' ',PITPUDHI,
                PILONGMSGSEQ,PIMSGFMT,PIUNICOM,PIMOBILEAREA,PISVRTYPE,
                PIP1,PIP2,PIP3,PIP4,PIUSERMSGID,PIMODULEID,PIATTIME,PIVALIDTIME,PISENDTYPE,PIBATCHID,PIAREACODE,PICUSTID,PIEXDATA);
      ELSE
        PILONGMSG:='';
      END IF;--END OF IF PILONGMSGLEN > 0
    */
    ELSIF (PIPKTOTAL > 1 AND ((PIPKTOTAL <= PISENDNUM AND PIDESTFEEFLAG=1) OR PIDESTFEEFLAG=2) AND PITPUDHI=0)THEN--对非标准长短信协议的处理
      PILONGMSG:=' ';
      --没有补发过且通道号跟源通道号相等
      SELECT COUNT(*) INTO ICOUNT FROM TMP_RDMTTASK WHERE PTMSGID=PIOLDMSGID AND RESENDCNT<1 AND TRIM(SPGATE)=PISRCSPGATE;
      IF ICOUNT>0 THEN
        --循环处理旧的几条短信，并且用新的MSGID更新旧的MSGID,然后调用存储过程用旧的MSGID生成新的几条短信，并返回旧的MSGID
        --计算起始MSGID
        PIINITMSGID := PIOLDMSGID-(PIPKNUM-1)*17179869184;
        PIPKNUM := 1;
        WHILE PIPKNUM <= PIPKTOTAL LOOP
          --取短信内容 --若长短信中间的某条缺失，则不补发(暂不考虑)
          BEGIN
          SELECT MESSAGE INTO PISINGLEMSG FROM GW_MT_TASK_BAK WHERE PTMSGID=PIINITMSGID+(PIPKNUM-1)*17179869184;
          exception
            when no_data_found then
              PISINGLEMSG := ' ';
          end;
          IF PISINGLEMSG = ' ' THEN
            --拼接短信内容
            BEGIN
            SELECT MESSAGE INTO PISINGLEMSG1 FROM MT_TASK WHERE PTMSGID=PIINITMSGID+(PIPKNUM-1)*17179869184;
            EXCEPTION
              WHEN NO_DATA_FOUND THEN
                PISINGLEMSG1:=' ';
            END;
            IF NVL(LENGTH(LTRIM(PISINGLEMSG1)),0)>0 THEN
             --更新替换MSGID
            PILONGMSG := NVL(PILONGMSG,' ')||NVL(PISINGLEMSG1,' ');
            UPDATE MT_TASK SET RESENDCNT=1 WHERE PTMSGID=PIINITMSGID+(PIPKNUM-1)*17179869184;
            END IF;--IF LENGTH(PISINGLEMSG1)>0 THEN
          ELSE
            PILONGMSG := NVL(PILONGMSG,' ')||NVL(PISINGLEMSG,' ');
            UPDATE GW_MT_TASK_BAK SET RESENDCNT=1 WHERE PTMSGID=PIINITMSGID+(PIPKNUM-1)*17179869184;
          END IF;
            --拼接短信内容
           PIPKNUM := PIPKNUM+1;
        END LOOP;--END OF WHILE PIPKNUM <= PIPKTOTAL
        PILONGMSGLEN := LENGTH(PILONGMSG)-PIOLDSIGNLEN_V ;--减去签名的净长度

        IF PIOLDSIGNPOS=0 THEN--去掉原短信的签名
          PILONGMSG:=SUBSTR(PILONGMSG,1,PILONGMSGLEN);
        ELSE
          PILONGMSG:=SUBSTR(PILONGMSG,1+PIOLDSIGNLEN_V,PILONGMSGLEN);
        END IF;

        PILONGMSGLEN := LENGTH(PILONGMSG);
        IF PILONGMSGLEN > 0 THEN
          --计算拆分条数
          IF PILONGMSGLEN<=PISPLITLEN_V THEN
          PIPKTOTAL:=1;
          ELSE
          PIPKTOTAL:=TRUNC(1+(PILONGMSGLEN-PIMULTILEN2_V+PIMULTILEN1_V-1)/(PIMULTILEN1_V));
          END IF;--END OF IF PILONGMSGLEN<=PISPLITLEN

          IF PINEWSIGNPOS=0 THEN--增加新的签名
            PILONGMSG := TRIM(PILONGMSG)||PISIGNATURE_V;
          ELSE
            PILONGMSG := PISIGNATURE_V||TRIM(PILONGMSG);
          END IF;

          --调用插入存储过程
          GW_WR_MTTASKV2(PIDESTUID,PINEWMSGID,2,1,PIPKTOTAL,1,
                  PISPLITLEN_V,PIMULTILEN1_V,PIMULTILEN2_V,PINEWSIGNLEN_V,PIECID,
                  PIDESTUSRID,PIDESTSPGATE,PIDESTCPNO,PIRECVMTTIME,PILONGMSG,
                  PIPHONE,PIDESTFEEFLAG,PISENDLEVEL,PITASKID,' ',PITPUDHI,
                  PILONGMSGSEQ,PIMSGFMT,PIUNICOM,PIMOBILEAREA,PIPKNUM,PISVRTYPE,
                  PIP1,PIP2,PIP3,PIP4,PIUSERMSGID,PIMODULEID,PIATTIME,PIVALIDTIME,PISENDTYPE,PIBATCHID,PIAREACODE,PICUSTID,PIEXDATA);
        ELSE
          PILONGMSG:='';
        END IF;--END OF IF PILONGMSGLEN > 0
          PIPKNUM:=1;
      END IF;--END OF IF EXISTS(SELECT COUNT(*) FROM PITMP WHERE PTMSGID=PIOLDMSGID AND RESENDCNT<1 AND (TRIM(SPGATE)+TRIM(CPNO))=PISRCSPNUMBER)
    END  IF;--END OF IF PIPKTOTAL > 1
  END IF;--END OF IF PIPIROWCOUNT<>0
  --返回给上层数据
  PIPTMSGID_P:=PINEWMSGID;
  UPDATE TMP_RDMTTASK SET PTNEWMSGID=PIPTMSGID_P WHERE PTMSGID=PIOLDMSGID;
  
  OPEN OUT_CURSOR FOR
  SELECT "UID",PTNEWMSGID AS PTMSGID,ECID,TASKID,PIDESTUSRID AS USERID,PIDESTSPGATE AS SPGATE,
  PIDESTCPNO AS CPNO,PHONE,RETFLAG,PIDESTFEEFLAG AS FEEFLAG,1 AS PKNUMBER,PIPKTOTAL AS PKTOTAL,
  SENDSTATUS,1 AS SENDLEVEL,
  PILONGMSG AS MESSAGE,TPUDHI,LONGMSGSEQ,MSGFMT,UNICOM,MOBILEAREA,
  SVRTYPE,P1,P2,P3,P4,USERMSGID,MODULEID,
  ATTIME,VALIDTIME,SENDTYPE,BATCHID,AREACODE,CUSTID,EXDATA FROM TMP_RDMTTASK WHERE (PILONGMSG IS NOT NULL);
END;
/

CREATE OR REPLACE PROCEDURE S_WR_MTTASKSR
 (
    PIUID          IN NUMBER,
    PIPTMSGID      IN NUMBER,
    PISENDSTATUS   IN NUMBER,
    PIRETFLAG      IN NUMBER,
    PIPKTOTAL      IN NUMBER,
    PIPHONECOUNT   IN NUMBER,
    PIECID         IN NUMBER,
    PIUSERID       IN VARCHAR2,
    PISPGATE       IN VARCHAR2,
    PICPNO         IN VARCHAR2,
    PIRECVMTTIME   IN VARCHAR2,
    PIMESSAGE      IN VARCHAR2,
    PISHOUJI       IN VARCHAR2,
    PIFEEFLAG      IN NUMBER,
    PIPKNUMBER     IN NUMBER,
    PISENDLEVEL    IN NUMBER,
    PITASKID       IN NUMBER,
    PIERCODE       IN VARCHAR2,
    PITPUDHI       IN NUMBER,
    PILONGMSGSEQ   IN NUMBER,
    PIMSGFMT       IN NUMBER,
    PIUNICOM       IN NUMBER,
    PIMOBILEAREA   IN NUMBER,
    PISVRTYPE      IN VARCHAR2,
    PIP1           IN VARCHAR2,
    PIP2           IN VARCHAR2,
    PIP3           IN VARCHAR2,
    PIP4           IN VARCHAR2,
    PIUSERMSGID    IN NUMBER DEFAULT 0,
    PIMODULEID     IN NUMBER DEFAULT 0,
    PIATTIME       IN NUMBER DEFAULT 0,
    PIVALIDTIME    IN NUMBER DEFAULT 0,
    PISENDTYPE     IN NUMBER DEFAULT 1,
    PIBATCHID      IN NUMBER DEFAULT 0,
    PIAREACODE     IN NUMBER DEFAULT 0
 )
AS
PILOCATION PLS_INTEGER;
PISTART PLS_INTEGER;
PIRESULTPHONE VARCHAR2(21);
PISTRSPLIT VARCHAR2(2);
PIRECVMTTIME_P TIMESTAMP(6);
ICOUNT PLS_INTEGER;
PISHOUJI_P VARCHAR2(3500);
PIPTMSGID_P NUMBER(22,0);

BEGIN

PISTRSPLIT := ',';
PISHOUJI_P := PISHOUJI;
PIPTMSGID_P:=PIPTMSGID;

IF PIRECVMTTIME IS NULL THEN
   PIRECVMTTIME_P:=SYSTIMESTAMP;
ELSE
   PIRECVMTTIME_P:=TO_TIMESTAMP(PIRECVMTTIME,'YYYY-MM-DD HH24:MI:SS.FF');
END IF;
/*
SELECT  COUNT(*) INTO ICOUNT FROM USER_TABLES T WHERE UPPER(T.TABLE_NAME)=UPPER('TMP_MTTASKSR');
IF ICOUNT>0 THEN
  EXECUTE IMMEDIATE 'TRUNCATE TABLE TMP_MTTASKSR';
ELSE
  RETURN;
END IF;
*/
IF (PISHOUJI_P IS NULL) THEN
   PISHOUJI_P := ' ';
END IF;
IF (PIPHONECOUNT < 1) THEN--手机号码为空
  RETURN;
END IF;

IF PIPHONECOUNT = 1 THEN--单发
  SELECT COUNT(PTMSGID) INTO ICOUNT FROM GW_MT_TASK_BAK WHERE PTMSGID=PIPTMSGID_P;
  IF ICOUNT<1 THEN
    INSERT INTO GW_MT_TASK_BAK("UID",USERID, SPGATE, CPNO, PHONE, PTMSGID, MESSAGE,SENDSTATUS,
    RETFLAG, PKNUMBER, PKTOTAL, RECVMTTIME, ECID, FEEFLAG, SENDLEVEL,TASKID,ERRORCODE,TPUDHI,LONGMSGSEQ,
    MSGFMT,UNICOM,MOBILEAREA,SVRTYPE,P1,P2,P3,P4,USERMSGID,MODULEID,ATTIME,VALIDTIME,SENDTYPE,BATCHID,AREACODE)
    VALUES(PIUID,PIUSERID, PISPGATE, PICPNO, PISHOUJI_P, PIPTMSGID_P, PIMESSAGE,PISENDSTATUS,
    PIRETFLAG, PIPKNUMBER, PIPKTOTAL, PIRECVMTTIME_P, PIECID, PIFEEFLAG, PISENDLEVEL,PITASKID,PIERCODE,PITPUDHI,
    PILONGMSGSEQ,PIMSGFMT,PIUNICOM,PIMOBILEAREA,PISVRTYPE,PIP1,PIP2,PIP3,PIP4,PIUSERMSGID,PIMODULEID,PIATTIME,
    PIVALIDTIME,PISENDTYPE,PIBATCHID,PIAREACODE);
  END IF;
ELSE --群发
  PISHOUJI_P := PISTRSPLIT||PISHOUJI_P||PISTRSPLIT;
  PILOCATION := INSTR(PISHOUJI_P,PISTRSPLIT);
  WHILE PILOCATION <> 0 LOOP--拆分手机号码
    PISTART := PILOCATION;
    PILOCATION := INSTR(PISHOUJI_P,PISTRSPLIT,PISTART+1);
    IF PILOCATION > 0 THEN
      PIRESULTPHONE := SUBSTR(PISHOUJI_P,PISTART+1,PILOCATION-PISTART-1);
      IF (PIRESULTPHONE IS NULL) THEN
        PIRESULTPHONE := ' ';
      END IF;
      ICOUNT:=0;
      SELECT COUNT(PTMSGID) INTO ICOUNT FROM GW_MT_TASK_BAK WHERE PTMSGID=PIPTMSGID_P;

      IF ICOUNT<1 THEN
        INSERT INTO TMP_MTTASKSR("UID",USERID, SPGATE, CPNO, PHONE, PTMSGID, MESSAGE,SENDSTATUS,
        RETFLAG, PKNUMBER, PKTOTAL, RECVMTTIME,ECID, FEEFLAG, SENDLEVEL,TASKID,ERRORCODE,TPUDHI,LONGMSGSEQ,
        MSGFMT,UNICOM,MOBILEAREA,SVRTYPE,P1,P2,P3,P4,USERMSGID,MODULEID,ATTIME,VALIDTIME,SENDTYPE)
        VALUES(PIUID,PIUSERID,PISPGATE,PICPNO,PIRESULTPHONE,PIPTMSGID_P,PIMESSAGE,PISENDSTATUS,PIRETFLAG,
        PIPKNUMBER,PIPKTOTAL,PIRECVMTTIME_P,PIECID,PIFEEFLAG,PISENDLEVEL,PITASKID,PIERCODE,PITPUDHI,PILONGMSGSEQ,PIMSGFMT,
        PIUNICOM,PIMOBILEAREA,PISVRTYPE,PIP1,PIP2,PIP3,PIP4,PIUSERMSGID,PIMODULEID,PIATTIME,PIVALIDTIME,PISENDTYPE);
      END IF;
      PIPTMSGID_P := PIPTMSGID_P+1;
    END IF;
  END LOOP;
  INSERT INTO GW_MT_TASK_BAK ("UID",USERID, SPGATE, CPNO, PHONE, PTMSGID, MESSAGE,SENDSTATUS, RETFLAG,
  PKNUMBER, PKTOTAL, RECVMTTIME, ECID, FEEFLAG, SENDLEVEL,TASKID,ERRORCODE,TPUDHI,LONGMSGSEQ,MSGFMT,
  UNICOM,MOBILEAREA,SVRTYPE,P1,P2,P3,P4,USERMSGID,MODULEID,ATTIME,VALIDTIME,SENDTYPE,BATCHID,AREACODE)
  SELECT A."UID",A.USERID,A.SPGATE,A.CPNO,A.PHONE,A.PTMSGID,A.MESSAGE,A.SENDSTATUS,A.RETFLAG,
  A.PKNUMBER,A.PKTOTAL,A.RECVMTTIME,A.ECID,A.FEEFLAG,A.SENDLEVEL,A.TASKID,A.ERRORCODE,A.TPUDHI,A.LONGMSGSEQ,A.MSGFMT,A.UNICOM,
  A.MOBILEAREA,A.SVRTYPE,A.P1,A.P2,A.P3,A.P4,A.USERMSGID,A.MODULEID,A.ATTIME,A.VALIDTIME,A.SENDTYPE,PIBATCHID,PIAREACODE FROM TMP_MTTASKSR A;
  COMMIT;
END IF;
  EXECUTE IMMEDIATE 'TRUNCATE TABLE TMP_MTTASKSR';
END;
/

-------------------增加版本信息-------------------------------------------
DECLARE
  VERSION INT;
BEGIN
  SELECT COUNT(*) INTO VERSION FROM VERSION_CMPP WHERE VERSION='4.06.05';
  IF VERSION < 1 THEN
    INSERT INTO VERSION_CMPP (VERSION,VERSIONDATE,UPGRADETIME)
    VALUES ('4.06.05',TO_CHAR(SYSDATE,'YYYY-MM-DD'),TO_CHAR(SYSDATE,'HH24:MI:SS'));
  END IF;
  COMMIT;
END;
/

CREATE OR REPLACE PROCEDURE COMPILE_PROCEDURE
AS
V_SQL VARCHAR2(2000);
BEGIN

  FOR V IN (SELECT * FROM USER_OBJECTS WHERE OBJECT_TYPE IN ('PROCEDURE','TRIGGER') AND STATUS='INVALID' AND OBJECT_NAME NOT LIKE '%BIN$%')
    LOOP
      V_SQL:= 'ALTER  '||V.OBJECT_TYPE||' '|| V.OBJECT_NAME||' COMPILE';
      EXECUTE IMMEDIATE V_SQL;
    END LOOP;
END;
/
CALL COMPILE_PROCEDURE();
/

/*网关升级脚本   END*/

/*EMP升级脚本    START*/
--创建增加序列的存储过程
CREATE OR REPLACE PROCEDURE ADDSEQUENCEBYNAME(SEQNAME IN NVARCHAR2) AUTHID CURRENT_USER
IS
NUM NUMBER(11);
SQLSTR VARCHAR2(1000);
BEGIN
  ----判断序列 seq_name_1 是否存在（区分大小写）
    SELECT COUNT(1) INTO NUM FROM USER_SEQUENCES WHERE SEQUENCE_NAME = UPPER(SEQNAME);
    ----如果不存在则创建
    IF NUM = 0 THEN
      SQLSTR:= 'CREATE SEQUENCE ' || SEQNAME ||
        ' MINVALUE 1
        MAXVALUE 999999999999999999999999999
        START WITH 1
        INCREMENT BY 1
        CACHE 20';
       EXECUTE IMMEDIATE SQLSTR;
    END IF;
END;
/

DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM LF_IMPOWER WHERE PRIVILEGE_ID IN (3100, 3102);
    IF NUM > 0 THEN
        DELETE FROM LF_IMPOWER WHERE PRIVILEGE_ID IN (3100, 3102);
    END IF;
END;
/
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM LF_PRIVILEGE WHERE PRIVILEGE_ID IN (3100, 3102);
    IF NUM = 0 THEN
        INSERT INTO LF_PRIVILEGE(PRIVILEGE_ID, RESOURCE_ID, OPERATE_ID, COMMENTS, PRIV_CODE, MENUNAME, MODNAME, MENUCODE, MENUSITE, ZH_TW_COMMENTS, ZH_HK_COMMENTS, ZH_TW_MENUNAME, ZH_HK_MENUNAME, ZH_TW_MODNAME, ZH_HK_MODNAME)
        VALUES (3100, 95, 1, '查看', '5100-1000-0', '富信发送', '富信应用', '5100-1000', '/rms_rmsSameMms.htm', '查看', 'View', '富信l送', 'Rich media send', '富信用', 'Multimedia');
        INSERT INTO LF_PRIVILEGE(PRIVILEGE_ID, RESOURCE_ID, OPERATE_ID, COMMENTS, PRIV_CODE, MENUNAME, MODNAME, MENUCODE, MENUSITE, ZH_TW_COMMENTS, ZH_HK_COMMENTS, ZH_TW_MENUNAME, ZH_HK_MENUNAME, ZH_TW_MODNAME, ZH_HK_MODNAME)
        VALUES (3102, 95, 1, '查看', '5100-1100-0', '不同内容发送', '富信应用', '5100-1200', '/rms_diffMms.htm', '查看', 'View', '不同热莅l送', 'Different SMS', '富信用', 'Multimedia');
        INSERT INTO LF_IMPOWER VALUES(1,3100);
        INSERT INTO LF_IMPOWER VALUES(2,3100);
        INSERT INTO LF_IMPOWER VALUES(4,3100);
        INSERT INTO LF_IMPOWER VALUES(1,3102);
        INSERT INTO LF_IMPOWER VALUES(2,3102);
        INSERT INTO LF_IMPOWER VALUES(4,3102);
    END IF;
END;
/
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM LF_PRIVILEGE WHERE PRIVILEGE_ID IN 3101;
    IF NUM = 0 THEN
        INSERT INTO LF_PRIVILEGE(PRIVILEGE_ID, RESOURCE_ID, OPERATE_ID, COMMENTS, PRIV_CODE, MENUNAME, MODNAME, MENUCODE, MENUSITE, ZH_TW_COMMENTS, ZH_HK_COMMENTS, ZH_TW_MENUNAME, ZH_HK_MENUNAME, ZH_TW_MODNAME, ZH_HK_MODNAME)
         VALUES(3101,100,1,'查看','5100-1800-0','档位统计报表','数据查询','5100-1800','/rep_degreeReport.htm','查看','View','n位y蟊','Degree Report','查','Data Query');
        INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(1,3101);
        INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(2,3101);
        INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(4,3101);
    END IF;
END;
/
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM LF_PRIVILEGE WHERE PRIVILEGE_ID=3104;
    IF NUM = 0 THEN
        INSERT INTO LF_PRIVILEGE(PRIVILEGE_ID, RESOURCE_ID, OPERATE_ID, COMMENTS, PRIV_CODE, MENUNAME, MODNAME, MENUCODE, MENUSITE, ZH_TW_COMMENTS, ZH_HK_COMMENTS, ZH_TW_MENUNAME, ZH_HK_MENUNAME, ZH_TW_MODNAME, ZH_HK_MODNAME)
         VALUES(3104,100,1,'查看','5100-1500-0','发送明细查询','数据查询','5100-1500','/rms_sendDetail.htm','查看','View','l送明查','Send Detail','查','Data Query');
        INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(1,3104);
        INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(2,3104);
        INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(4,3104);
    END IF;
END;
/

-- DECLARE NUM NUMBER;
-- BEGIN
--     SELECT COUNT(1) INTO NUM FROM LF_PRIVILEGE WHERE PRIVILEGE_ID IN 3103;
--     IF NUM = 0 THEN
--         INSERT INTO LF_PRIVILEGE(PRIVILEGE_ID, RESOURCE_ID, OPERATE_ID, COMMENTS, PRIV_CODE, MENUNAME, MODNAME, MENUCODE, MENUSITE, ZH_TW_COMMENTS, ZH_HK_COMMENTS, ZH_TW_MENUNAME, ZH_HK_MENUNAME, ZH_TW_MODNAME, ZH_HK_MODNAME)
--         VALUES(3103,100,1,'查看','5100-2000-0','计费档位管理','计费档位管理','5100-2000','/rms_degreeManager.htm','查看','View','Mn位管理','Degree Manage','Mn位管理','Degree Manage');
--         INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(1,3103);
--         INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(2,3103);
--         INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(4,3103);
--     END IF;
-- END;
-- /
-- DECLARE NUM NUMBER;
-- BEGIN
--     SELECT COUNT(1) INTO NUM FROM LF_PRIVILEGE WHERE PRIVILEGE_ID=3105;
--     IF NUM = 0 THEN
--         INSERT INTO LF_PRIVILEGE(PRIVILEGE_ID, RESOURCE_ID, OPERATE_ID, COMMENTS, PRIV_CODE, MENUNAME, MODNAME, MENUCODE, MENUSITE, ZH_TW_COMMENTS, ZH_HK_COMMENTS, ZH_TW_MENUNAME, ZH_HK_MENUNAME, ZH_TW_MODNAME, ZH_HK_MODNAME)
--         VALUES(3105,100,NULL,'新建','5100-2000-1','计费档位管理','计费档位管理','5100-2000',NULL,'新建','Add','Mn位管理','Degree Manager','Mn位管理','Degree Manager');
--         INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(1,3105);
--         INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(2,3105);
--         INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(4,3105);
--     END IF;
-- END;
-- /
-- DECLARE NUM NUMBER;
-- BEGIN
--     SELECT COUNT(1) INTO NUM FROM LF_PRIVILEGE WHERE PRIVILEGE_ID=3106;
--     IF NUM = 0 THEN
--         INSERT INTO LF_PRIVILEGE(PRIVILEGE_ID, RESOURCE_ID, OPERATE_ID, COMMENTS, PRIV_CODE, MENUNAME, MODNAME, MENUCODE, MENUSITE, ZH_TW_COMMENTS, ZH_HK_COMMENTS, ZH_TW_MENUNAME, ZH_HK_MENUNAME, ZH_TW_MODNAME, ZH_HK_MODNAME)
--         VALUES(3106,100,NULL,'修改','5100-2000-3','计费档位管理','计费档位管理','5100-2000',NULL,'修改','Update','Mn位管理','Degree Manager','Mn位管理','Degree Manager');
--         INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(1,3106);
--         INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(2,3106);
--         INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(4,3106);
--     END IF;
-- END;
-- /
--富信群发任务查看
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM LF_PRIVILEGE WHERE PRIVILEGE_ID=3107;
    IF NUM = 0 THEN
        INSERT INTO LF_PRIVILEGE(PRIVILEGE_ID, RESOURCE_ID, OPERATE_ID, COMMENTS, PRIV_CODE, MENUNAME, MODNAME, MENUCODE, MENUSITE, ZH_TW_COMMENTS, ZH_HK_COMMENTS, ZH_TW_MENUNAME, ZH_HK_MENUNAME, ZH_TW_MODNAME, ZH_HK_MODNAME)
         VALUES(3107,100,1,'查看','5100-1400-0','群发任务查看','数据查询','5100-1400','/rmsTaskRecord.htm','查看','View','群l任詹榭','Task view','查','Data Query');
        INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(1,3107);
        INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(2,3107);
        INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(4,3107);
    END IF;
END;
/
--LF_MTTASK新增字段(VALIDTM)
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM COLS WHERE TABLE_NAME = UPPER('LF_MTTASK') AND COLUMN_NAME = UPPER('VALIDTM');
    IF NUM = 0 THEN
        EXECUTE IMMEDIATE 'ALTER TABLE LF_MTTASK ADD VALIDTM NUMBER(5) DEFAULT 48 NOT NULL';
    END IF;
END;
/
UPDATE LF_PRIVILEGE SET MODNAME = '富信应用' WHERE RESOURCE_ID = 95;
UPDATE LF_PRIVILEGE SET MENUNAME='档位统计报表' WHERE MENUNAME='容量套餐统计报表';
UPDATE LF_PRIVILEGE SET ZH_TW_MENUNAME='档位统计报表' WHERE ZH_TW_MENUNAME='容量套餐y蟊';
UPDATE LF_THIR_MENUCONTROL SET PRI_ORDER = 80 WHERE PRI_ORDER = 390;

-- 富信模板管理 添加 新建、删除权限
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM LF_PRIVILEGE WHERE PRIVILEGE_ID=633;
    IF NUM = 0 THEN
        INSERT INTO LF_PRIVILEGE(PRIVILEGE_ID, RESOURCE_ID, OPERATE_ID, COMMENTS, PRIV_CODE, MENUNAME, MODNAME, MENUCODE, MENUSITE, ZH_TW_COMMENTS, ZH_HK_COMMENTS, ZH_TW_MENUNAME, ZH_HK_MENUNAME, ZH_TW_MODNAME, ZH_HK_MODNAME)
        VALUES(633,95,NULL,'新建','5100-1300-1','我的场景','富信应用','5100-1300',NULL,'新建','Add','我的场景','My scene','富信用','Multimedia');
        INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(1,633);
        INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(2,633);
        INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(4,633);
    END IF;
END;
/
-- 富信模板管理菜单 START--
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM LF_PRIVILEGE WHERE PRIVILEGE_ID=634;
    IF NUM = 0 THEN
        INSERT INTO LF_PRIVILEGE(PRIVILEGE_ID, RESOURCE_ID, OPERATE_ID, COMMENTS, PRIV_CODE, MENUNAME, MODNAME, MENUCODE, MENUSITE, ZH_TW_COMMENTS, ZH_HK_COMMENTS, ZH_TW_MENUNAME, ZH_HK_MENUNAME, ZH_TW_MODNAME, ZH_HK_MODNAME)
        VALUES(634,95,1,'查看','5100-1300-0','我的场景','富信应用','5100-1300','/mbgl_mytemplate.htm','查看','View','我的场景','My scene','富信用','Multimedia');
        insert into LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(1,634);
	      insert into LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(2,634);
	      insert into LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(4,634);
    END IF;
END;
/
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM LF_PRIVILEGE WHERE PRIVILEGE_ID=635;
    IF NUM = 0 THEN
	      INSERT INTO LF_PRIVILEGE(PRIVILEGE_ID, RESOURCE_ID, OPERATE_ID, COMMENTS, PRIV_CODE, MENUNAME, MODNAME, MENUCODE, MENUSITE, ZH_TW_COMMENTS, ZH_HK_COMMENTS, ZH_TW_MENUNAME, ZH_HK_MENUNAME, ZH_TW_MODNAME, ZH_HK_MODNAME)
	      VALUES(635,95,NULL,'删除','5100-1300-2','我的场景','富信应用','5100-1300',NULL,'删除','Delete','我的场景','My scene','富信用','Multimedia');
        INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(1,635);
        INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(2,635);
        INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(4,635);
    END IF;
END;
/
-- DELETE LF_IMPOWER WHERE PRIVILEGE_ID = 3103 AND ROLE_ID != 2
/
--在运营商余额表(LF_SPFEE)中增加富信余额
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM COLS WHERE TABLE_NAME = UPPER('LF_SPFEE') AND COLUMN_NAME = UPPER('RMS_BALANCE');
    IF NUM = 0 THEN
        EXECUTE IMMEDIATE 'ALTER TABLE LF_SPFEE ADD RMS_BALANCE NUMBER(18) DEFAULT 0 NOT NULL';
    END IF;
END;
/
--增加富信任务发送控制表
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM USER_TABLES WHERE TABLE_NAME = 'LF_RMSTASK_CTRL';
    IF NUM = 0 THEN
       EXECUTE IMMEDIATE ' CREATE TABLE LF_RMSTASK_CTRL(
      "ID" NUMBER(18) PRIMARY KEY NOT NULL,--主键
      "TASKID" NUMBER(18) DEFAULT 0 NOT NULL,--任务id
      "CURRENT_COUNT" NUMBER(18) DEFAULT 0 NOT NULL,--当前发送记录数
      "UPDATE_TIME" TIMESTAMP(6) DEFAULT SYSDATE NOT NULL--修改时间
      )';
    END IF;
END;
/

--增加序列与触发器
CALL ADDSEQUENCEBYNAME('LF_RMSTASK_CTRL_S');

CREATE OR REPLACE TRIGGER LF_RMSTASK_CTRL_Q
BEFORE INSERT ON LF_RMSTASK_CTRL
FOR EACH ROW
  BEGIN
    IF(:NEW.ID IS NULL)
    THEN
      SELECT LF_RMSTASK_CTRL_S.NEXTVAL INTO :NEW.ID FROM DUAL;
      END IF;
      END;
/
-- 富信模板管理菜单 END--

-- 统计报表 START--
--先删除相应的存储过程再重建
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM USER_OBJECTS WHERE OBJECT_TYPE = 'PROCEDURE' AND OBJECT_NAME = 'CREATETABLEFX';
    IF NUM > 0 THEN
        EXECUTE IMMEDIATE 'DROP PROCEDURE CREATETABLEFX';
    END IF;
END;
/
CREATE PROCEDURE CREATETABLEFX(PIYM NUMBER) AUTHID CURRENT_USER
IS
STR VARCHAR2(4000);
TABLENAME VARCHAR2(22);
BEGIN
  TABLENAME:='LF_RMS_SYN'||CAST(PIYM AS CHAR);
  STR:= 'CREATE TABLE '||TABLENAME||'(
		   ID NUMBER PRIMARY KEY NOT NULL,
		   SPISUNCM VARCHAR2(4) DEFAULT('''') NOT NULL,
		   USERID VARCHAR2(32) DEFAULT('''') NOT NULL,
		   IYMD NUMBER(11) DEFAULT 0 NOT NULL,
		   ICOUNT NUMBER(18) DEFAULT 0 NOT NULL ,
		   RSUCC NUMBER(18) DEFAULT 0 NOT NULL ,
		   RFAIL NUMBER(18) DEFAULT 0 NOT NULL,
		   REQ_TIME TIMESTAMP(6) DEFAULT SYSDATE NOT NULL,
		   CORP_CODE VARCHAR2(64) DEFAULT('''') NOT NULL,
		   DEGREE NUMBER(11) DEFAULT 0 NOT NULL,
		   SYN_TIME TIMESTAMP(6) DEFAULT SYSDATE NOT NULL,
       PARAM1 varchar2(64) DEFAULT('''') NOT NULL,
       PARAM2 varchar2(64) DEFAULT('''') NOT NULL,
       PARAM3 varchar2(64) DEFAULT('''') NOT NULL,
       PARAM4 varchar2(64) DEFAULT('''') NOT NULL
	)';
	EXECUTE IMMEDIATE STR;
END;
/
--创建一年的年月表(从当前年月开始)
DECLARE J NUMBER(11);PIYMFX VARCHAR2(6);NUM NUMBER(15);
BEGIN
  J:=0;
  WHILE(J < 12)
    LOOP
      PIYMFX := TO_CHAR(ADD_MONTHS(SYSDATE,J),'yyyymm');
        --判断是否存在
        SELECT COUNT(1) INTO NUM FROM USER_TABLES WHERE TABLE_NAME = 'LF_RMS_SYN'||PIYMFX;
        IF NUM = 0 THEN
          BEGIN
            CREATETABLEFX(PIYMFX);
            EXCEPTION
            WHEN OTHERS THEN
              ROLLBACK;
              RETURN;
          END;
        END IF;
      J := J+1;
    END LOOP;
END;
/
--增加富信同步报表数据中间表
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM USER_TABLES WHERE TABLE_NAME = 'LF_RMS_SYN_TEMP';
    IF NUM = 0 THEN
        EXECUTE IMMEDIATE 'CREATE TABLE LF_RMS_SYN_TEMP(
       "ID" NUMBER(18) PRIMARY KEY NOT NULL,--主键
       "SPISUNCM" VARCHAR2(4) DEFAULT('''') NOT NULL,--运营商
       "USERID" VARCHAR2(32) DEFAULT('''') NOT NULL,--SP账号
       "IYMD" NUMBER(11) DEFAULT 0 NOT NULL,--年月日
       "ICOUNT" NUMBER(18) DEFAULT 0 NOT NULL,--提交总数
       "RSUCC" NUMBER(18) DEFAULT 0 NOT NULL,--发送成功数
       "RFAIL" NUMBER(18) DEFAULT 0 NOT NULL,--接收失败数
       "REQ_TIME" TIMESTAMP(6) DEFAULT SYSDATE NOT NULL,--请求时间（入库时间）
       "CORP_CODE" VARCHAR2(64) DEFAULT('''') NOT NULL,--企业编码
       "DEGREE" NUMBER(11) DEFAULT 0 NOT NULL,--档位
       "FLAG" NUMBER(11) DEFAULT 0 NOT NULL,--0未结束，1结束
       "PARAM1" varchar2(64) DEFAULT('''') NOT NULL,
       "PARAM2" varchar2(64) DEFAULT('''') NOT NULL,
       "PARAM3" varchar2(64) DEFAULT('''') NOT NULL,
       "PARAM4" varchar2(64) DEFAULT('''') NOT NULL
      )';
    END IF;
END;
/
--增加富信统计表（汇总报表）
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM USER_TABLES WHERE TABLE_NAME = 'LF_RMS_REPORT';
    IF NUM = 0 THEN
      EXECUTE IMMEDIATE 'CREATE TABLE LF_RMS_REPORT(
       "ID" NUMBER(18) PRIMARY KEY NOT NULL,--主键
       "SPISUNCM" VARCHAR2(4) DEFAULT('''') NOT NULL,--运营商
       "USERID" VARCHAR2(32) DEFAULT('''') NOT NULL,--SP账号
       "IYMD" NUMBER(11) DEFAULT 0 NOT NULL,--年月日
       "ICOUNT" NUMBER(18) DEFAULT 0 NOT NULL,--提交总数
       "RSUCC" NUMBER(18) DEFAULT 0 NOT NULL,--发送成功数
       "RFAIL" NUMBER(18) DEFAULT 0 NOT NULL,--接收失败数
       "CREATE_TIME" TIMESTAMP(6) DEFAULT SYSDATE NOT NULL,--创建时间
       "CORP_CODE" VARCHAR2(64) DEFAULT('''') NOT NULL,--企业编码
       "SYN_TIME" TIMESTAMP(6) DEFAULT SYSDATE NOT NULL,--同步时间
       "DEGREE" NUMBER(11) DEFAULT 0 NOT NULL,--档位
       "PARAM1" varchar2(64) DEFAULT('''') NOT NULL,
       "PARAM2" varchar2(64) DEFAULT('''') NOT NULL,
       "PARAM3" varchar2(64) DEFAULT('''') NOT NULL,
       "PARAM4" varchar2(64) DEFAULT('''') NOT NULL
      )';
      --增加索引
       EXECUTE IMMEDIATE 'CREATE INDEX IND_LF_RMS_REP_IYMD ON LF_RMS_REPORT(IYMD ASC)';
       EXECUTE IMMEDIATE 'CREATE INDEX IND_LF_RMS_REP_DEG ON LF_RMS_REPORT(DEGREE ASC)';
       EXECUTE IMMEDIATE 'CREATE INDEX IND_LF_RMS_REP_SPCM ON LF_RMS_REPORT(SPISUNCM ASC)';
       EXECUTE IMMEDIATE 'CREATE INDEX IND_LF_RMS_REP_UID ON LF_RMS_REPORT(USERID ASC)';
    END IF;
END;
/

--档位表
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM USER_TABLES WHERE TABLE_NAME = 'LF_DEGREE';
    IF NUM = 0 THEN
       EXECUTE IMMEDIATE 'CREATE TABLE LF_DEGREE(
       ID NUMBER(18) PRIMARY KEY NOT NULL,--主键
       DEGREE NUMBER(11) DEFAULT 0 NOT NULL,--档位
       DEGREE_BEGIN VARCHAR2(64) DEFAULT('''') NOT NULL,--档位容量开始
       DEGREE_END VARCHAR2(64) DEFAULT('''') NOT NULL,--档位容量结束
       VALID_DATE_BEGIN TIMESTAMP(8) DEFAULT SYSDATE NOT NULL,--有效开始时间
       VALID_DATE_END TIMESTAMP(8) DEFAULT SYSDATE NOT NULL,--有效截止时间
       STATUS NUMBER(11) DEFAULT 0 NOT NULL,--状态,0-启用,1-禁用
       USER_ID NUMBER(18) DEFAULT 0 NOT NULL,--操作员ID
       CREATE_TIME TIMESTAMP(6) DEFAULT SYSDATE NOT NULL --记录创建时间
      )';
    END IF;
END;
/
--先删除存储过程
DECLARE NUM NUMBER;
BEGIN
SELECT COUNT(1) INTO NUM FROM USER_OBJECTS WHERE OBJECT_TYPE = 'PROCEDURE' AND OBJECT_NAME = 'PRO_RMS_TRANSFER';
    IF NUM > 0 THEN
        EXECUTE IMMEDIATE 'DROP PROCEDURE PRO_RMS_TRANSFER';
    END IF;
END;
/
DECLARE NUM NUMBER;
BEGIN
SELECT COUNT(1) INTO NUM FROM USER_OBJECTS WHERE OBJECT_TYPE = 'PROCEDURE' AND OBJECT_NAME = 'PRO_RMS_SUM';
    IF NUM > 0 THEN
        EXECUTE IMMEDIATE 'DROP PROCEDURE PRO_RMS_SUM';
    END IF;
END;
/
--存储过程1 从LF_RMS_SYN_201807表(年月表)中按年月转移数据至汇总表
CREATE PROCEDURE PRO_RMS_SUM(IYMD NUMBER) AUTHID CURRENT_USER
IS
SQLSTR VARCHAR2(1000);
TABLE_NAME VARCHAR2(25);
IYMDSTR VARCHAR2(8);
BEGIN
  IYMDSTR := TO_CHAR(IYMD);
  IF IYMD > 0 THEN
    BEGIN
      TABLE_NAME:='LF_RMS_SYN'||SUBSTR(IYMDSTR, 0, 6);
      --1.删除老数据
      SQLSTR:='DELETE FROM LF_RMS_REPORT WHERE IYMD='||IYMD;
      EXECUTE IMMEDIATE SQLSTR;
      --2 更新新数据
      SQLSTR:='INSERT INTO LF_RMS_REPORT (ID,SPISUNCM,USERID,IYMD,ICOUNT,RSUCC,RFAIL,SYN_TIME,CORP_CODE,DEGREE,CREATE_TIME,PARAM1,PARAM2,PARAM3,PARAM4) SELECT  ID,SPISUNCM,USERID,IYMD,ICOUNT,RSUCC,RFAIL,SYN_TIME,CORP_CODE,DEGREE,SYSDATE,PARAM1,PARAM2,PARAM3,PARAM4 FROM '||TABLE_NAME||' WHERE IYMD='||IYMD;
      EXECUTE IMMEDIATE SQLSTR;
      --事务提交
      COMMIT;
      EXCEPTION
        WHEN OTHERS THEN
          ROLLBACK;
    END;
  END IF;
END;
/
--存储过程2 从LF_RMS_SYN_TEMP表中按年月日转移数据
CREATE PROCEDURE PRO_RMS_TRANSFER AUTHID CURRENT_USER
IS
SQLSTR VARCHAR2(4000);
IYMD NUMBER(11);
ERROR NUMBER(11);
EXCEPTION_NUMBER NUMBER(11);
TABLE_NAME VARCHAR2(25);
--定义游标
CURSOR CURIDX IS SELECT IYMD FROM LF_RMS_SYN_TEMP WHERE IYMD <> 0 GROUP BY IYMD;
BEGIN
	--1.删除重复数据
	DELETE FROM LF_RMS_SYN_TEMP WHERE ID NOT IN(SELECT MAX(T1.ID) FROM LF_RMS_SYN_TEMP T1 GROUP BY T1.SPISUNCM,T1.USERID,T1.IYMD,T1.DEGREE);
	--1.1 删除同步标识数据即IYMD=0
	DELETE FROM LF_RMS_SYN_TEMP WHERE IYMD = 0;
	--2.数据转移
	--打开游标
	IF NOT CURIDX%ISOPEN THEN
		BEGIN
      OPEN CURIDX;
		END;
	END IF;
	--循环开始
	LOOP
		FETCH CURIDX INTO IYMD;
    --退出循环的条件
    EXIT WHEN CURIDX%NOTFOUND OR CURIDX%NOTFOUND IS NULL;
    --处理业务
    IF IYMD > 0 THEN
			BEGIN
				TABLE_NAME := 'LF_RMS_SYN'||SUBSTR(TO_CHAR(IYMD),0,6);
				--2.1删除老数据
				SQLSTR:='DELETE FROM '||TABLE_NAME||' WHERE IYMD='||IYMD;
				EXECUTE IMMEDIATE SQLSTR;
				--2.2 转移临时表数据
				SQLSTR:='INSERT INTO '||TABLE_NAME||'(ID,SPISUNCM,USERID,IYMD,ICOUNT,RSUCC,RFAIL,REQ_TIME,CORP_CODE,DEGREE,SYN_TIME,PARAM1,PARAM2,PARAM3,PARAM4) SELECT ID,SPISUNCM,USERID,IYMD,ICOUNT,RSUCC,RFAIL,REQ_TIME,CORP_CODE,DEGREE,SYSDATE,PARAM1,PARAM2,PARAM3,PARAM4 FROM LF_RMS_SYN_TEMP WHERE IYMD='||IYMD;
				EXECUTE IMMEDIATE SQLSTR;
				--2.3 删除已转移临时表数据
				SQLSTR:='DELETE FROM LF_RMS_SYN_TEMP WHERE IYMD='||IYMD;
				EXECUTE IMMEDIATE SQLSTR;
				--2.4 执行汇总
				BEGIN
				  PRO_RMS_SUM(IYMD);
				END;
				--2.5 提交事务
				COMMIT;
				EXCEPTION
        WHEN OTHERS THEN
        --2.6 异常回滚
          ROLLBACK;
				----2.7 关闭游标
				CLOSE CURIDX;
			END;
		END IF;
	END LOOP;
END;
/
-- 统计报表 END--
--增加菜单
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM LF_PRIVILEGE WHERE PRIVILEGE_ID=3300;
    IF NUM = 0 THEN
        INSERT INTO LF_PRIVILEGE (PRIVILEGE_ID, RESOURCE_ID, OPERATE_ID, COMMENTS, PRIV_CODE, MENUNAME, MODNAME, MENUCODE, MENUSITE, ZH_TW_COMMENTS, ZH_HK_COMMENTS, ZH_TW_MENUNAME, ZH_HK_MENUNAME, ZH_TW_MODNAME, ZH_HK_MODNAME)
        VALUES (3300, 95, NULL, '查看', '5100-1100-4', '不同内容发送', '富信应用', '5100-1200', NULL, '查看', 'View', '不同热莅l送', 'Different SMS', '富信用', 'Multimedia');
        INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(1,3300);
        INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(2,3300);
        INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(4,3300);
    END IF;
END;
/
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM LF_PRIVILEGE WHERE PRIVILEGE_ID=3301;
    IF NUM = 0 THEN
        INSERT INTO LF_PRIVILEGE (PRIVILEGE_ID, RESOURCE_ID, OPERATE_ID, COMMENTS, PRIV_CODE, MENUNAME, MODNAME, MENUCODE, MENUSITE, ZH_TW_COMMENTS, ZH_HK_COMMENTS, ZH_TW_MENUNAME, ZH_HK_MENUNAME, ZH_TW_MODNAME, ZH_HK_MODNAME)
        VALUES (3301, 95, NULL, '手动输入内容', '5100-1100-5', '不同内容发送', '富信应用', '5100-1200', NULL, '模板内容', 'View', '不同热莅l送', 'Different SMS', '富信用', 'Multimedia');
        INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(1,3301);
        INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(2,3301);
        INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(4,3301);
    END IF;
END;
/
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM LF_PRIVILEGE WHERE PRIVILEGE_ID=3302;
    IF NUM = 0 THEN
        INSERT INTO LF_PRIVILEGE (PRIVILEGE_ID, RESOURCE_ID, OPERATE_ID, COMMENTS, PRIV_CODE, MENUNAME, MODNAME, MENUCODE, MENUSITE, ZH_TW_COMMENTS, ZH_HK_COMMENTS, ZH_TW_MENUNAME, ZH_HK_MENUNAME, ZH_TW_MODNAME, ZH_HK_MODNAME)
        VALUES (3302, 95, NULL, '模板内容', '5100-1000-4', '相同内容发送', '富信应用', '5100-1000', NULL, '模板内容', 'View', '相同热莅l送', 'Same SMS', '富信用', 'Multimedia');
        INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(1,3302);
        INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(2,3302);
        INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(4,3302);
    END IF;
END;
/
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM LF_PRIVILEGE WHERE PRIVILEGE_ID=3303;
    IF NUM = 0 THEN
        INSERT INTO LF_PRIVILEGE (PRIVILEGE_ID, RESOURCE_ID, OPERATE_ID, COMMENTS, PRIV_CODE, MENUNAME, MODNAME, MENUCODE, MENUSITE, ZH_TW_COMMENTS, ZH_HK_COMMENTS, ZH_TW_MENUNAME, ZH_HK_MENUNAME, ZH_TW_MODNAME, ZH_HK_MODNAME)
        VALUES (3303, 95, NULL, '手动输入内容', '5100-1000-5', '相同内容发送', '富信应用', '5100-1000', NULL, '手动输入内容', 'View', '相同热莅l送', 'Same SMS', '富信用', 'Multimedia');
        INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(1,3303);
        INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(2,3303);
        INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(4,3303);
    END IF;
END;
/
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM LF_PRIVILEGE WHERE PRIVILEGE_ID=3304;
    IF NUM = 0 THEN
        INSERT INTO LF_PRIVILEGE (PRIVILEGE_ID, RESOURCE_ID, OPERATE_ID, COMMENTS, PRIV_CODE, MENUNAME, MODNAME, MENUCODE, MENUSITE, ZH_TW_COMMENTS, ZH_HK_COMMENTS, ZH_TW_MENUNAME, ZH_HK_MENUNAME, ZH_TW_MODNAME, ZH_HK_MODNAME)
        VALUES (3304, 95, NULL, '手动输入号码', '5100-1000-6', '相同内容发送', '富信应用', '5100-1000', NULL, '手动输入号码', 'View', '相同热莅l送', 'Same SMS', '富信用', 'Multimedia');
        INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(1,3304);
        INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(2,3304);
        INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(4,3304);
    END IF;
END;
/
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM LF_PRIVILEGE WHERE PRIVILEGE_ID=3305;
    IF NUM = 0 THEN
        INSERT INTO LF_PRIVILEGE (PRIVILEGE_ID, RESOURCE_ID, OPERATE_ID, COMMENTS, PRIV_CODE, MENUNAME, MODNAME, MENUCODE, MENUSITE, ZH_TW_COMMENTS, ZH_HK_COMMENTS, ZH_TW_MENUNAME, ZH_HK_MENUNAME, ZH_TW_MODNAME, ZH_HK_MODNAME)
        VALUES (3305, 95, NULL, '文件导入', '5100-1000-7', '相同内容发送', '富信应用', '5100-1000', NULL, '文件导入', 'View', '相同热莅l送', 'Same SMS', '富信用', 'Multimedia');
        INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(1,3305);
        INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(2,3305);
        INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(4,3305);
    END IF;
END;
/
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM LF_PRIVILEGE WHERE PRIVILEGE_ID=3306;
    IF NUM = 0 THEN
        INSERT INTO LF_PRIVILEGE (PRIVILEGE_ID, RESOURCE_ID, OPERATE_ID, COMMENTS, PRIV_CODE, MENUNAME, MODNAME, MENUCODE, MENUSITE, ZH_TW_COMMENTS, ZH_HK_COMMENTS, ZH_TW_MENUNAME, ZH_HK_MENUNAME, ZH_TW_MODNAME, ZH_HK_MODNAME)
        VALUES (3306, 95, NULL, '选择人员', '5100-1000-8', '相同内容发送', '富信应用', '5100-1000', NULL, '选择人员', 'View', '相同热莅l送', 'Same SMS', '富信用', 'Multimedia');
        INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(1,3306);
        INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(2,3306);
        INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(4,3306);
    END IF;
END;
/
-- 公共场景权限菜单
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM LF_PRIVILEGE WHERE PRIVILEGE_ID = 3550;
    IF NUM = 0 THEN
        INSERT INTO LF_PRIVILEGE(PRIVILEGE_ID, RESOURCE_ID, OPERATE_ID, COMMENTS, PRIV_CODE, MENUNAME, MODNAME, MENUCODE, MENUSITE, ZH_TW_COMMENTS, ZH_HK_COMMENTS, ZH_TW_MENUNAME, ZH_HK_MENUNAME, ZH_TW_MODNAME, ZH_HK_MODNAME)
        VALUES(3550,95,1,'查看','5100-1350-0','公共场景','富信应用','5100-1350','/rms_commTpl.htm','查看','view','公共场景','Common scene','富信用','Multimedia');
        INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(1,3550);
        INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(2,3550);
        INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(4,3550);
    END IF;
END;
/
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM LF_PRIVILEGE WHERE PRIVILEGE_ID = 3551;
    IF NUM = 0 THEN
        INSERT INTO LF_PRIVILEGE(PRIVILEGE_ID, RESOURCE_ID, OPERATE_ID, COMMENTS, PRIV_CODE, MENUNAME, MODNAME, MENUCODE, MENUSITE, ZH_TW_COMMENTS, ZH_HK_COMMENTS, ZH_TW_MENUNAME, ZH_HK_MENUNAME, ZH_TW_MODNAME, ZH_HK_MODNAME)
         VALUES(3551,95,NULL,'新建','5100-1350-1','公共场景','富信应用','5100-1350',NULL,'新建','Add','公共场景','Common scene','富信用','Multimedia');
        INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(1,3551);
        INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(2,3551);
        INSERT INTO LF_IMPOWER(ROLE_ID,PRIVILEGE_ID) VALUES(4,3551);
    END IF;
END;
/
--添加二级菜单
--档位统计报表
-- DECLARE NUM NUMBER;
-- BEGIN
--     SELECT COUNT(1) INTO NUM FROM LF_THIR_MENUCONTROL WHERE MENU_NUM = 25 AND PRI_MENU = 100;
--     IF NUM = 0 THEN
--         INSERT INTO LF_THIR_MENUCONTROL (MENU_NUM, TITLE, PRI_MENU, PRI_ORDER, ZH_TW_TITLE, ZH_HK_TITLE) VALUES (25, '企业富信', 100, 90, '企I富信', 'Multimedia');
--     END IF;
-- END;
-- /
--富信应用
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM LF_THIR_MENUCONTROL WHERE MENU_NUM = 25 AND PRI_MENU = 94;
    IF NUM = 0 THEN
        INSERT INTO LF_THIR_MENUCONTROL (MENU_NUM, TITLE, PRI_MENU, PRI_ORDER, ZH_TW_TITLE, ZH_HK_TITLE) VALUES (25, '企业富信', 94, 70, '企I富信', 'Multimedia');
    END IF;
END;
/
--数据查询
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM LF_THIR_MENUCONTROL WHERE MENU_NUM = 25 AND PRI_MENU = 95;
    IF NUM = 0 THEN
        INSERT INTO LF_THIR_MENUCONTROL (MENU_NUM, TITLE, PRI_MENU, PRI_ORDER, ZH_TW_TITLE, ZH_HK_TITLE) VALUES (25, '企业富信', 95, 80, '企I富信', 'Multimedia');
    END IF;
END;
/
--我的快捷场景
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM LF_THIR_MENUCONTROL WHERE MENU_NUM = 25 AND PRI_MENU = 93;
    IF NUM = 0 THEN
        INSERT INTO LF_THIR_MENUCONTROL (MENU_NUM, TITLE, PRI_MENU, PRI_ORDER, ZH_TW_TITLE, ZH_HK_TITLE) VALUES (25, '企业富信', 93, 60, '企I富信', 'Multimedia');
    END IF;
END;
/
--增加4.0皮肤
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM LF_SKIN WHERE SKIN_CODE='default' AND THEME_CODE='frame4.0';
    IF NUM = 0 THEN
        INSERT INTO LF_SKIN(SKIN_NAMNE,SKIN_CODE,THEME_CODE) VALUES('商务黑','default','frame4.0');
    END IF;
END;
/
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM LF_THEME WHERE THEME_NAME='简约' AND THEME_CODE='frame4.0';
    IF NUM = 0 THEN
        insert into LF_THEME (TID, THEME_NAME, THEME_CODE, THEME_SRC) values (3, '简约', 'frame4.0', 'classic');
    END IF;
END;
/
-- 模板表(LF_TEMPLATE)添加DEGREE、DEGREE_SIZE、INDUSTRYID、USEID、USECOUNT、ISSHORTTEMP、ISPUBLIC、EXLJSON、VER、CHGRADE、RMSRESSIZE、H5RESSIZE、PARAMSNUM,修改字段TMP_TYPE
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM COLS WHERE TABLE_NAME = 'LF_TEMPLATE' AND COLUMN_NAME = 'DEGREE';
    IF NUM = 0 THEN
        EXECUTE IMMEDIATE 'ALTER TABLE LF_TEMPLATE ADD DEGREE NUMBER(11) DEFAULT 0 NOT NULL';
    END IF;
END;
/
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM COLS WHERE TABLE_NAME = 'LF_TEMPLATE' AND COLUMN_NAME = 'DEGREE_SIZE';
    IF NUM = 0 THEN
        EXECUTE IMMEDIATE 'ALTER TABLE LF_TEMPLATE ADD DEGREE_SIZE NUMBER(18) DEFAULT 0 NOT NULL';
    END IF;
END;
/
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM COLS WHERE TABLE_NAME = 'LF_TEMPLATE' AND COLUMN_NAME = 'INDUSTRYID';
    IF NUM = 0 THEN
        EXECUTE IMMEDIATE 'ALTER TABLE LF_TEMPLATE ADD INDUSTRYID NUMBER(11) DEFAULT -1 NOT NULL';
    END IF;
END;
/
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM COLS WHERE TABLE_NAME = 'LF_TEMPLATE' AND COLUMN_NAME ='USEID';
    IF NUM = 0 THEN
        EXECUTE IMMEDIATE 'ALTER TABLE LF_TEMPLATE ADD USEID NUMBER(11) DEFAULT -2 NOT NULL';
    END IF;
END;
/
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM COLS WHERE TABLE_NAME = 'LF_TEMPLATE' AND COLUMN_NAME ='USECOUNT';
    IF NUM = 0 THEN
        EXECUTE IMMEDIATE 'ALTER TABLE LF_TEMPLATE ADD USECOUNT NUMBER(11) DEFAULT 0 NOT NULL';
    END IF;
END;
/
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM COLS WHERE TABLE_NAME = 'LF_TEMPLATE' AND COLUMN_NAME ='ISSHORTTEMP';
    IF NUM = 0 THEN
        EXECUTE IMMEDIATE 'ALTER TABLE LF_TEMPLATE ADD ISSHORTTEMP NUMBER(11) DEFAULT 0 NOT NULL';
    END IF;
END;
/
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM COLS WHERE TABLE_NAME = 'LF_TEMPLATE' AND COLUMN_NAME ='ISPUBLIC';
    IF NUM = 0 THEN
        EXECUTE IMMEDIATE 'ALTER TABLE LF_TEMPLATE ADD ISPUBLIC NUMBER(5) DEFAULT 0 NOT NULL';
    END IF;
END;
/
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM COLS WHERE TABLE_NAME = 'LF_TEMPLATE' AND COLUMN_NAME ='EXLJSON';
    IF NUM = 0 THEN
        EXECUTE IMMEDIATE 'ALTER TABLE LF_TEMPLATE ADD EXLJSON VARCHAR2(4000) DEFAULT ''{}'' NOT NULL';
    END IF;
END;
/
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM COLS WHERE TABLE_NAME = 'LF_TEMPLATE' AND COLUMN_NAME ='VER';
    IF NUM = 0 THEN
        EXECUTE IMMEDIATE 'ALTER TABLE LF_TEMPLATE ADD VER VARCHAR2(10) DEFAULT ''1.0'' NOT NULL';
    END IF;
END;
/
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM COLS WHERE TABLE_NAME = 'LF_TEMPLATE' AND COLUMN_NAME ='CHGRADE';
    IF NUM = 0 THEN
        EXECUTE IMMEDIATE 'ALTER TABLE LF_TEMPLATE ADD CHGRADE NUMBER(5) DEFAULT 0 NOT NULL';
    END IF;
END;
/
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM COLS WHERE TABLE_NAME = 'LF_TEMPLATE' AND COLUMN_NAME ='RMSRESSIZE';
    IF NUM = 0 THEN
        EXECUTE IMMEDIATE 'ALTER TABLE LF_TEMPLATE ADD RMSRESSIZE NUMBER(11) DEFAULT 0 NOT NULL';
    END IF;
END;
/
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM COLS WHERE TABLE_NAME = 'LF_TEMPLATE' AND COLUMN_NAME ='H5RESSIZE';
    IF NUM = 0 THEN
        EXECUTE IMMEDIATE 'ALTER TABLE LF_TEMPLATE ADD H5RESSIZE NUMBER(11) DEFAULT 0 NOT NULL';
    END IF;
END;
/
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM COLS WHERE TABLE_NAME = 'LF_TEMPLATE' AND COLUMN_NAME ='PARAMSNUM';
    IF NUM = 0 THEN
        EXECUTE IMMEDIATE 'ALTER TABLE LF_TEMPLATE ADD PARAMSNUM NUMBER(11) DEFAULT 0 NOT NULL';
    END IF;
END;
/
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM COLS WHERE TABLE_NAME = 'LF_TEMPLATE' AND COLUMN_NAME ='TMP_TYPE';
    IF NUM = 1 THEN
        EXECUTE IMMEDIATE 'ALTER TABLE LF_TEMPLATE MODIFY TMP_TYPE NUMBER(3)';
    END IF;
END;
/

-- 新增行业、用途 管理表
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM USER_TABLES WHERE TABLE_NAME = 'LF_INDUSTRY_USE';
    IF NUM = 0 THEN
       EXECUTE IMMEDIATE 'CREATE TABLE LF_INDUSTRY_USE(
       ID NUMBER(11) PRIMARY KEY NOT NULL,--主键
       NAME VARCHAR2(100) DEFAULT('''') NOT NULL,
       OPERATOR NUMBER(18) DEFAULT(0) NOT NULL,
       TYPE NUMBER(5) DEFAULT(0) NOT NULL,
       CREATETM TIMESTAMP(8) DEFAULT SYSDATE NOT NULL,
       UPDATETM TIMESTAMP(8) DEFAULT SYSDATE NOT NULL
      )';
    END IF;
END;
/
-- 新增LF_SHORTTEMP(快捷场景)表
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM USER_TABLES WHERE TABLE_NAME = 'LF_SHORTTEMP';
    IF NUM = 0 THEN
       EXECUTE IMMEDIATE 'CREATE TABLE LF_SHORTTEMP(
       ID NUMBER(18) PRIMARY KEY NOT NULL,--主键
       USERID NUMBER(18) DEFAULT(0) NOT NULL,
       CORPCODE VARCHAR2(32) DEFAULT '' '' NOT NULL,
       TEMPID NUMBER(18) DEFAULT(0) NOT NULL,
       TEMPNAME VARCHAR2(32) DEFAULT '' '' NOT NULL,
       ADDTIME TIMESTAMP(8) DEFAULT SYSDATE NOT NULL
      )';
    END IF;
END;
/
-- 将富信模板类型(TMP_TYPE)由5改为11 --
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM LF_TEMPLATE WHERE TMP_TYPE = 5;
    IF NUM > 0 THEN
       UPDATE LF_TEMPLATE SET TMP_TYPE = 11 WHERE TMP_TYPE = 5;
    END IF;
END;
/

--LF_UDGROUP表删除外键(UDG_ID字段)--
DECLARE
COLNAME VARCHAR2(200);
CURSOR CURIDX IS
SELECT CONSTRAINT_NAME FROM USER_CONSTRAINTS C WHERE C.CONSTRAINT_TYPE = 'R' AND C.TABLE_NAME = 'LF_UDGROUP';
  C_ROW  CURIDX%ROWTYPE;
BEGIN
      --遍历出所有的外键名字
     FOR C_ROW IN CURIDX LOOP
       IF C_ROW.CONSTRAINT_NAME IS NOT NULL THEN
          SELECT COLUMN_NAME INTO COLNAME FROM USER_CONS_COLUMNS CL WHERE CL.CONSTRAINT_NAME = C_ROW.CONSTRAINT_NAME;
          --如果该外键约束的字段是UDG_ID则删除
          IF COLNAME = 'UDG_ID' THEN
            EXECUTE IMMEDIATE 'ALTER TABLE LF_UDGROUP DROP CONSTRAINT '||C_ROW.CONSTRAINT_NAME;
          END IF;
       END IF;
     END LOOP;
END;
/

--修改菜单路径--
UPDATE LF_PRIVILEGE SET MENUSITE = '/app_appsmsTaskRecord.htm' WHERE PRIVILEGE_ID = 2608 AND MENUSITE = '/app_smsTaskRecord.htm';

--增加LF_BUSMANAGER表的BUS_NAME字段的长度，由32增加为64
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM COLS WHERE TABLE_NAME = 'LF_BUSMANAGER' AND COLUMN_NAME ='BUS_NAME';
    IF NUM = 0 THEN
        EXECUTE IMMEDIATE 'ALTER TABLE LF_BUSMANAGER MODIFY(BUS_NAME VARCHAR2(64))';
    END IF;
END;
/


UPDATE LF_PRIVILEGE SET RESOURCE_ID = 95 WHERE RESOURCE_ID = 100 AND MODNAME = '数据查询';
UPDATE LF_PRIVILEGE SET RESOURCE_ID = 94 WHERE RESOURCE_ID = 95 AND MODNAME = '富信应用';

DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM LF_IMPOWER WHERE PRIVILEGE_ID = 3100;
    IF NUM = 0 THEN
      INSERT INTO LF_IMPOWER VALUES(1,3100);
      INSERT INTO LF_IMPOWER VALUES(2,3100);
      INSERT INTO LF_IMPOWER VALUES(4,3100);
    END IF;
END;
/
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM LF_IMPOWER WHERE PRIVILEGE_ID = 3102;
    IF NUM = 0 THEN
      INSERT INTO LF_IMPOWER VALUES(1,3102);
      INSERT INTO LF_IMPOWER VALUES(2,3102);
      INSERT INTO LF_IMPOWER VALUES(4,3102);
    END IF;
END;
/

UPDATE LF_PRIVILEGE SET PRIV_CODE = '5100-1600-0',MENUCODE='5100-1600' WHERE PRIVILEGE_ID = '3104';
DECLARE NUM NUMBER;
BEGIN
  SELECT COUNT(1) INTO NUM FROM LF_PRIVILEGE WHERE PRIVILEGE_ID = 3108;
  IF NUM = 0 THEN
      INSERT INTO LF_PRIVILEGE (PRIVILEGE_ID, RESOURCE_ID, OPERATE_ID, COMMENTS, PRIV_CODE, MENUNAME, MODNAME, MENUCODE, MENUSITE, ZH_TW_COMMENTS, ZH_HK_COMMENTS, ZH_TW_MENUNAME, ZH_HK_MENUNAME, ZH_TW_MODNAME, ZH_HK_MODNAME)
      VALUES (3108, 100, 1, '查看', '5100-1500-0', '群发历史查询', '数据查询', '5100-1500', '/rms_rmsTaskHistory.htm', '查看', 'View', '群lv史查', 'Task history view', '查', 'Data query');
      INSERT INTO LF_IMPOWER(ROLE_ID, PRIVILEGE_ID) VALUES (1, 3108);
      INSERT INTO LF_IMPOWER(ROLE_ID, PRIVILEGE_ID) VALUES (2, 3108);
      INSERT INTO LF_IMPOWER(ROLE_ID, PRIVILEGE_ID) VALUES (4, 3108);
  END IF;
END;
/

UPDATE LF_THIR_MENUCONTROL SET ZH_HK_TITLE = 'Rich Media' WHERE ZH_HK_TITLE = 'Multimedia';
UPDATE lf_privilege SET ZH_HK_MODNAME = 'Rich Media' WHERE ZH_HK_MODNAME = 'Multimedia';
UPDATE lf_privilege SET ZH_HK_MENUNAME = 'My scene' WHERE MENUNAME = '我的场景';
UPDATE lf_privilege SET ZH_HK_MENUNAME = 'Rich media send' WHERE ZH_HK_MENUNAME = 'fuxin send';
UPDATE lf_privilege SET ZH_HK_MENUNAME = 'Send detail' WHERE ZH_HK_MENUNAME = 'Send Detail';
UPDATE lf_privilege SET ZH_HK_MENUNAME = 'Degree report' WHERE ZH_HK_MENUNAME = 'Degree Report';
UPDATE lf_privilege SET ZH_HK_MENUNAME = 'Degree manager' WHERE ZH_HK_MENUNAME = 'Degree Manager';
UPDATE lf_privilege SET ZH_HK_MENUNAME = 'Common scene' WHERE MENUNAME = '公共场景';

-- 数据查询相关菜单 --
UPDATE LF_PRIVILEGE SET RESOURCE_ID = 95,MODNAME='数据查询' WHERE PRIVILEGE_ID IN(3104,3107,3108,3101);
COMMIT;

---LF_SHORTTEMP增加序列与触发器实现主键自增
CALL ADDSEQUENCEBYNAME('S_LF_SHORTTEMP');

CREATE OR REPLACE TRIGGER LF_SHORTTEMP_Q
BEFORE INSERT ON LF_SHORTTEMP
FOR EACH ROW
  BEGIN
    IF(:NEW.ID IS NULL)
    THEN
      SELECT S_LF_SHORTTEMP.NEXTVAL INTO :NEW.ID FROM DUAL;
      END IF;
      END;
/

--LF_CORP增加字段 RPTFLAG  0:表示不需要;1:需要通知状态报告;2:需要下载状态报告;3:通知、下载状态报告都要;(默认通知状态报告必须)
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM COLS WHERE TABLE_NAME = 'LF_CORP' AND COLUMN_NAME ='RPTFLAG';
    IF NUM = 0 THEN
        EXECUTE IMMEDIATE 'ALTER TABLE LF_CORP ADD RPTFLAG NUMBER(5) DEFAULT 1 NOT NULL';
    END IF;
END;
/

---LF_INDUSTRY_USE增加序列实现主键自增
CALL ADDSEQUENCEBYNAME('LF_INDUSTRY_USE_S');

-- 移植托管版7.2的新编辑功能 Start --
-- Cheng 2018-9-1 13:08:13 --
-- 1.新增LF_SUB_TEMPLATE(子模板表)
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM USER_TABLES WHERE TABLE_NAME = 'LF_SUB_TEMPLATE';
    IF NUM = 0 THEN
       EXECUTE IMMEDIATE 'CREATE TABLE LF_SUB_TEMPLATE(
       	ID NUMBER(18) PRIMARY KEY NOT NULL,
        TMP_TYPE NUMBER(11) DEFAULT 1 NOT NULL,
        FRONTJSON VARCHAR2(4000) DEFAULT ''{}'' NOT NULL,
        INDUSTRY_ID NUMBER(11) DEFAULT 0 NOT NULL,
        USE_ID NUMBER(11) DEFAULT 0 NOT NULL,
        STATUS NUMBER(11) DEFAULT 0 NOT NULL,
        ADD_TIME TIMESTAMP(8) DEFAULT SYSDATE NOT NULL,
        ENDJSON VARCHAR2(4000) DEFAULT ''{}'' NOT NULL,
        PRIORITY NUMBER(15) DEFAULT 0 NOT NULL,
        FILEURL VARCHAR2(255) DEFAULT '' '' NOT NULL,
        CONTENT VARCHAR2(4000) DEFAULT '' '' NOT NULL,
        CARD_HTML NVARCHAR2(2000) DEFAULT '' '' NOT NULL,
        TM_ID NUMBER(11) DEFAULT 0 NOT NULL,
        DEGREE NUMBER(11) DEFAULT 0 NOT NULL,
        DEGREE_SIZE NUMBER(11) DEFAULT 0 NOT NULL
      )';
    END IF;
END;
/

-- 2.新增LF_HFIVE(H5表)
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM USER_TABLES WHERE TABLE_NAME = 'LF_HFIVE';
    IF NUM = 0 THEN
       EXECUTE IMMEDIATE 'CREATE TABLE LF_HFIVE(
          HID NUMBER(11) PRIMARY KEY NOT NULL,
          TITLE VARCHAR2(50) DEFAULT '' '' NOT NULL,
          AUTHOR VARCHAR2(50) DEFAULT '' '' NOT NULL,
          CREATETIME TIMESTAMP(8) DEFAULT SYSDATE NOT NULL,
          COMMITTIME TIMESTAMP(8) DEFAULT SYSDATE NOT NULL,
          URL VARCHAR2(256) DEFAULT '' '' NOT NULL,
          UPDATETIME TIMESTAMP(8) DEFAULT SYSDATE NOT NULL,
          USETIME TIMESTAMP(8) DEFAULT SYSDATE NOT NULL,
          STAUS NUMBER(3) DEFAULT 0 NOT NULL
      )';
    END IF;
END;
/
-- 3.新增LF_TEMP_PARAM(模板参数表)
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM USER_TABLES WHERE TABLE_NAME = 'LF_TEMP_PARAM';
    IF NUM = 0 THEN
       EXECUTE IMMEDIATE 'CREATE TABLE LF_TEMP_PARAM(
          ID NUMBER(18) PRIMARY KEY,
          TM_ID NUMBER(18) DEFAULT 0 NOT NULL,
          NAME VARCHAR2(255) DEFAULT '' '' NOT NULL,
          MAX_LENGTH NUMBER(11) DEFAULT 0 NOT NULL,
          MIN_LENGTH NUMBER(11) DEFAULT 0 NOT NULL,
          TYPE NUMBER(3) DEFAULT 1 NOT NULL,
          LENGTH_RESTRICT NUMBER(3) DEFAULT 0 NOT NULL,
          FIX_LENGTH NUMBER(11) DEFAULT 0 NOT NULL,
          HASLENGTH NUMBER(11) DEFAULT 0 NOT NULL,
          REGCONTENT VARCHAR2(50) DEFAULT '' '' NOT NULL
      )';
    END IF;
END;
/
-- 4.LF_INDUSTRY_USE表增加字段TMPTYPE
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM COLS WHERE TABLE_NAME = 'LF_INDUSTRY_USE' AND COLUMN_NAME ='TMPTYPE';
    IF NUM = 0 THEN
        EXECUTE IMMEDIATE 'ALTER TABLE LF_INDUSTRY_USE ADD TMPTYPE NUMBER(11) DEFAULT 0 NOT NULL';
    END IF;
END;
/
-- 5.增加菜单H5页面库 位于富信应用下
DECLARE NUM NUMBER;
BEGIN
  SELECT COUNT(1) INTO NUM FROM LF_PRIVILEGE WHERE PRIVILEGE_ID = 3552;
  IF NUM = 0 THEN
      INSERT INTO LF_PRIVILEGE (PRIVILEGE_ID, RESOURCE_ID, OPERATE_ID, COMMENTS, PRIV_CODE, MENUNAME, MODNAME, MENUCODE, MENUSITE, ZH_TW_COMMENTS, ZH_HK_COMMENTS, ZH_TW_MENUNAME, ZH_HK_MENUNAME, ZH_TW_MODNAME, ZH_HK_MODNAME)
      VALUES (3552, 94, 1, '查看', '5100-1360-0', 'H5页面库', '富信应用', '5100-1360', '/toSiteIndex.meditorPage', '查看', 'View', 'H5面', 'H5 page', '富信用', 'Rich Media');
--       INSERT INTO LF_IMPOWER(ROLE_ID, PRIVILEGE_ID) VALUES (1, 3552);
--       INSERT INTO LF_IMPOWER(ROLE_ID, PRIVILEGE_ID) VALUES (2, 3552);
--       INSERT INTO LF_IMPOWER(ROLE_ID, PRIVILEGE_ID) VALUES (4, 3552);
  END IF;
END;
/
-- 5.修改菜单映射
-- 我的场景
UPDATE LF_PRIVILEGE SET MENUSITE = '/toMyTplndex.meditorPage' WHERE PRIVILEGE_ID = 634;
-- 公共场景
UPDATE LF_PRIVILEGE SET MENUSITE = '/toPublicTpIndex.meditorPage' WHERE PRIVILEGE_ID = 3550;
-- 6.LF_MTTASK表增加字段TEMP_TYPE
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM COLS WHERE TABLE_NAME = 'LF_MTTASK' AND COLUMN_NAME ='TEMP_TYPE';
    IF NUM = 0 THEN
        EXECUTE IMMEDIATE 'ALTER TABLE LF_MTTASK ADD TEMP_TYPE NUMBER(11) DEFAULT 0 NOT NULL';
    END IF;
END;
/
-- 7.增加序列实现主键自增
CALL ADDSEQUENCEBYNAME('LF_SUB_TEMPLATE_S');
CALL ADDSEQUENCEBYNAME('LF_HFIVE_S');
CALL ADDSEQUENCEBYNAME('LF_TEMP_PARAM_S');
CALL ADDSEQUENCEBYNAME('S_LF_DEGREE');

--增加触发器
CREATE OR REPLACE TRIGGER LF_SUB_TEMPLATE_Q
BEFORE INSERT ON LF_SUB_TEMPLATE
FOR EACH ROW
  BEGIN
    IF(:NEW.ID IS NULL)
    THEN
      SELECT LF_SUB_TEMPLATE_S.NEXTVAL INTO :NEW.ID FROM DUAL;
      END IF;
      END;
/

CREATE OR REPLACE TRIGGER LF_TEMP_PARAM_Q
BEFORE INSERT ON LF_TEMP_PARAM
FOR EACH ROW
  BEGIN
    IF(:NEW.ID IS NULL)
    THEN
      SELECT LF_TEMP_PARAM_S.NEXTVAL INTO :NEW.ID FROM DUAL;
      END IF;
      END;
/

-- 8.增加模板内容表
DECLARE NUM NUMBER;
BEGIN
    SELECT COUNT(1) INTO NUM FROM USER_TABLES WHERE TABLE_NAME = 'LF_TEMPCONTENT';
    IF NUM = 0 THEN
       EXECUTE IMMEDIATE 'CREATE TABLE LF_TEMPCONTENT(
          ID NUMBER(18) PRIMARY KEY,
          TMID NUMBER(18) DEFAULT 0 NOT NULL,
          CONTTYPE NUMBER(11) DEFAULT 0 NOT NULL,
          TMPTYPE NUMBER(11) DEFAULT 0 NOT NULL,
          TMPCONTENT VARCHAR2(3000) DEFAULT '' '' NOT NULL
      )';
    END IF;
END;
/
-- 序列与触发器
CALL ADDSEQUENCEBYNAME('S_LF_TEMPCONTENT');

CREATE OR REPLACE TRIGGER LF_TEMPCONTENT_Q
BEFORE INSERT ON LF_TEMPCONTENT
FOR EACH ROW
  BEGIN
    IF(:NEW.ID IS NULL)
    THEN
      SELECT S_LF_TEMPCONTENT.NEXTVAL INTO :NEW.ID FROM DUAL;
      END IF;
      END;
/
-- 移植托管版7.2的新编辑功能 End --

--修改公共场景为模板库
UPDATE LF_PRIVILEGE SET MENUNAME = '模板库',ZH_TW_MENUNAME = '模板' WHERE PRIVILEGE_ID IN (3550,3551);
COMMIT;

/*EMP升级脚本    END*/

--增加版本信息--
DECLARE COUNTNUM INT;
        VERSIONSTR VARCHAR2(32);
        DBVERSIONSTR VARCHAR2(32);
        WBSVERSIONSTR VARCHAR2(32);
        SPGATEVERSIONSTR VARCHAR2(32);
        NUMNO INT;
        TOTALINT INT;
BEGIN
    VERSIONSTR:='7.1.0.421';
    DBVERSIONSTR:='71.00';
    WBSVERSIONSTR:='8.5.13.211';
    SPGATEVERSIONSTR:='6.1.46.338';
  NUMNO:=1;
  TOTALINT:=1;
  --EMP产品版本记录
  SELECT COUNT(*) INTO COUNTNUM FROM LF_VERSION WHERE PRODUCT_ID=1000 AND PROCESS_ID=1000;
  IF COUNTNUM=0 THEN
   --EMP-WEB
   INSERT INTO LF_VERSION(PRODUCT_ID,PROCESS_ID,VERSION,UPDATETIME,CREATETIME,MEMO)
   VALUES(1000,1000,VERSIONSTR,SYSDATE,SYSDATE,'EMP-WEB');
  ELSE
    UPDATE LF_VERSION SET UPDATETIME=SYSDATE,VERSION=VERSIONSTR WHERE PRODUCT_ID=1000 AND PROCESS_ID=1000;
  END IF;
  COMMIT;
  SELECT COUNT(*) INTO COUNTNUM FROM LF_VERSION WHERE PRODUCT_ID=1000 AND PROCESS_ID=2000;
  IF COUNTNUM=0 THEN
   --EMP_GATEWARY
   INSERT INTO LF_VERSION(PRODUCT_ID,PROCESS_ID,VERSION,UPDATETIME,CREATETIME,MEMO)
   VALUES(1000,2000,WBSVERSIONSTR,SYSDATE,SYSDATE,'EMP_GATEWARY');
  ELSE
    UPDATE LF_VERSION SET UPDATETIME=SYSDATE,VERSION=WBSVERSIONSTR WHERE PRODUCT_ID=1000 AND PROCESS_ID=2000;
  END IF;
  COMMIT;
  SELECT COUNT(*) INTO COUNTNUM FROM LF_VERSION WHERE PRODUCT_ID=1000 AND PROCESS_ID=3000;
  IF COUNTNUM=0 THEN
   --SMT_SPGATE
   INSERT INTO LF_VERSION(PRODUCT_ID,PROCESS_ID,VERSION,UPDATETIME,CREATETIME,MEMO)
   VALUES(1000,3000,SPGATEVERSIONSTR,SYSDATE,SYSDATE,'SMT_SPGATE');
  ELSE
    UPDATE LF_VERSION SET UPDATETIME=SYSDATE,VERSION=SPGATEVERSIONSTR WHERE PRODUCT_ID=1000 AND PROCESS_ID=3000;
  END IF;
  COMMIT;

  --EMP产品版本历史记录
  SELECT COUNT(*) INTO COUNTNUM FROM LF_VERSION_HIS WHERE VERSION=VERSIONSTR AND PRODUCT_ID=1000 AND PROCESS_ID=1000;
  IF COUNTNUM=0 THEN
    --EMP-WEB
    INSERT INTO LF_VERSION_HIS(PRODUCT_ID,PROCESS_ID,VERSION,UPDATETIME,CREATETIME,MEMO,ISRELEASE,VERSIONINFO)
    VALUES(1000,1000,VERSIONSTR,SYSDATE,SYSDATE,'EMP-WEB',1,'1.新增企业流量');
  ELSE
    UPDATE LF_VERSION_HIS SET UPDATETIME=SYSDATE,ISRELEASE=1,VERSIONINFO='1.新增企业流量' WHERE VERSION=VERSIONSTR AND PRODUCT_ID=1000 AND PROCESS_ID=1000;
  END IF;
  COMMIT;

  SELECT COUNT(*) INTO COUNTNUM FROM LF_VERSION_HIS WHERE VERSION=WBSVERSIONSTR AND PRODUCT_ID=1000 AND PROCESS_ID=2000;
  IF COUNTNUM=0 THEN
    --EMP_GATEWARY
    INSERT INTO LF_VERSION_HIS(PRODUCT_ID,PROCESS_ID,VERSION,UPDATETIME,CREATETIME,MEMO)
    VALUES(1000,2000,WBSVERSIONSTR,SYSDATE,SYSDATE,'EMP_GATEWARY');
  ELSE
    UPDATE LF_VERSION_HIS SET UPDATETIME=SYSDATE WHERE VERSION=WBSVERSIONSTR AND PRODUCT_ID=1000 AND PROCESS_ID=2000;
  END IF;
  COMMIT;

  SELECT COUNT(*) INTO COUNTNUM FROM LF_VERSION_HIS WHERE VERSION=SPGATEVERSIONSTR AND PRODUCT_ID=1000 AND PROCESS_ID=3000;
  IF COUNTNUM=0 THEN
    --SMT_SPGATE
    INSERT INTO LF_VERSION_HIS(PRODUCT_ID,PROCESS_ID,VERSION,UPDATETIME,CREATETIME,MEMO)
    VALUES(1000,3000,SPGATEVERSIONSTR,SYSDATE,SYSDATE,'SMT_SPGATE');
  ELSE
    UPDATE LF_VERSION_HIS SET UPDATETIME=SYSDATE WHERE VERSION=SPGATEVERSIONSTR AND PRODUCT_ID=1000 AND PROCESS_ID=3000;
  END IF;
  COMMIT;

  SELECT COUNT(*) INTO COUNTNUM FROM LF_DB_SCRIPT WHERE VERSION=DBVERSIONSTR;
  IF COUNTNUM=0 THEN
    --EMP产品数据库版本信息表 
    INSERT INTO LF_DB_SCRIPT(VERSION,UPDATETIME,CREATETIME,CURRENT_NO,TOTAL,STATE,MEMO)
    VALUES(DBVERSIONSTR,SYSDATE,SYSDATE,NUMNO,TOTALINT,2,'网关包更改');
  ELSE
    UPDATE LF_DB_SCRIPT SET STATE=2,UPDATETIME=SYSDATE WHERE  VERSION=DBVERSIONSTR AND CURRENT_NO=NUMNO AND TOTAL=TOTALINT;
  END IF;
  COMMIT;
END;
/
--重新编译所有存储过程和触发器
CALL COMPILE_PROCEDURE();
/
-----------V7.00-V7.01 END------------------------